@inject DialogService DialogService
@inject IJSRuntime JsRuntime
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IAppThemeService ThemeService
@inject IStringLocalizer<App> L
@using System.Globalization
@using Microsoft.Extensions.Localization
@using WhereAreThey.Helpers
@using WhereAreThey.Services
@implements IDisposable

<RadzenStack Gap="1.5rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">@L["SETTINGS"]</RadzenText>

    <RadzenStack Gap="0.5rem">
        <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: bold;">@L["Language"]</RadzenText>
        <RadzenDropDown TValue="string" Data="@_supportedCultures" 
                        Value="@_currentCulture" Change="@OnCultureChange"
                        TextProperty="DisplayName" ValueProperty="Name" />
    </RadzenStack>

    <RadzenStack Gap="0.5rem">
        <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: bold;">@L["Theme"]</RadzenText>
        <RadzenSelectBar @bind-Value="@CurrentTheme" TValue="AppTheme" Change="@OnThemeChanged" Size="ButtonSize.Small" Variant="Variant.Flat" Style="width: 100%;">
            <Items>
                <RadzenSelectBarItem Icon="light_mode" Text="@L["Theme_Light"]" Value="AppTheme.Light" />
                <RadzenSelectBarItem Icon="dark_mode" Text="@L["Theme_Dark"]" Value="AppTheme.Dark" />
                <RadzenSelectBarItem Icon="settings_brightness" Text="@L["Theme_System"]" Value="AppTheme.System" />
            </Items>
        </RadzenSelectBar>
    </RadzenStack>
    
    @if (!_isPwa)
    {
        <RadzenStack Gap="0.5rem" Visible="@(_isInstallable || _isIos)">
            <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: bold;">@L["INSTALL_APP"]</RadzenText>
            @if (_isInstallable)
            {
                <RadzenText TextStyle="TextStyle.Caption">@L["PWA_Install_Help"]</RadzenText>
                <RadzenButton Text="@L["INSTALL_APP"]" Icon="get_app" Click="@InstallApp" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Style="width: 100%;" />
            }
            else if (_isIos)
            {
                <RadzenText TextStyle="TextStyle.Caption">@L["PWA_IOS_Install_Help"]</RadzenText>
            }
        </RadzenStack>
    }

    <RadzenStack Gap="0.5rem">
        <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: bold;">@L["Anonymous_Profile_ID"]</RadzenText>
        <RadzenText TextStyle="TextStyle.Caption">
            @L["Profile_ID_Help"]
        </RadzenText>
        
        @if (string.IsNullOrEmpty(_userIdentifier))
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" Variant="Variant.Flat" Shade="Shade.Lighter">
                @L["New_Profile_Prompt"]
            </RadzenAlert>

            <RadzenStack Gap="1rem" Class="rz-p-4 rz-background-color-base-100 rz-border-radius-2">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Overline">@L["Option_1_Generated"]</RadzenText>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenTextBox Value="@_generatedPassphrase" ReadOnly="true" Style="flex: 1; font-family: monospace; font-size: 1rem; text-align: center; border-style: dashed;" />
                        <RadzenButton Icon="content_copy" Click="@(() => CopyToClipboard(_generatedPassphrase))" ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat" Size="ButtonSize.Small" ToolTip="@L["Copy_to_Clipboard"]" />
                        <RadzenButton Icon="refresh" Click="@RegeneratePassphrase" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Small" ToolTip="@L["REFRESH"]" />
                    </RadzenStack>
                    <RadzenButton Text="@L["Use_Generated_Passphrase"]" Click="@(() => UsePassphrase(_generatedPassphrase, true))" 
                                  ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Style="width: 100%;" 
                                  IsBusy="@_isBusy" />
                </RadzenStack>

                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Overline">@L["Option_2_Existing"]</RadzenText>
                    <RadzenTemplateForm TItem="ImportRequest" Data="@_importRequest" Submit="@((ImportRequest args) => UsePassphrase(args.Passphrase, false))">
                        <RadzenStack Gap="0.5rem">
                            <RadzenFormField Text="@L["Enter_Existing_Passphrase"]" Variant="Variant.Outlined" Component="ImportId" Style="width: 100%;">
                                <ChildContent>
                                    <RadzenTextBox Name="ImportId" @bind-Value="@_importRequest.Passphrase" 
                                                   @oninput="@(args => _importRequest.Passphrase = args.Value?.ToString() ?? "")"
                                                   Placeholder="@L["Passphrase_Placeholder"]" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <RadzenRequiredValidator Component="ImportId" Text="@L["Passphrase_Required"]" />
                                    <RadzenLengthValidator Component="ImportId" Min="8" Max="100" Text="@L["Passphrase_Length_Error"]" />
                                </Helper>
                            </RadzenFormField>
                            <RadzenButton ButtonType="ButtonType.Submit" Text="@L["IMPORT"]" 
                                          ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Style="width: 100%;" 
                                          IsBusy="@_isBusy" />
                        </RadzenStack>
                    </RadzenTemplateForm>
                </RadzenStack>
            </RadzenStack>
        }
        else
        {
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenTextBox Value="@_userIdentifier" ReadOnly="true" Style="flex: 1; font-family: monospace; font-size: 0.8rem;" />
                <RadzenButton Icon="content_copy" Click="@(() => CopyToClipboard(_userIdentifier))" ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat" Size="ButtonSize.Small" ToolTip="@L["Copy_to_Clipboard"]" />
                <RadzenButton Text="@L["IMPORT"]" Click="@(() => _showImport = !_showImport)" ButtonStyle="ButtonStyle.Base" Variant="Variant.Flat" Size="ButtonSize.Small" />
            </RadzenStack>

            @if (_showImport)
            {
                <RadzenTemplateForm TItem="ImportRequest" Data="@_importRequest" Submit="@((ImportRequest args) => ImportProfile())">
                    <RadzenStack Gap="0.5rem" Class="rz-p-2 rz-background-color-base-100 rz-border-radius-2">
                        <RadzenFormField Text="@L["Paste_New_ID"]" Variant="Variant.Outlined" Component="ImportId" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="ImportId" @bind-Value="@_importRequest.Passphrase" 
                                               @oninput="@(args => _importRequest.Passphrase = args.Value?.ToString() ?? "")"
                                               Placeholder="@L["Passphrase_Placeholder"]" Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="ImportId" Text="@L["Passphrase_Required"]" />
                                <RadzenLengthValidator Component="ImportId" Min="8" Max="100" Text="@L["Passphrase_Length_Error"]" />
                            </Helper>
                        </RadzenFormField>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="@L["CANCEL"]" Click="@(() => { _showImport = false; _importRequest.Passphrase = ""; })" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Style="flex: 1;" />
                            <RadzenButton ButtonType="ButtonType.Submit" Text="@L["SAVE_REFRESH"]" 
                                          ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Style="flex: 1;" 
                                          IsBusy="@_isBusy" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenTemplateForm>
            }
        }
    </RadzenStack>

    @if (!string.IsNullOrEmpty(_userIdentifier))
    {
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-2">
            <RadzenButton Text="@L["CANCEL"]" Click="@(() => DialogService.Close(null))" ButtonStyle="ButtonStyle.Light" />
            <RadzenButton Text="@L["CLOSE"]" Click="@(() => DialogService.Close())" ButtonStyle="ButtonStyle.Primary" />
        </RadzenStack>
    }
</RadzenStack>

@code {
    private class ImportRequest
    {
        public string Passphrase { get; set; } = "";
    }
    private ImportRequest _importRequest = new();
    private string _userIdentifier = "";
    private string _generatedPassphrase = "";
    private bool _showImport;
    private bool _isBusy;
    private readonly string _currentCulture = CultureInfo.CurrentCulture.Name;
    private bool _isInstallable;
    private bool _isPwa;
    private bool _isIos;
    private DotNetObjectReference<SettingsDialog>? _objRef;

    private AppTheme CurrentTheme
    {
        get => ThemeService.CurrentTheme;
        set => ThemeService.SetTheme(value);
    }

    private async Task OnThemeChanged(AppTheme theme)
    {
        await JsRuntime.InvokeVoidAsync("themeManager.setTheme", theme.ToString());
    }

    private readonly List<CultureDisplay> _supportedCultures =
    [
        new() { Name = "en", DisplayName = "English" },
        new() { Name = "es", DisplayName = "Español" },
        new() { Name = "fr", DisplayName = "Français" },
        new() { Name = "de", DisplayName = "Deutsch" },
        new() { Name = "it", DisplayName = "Italiano" },
        new() { Name = "pt", DisplayName = "Português" },
        new() { Name = "ru", DisplayName = "Русский" },
        new() { Name = "zh", DisplayName = "中文" },
        new() { Name = "ja", DisplayName = "日本語" }
    ];

    private void OnCultureChange(object value)
    {
        if (value is string culture)
        {
            var uri = new Uri(NavigationManager.Uri).GetComponents(UriComponents.PathAndQuery, UriFormat.Unescaped);
            var query = $"?culture={Uri.EscapeDataString(culture)}&redirectUri={Uri.EscapeDataString(uri)}";
            NavigationManager.NavigateTo("/Culture/Set" + query, forceLoad: true);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _userIdentifier = await JsRuntime.InvokeAsync<string?>("getUserIdentifier") ?? "";
            
            if (string.IsNullOrEmpty(_userIdentifier))
            {
                _generatedPassphrase = PassphraseGenerator.Generate();
            }

            var stored = await JsRuntime.InvokeAsync<string>("themeManager.getStoredTheme");
            if (Enum.TryParse<AppTheme>(stored, out var theme))
            {
                ThemeService.SetTheme(theme);
            }

            _objRef = DotNetObjectReference.Create(this);
            await JsRuntime.InvokeVoidAsync("pwaFunctions.registerHelper", _objRef);
            await JsRuntime.InvokeVoidAsync("registerSettingsHelper", _objRef);
            
            _isPwa = await JsRuntime.InvokeAsync<bool>("pwaFunctions.isPwa");
            _isIos = await JsRuntime.InvokeAsync<bool>("pwaFunctions.isIOS");
            
            StateHasChanged();
        }
    }

    private void RegeneratePassphrase()
    {
        _generatedPassphrase = PassphraseGenerator.Generate();
    }

    private async Task UsePassphrase(string id, bool isNew = false)
    {
        if (string.IsNullOrWhiteSpace(id) || id.Length < 8) return;
        if (_isBusy) return;

        _isBusy = true;
        try
        {
            await JsRuntime.InvokeAsync<bool>("setUserIdentifier", id);
            if (isNew)
            {
                await JsRuntime.InvokeVoidAsync("localStorage.setItem", "user-identifier-new", "true");
            }
            DialogService.Close(id);
            await JsRuntime.InvokeVoidAsync("location.reload");
        }
        finally
        {
            _isBusy = false;
        }
    }

    [JSInvokable]
    public void SetInstallable(bool installable)
    {
        _isInstallable = installable;
        StateHasChanged();
    }

    private async Task InstallApp()
    {
        await JsRuntime.InvokeAsync<bool>("pwaFunctions.showInstallPrompt");
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }

    private async Task CopyToClipboard(string text)
    {
        await JsRuntime.InvokeVoidAsync("copyToClipboard", text);
    }

    [JSInvokable]
    public void NotifyCopied()
    {
        NotificationService.Notify(NotificationSeverity.Info, L["ID_copied"]);
    }

    private async Task ImportProfile()
    {
        if (string.IsNullOrWhiteSpace(_importRequest.Passphrase) || _importRequest.Passphrase.Length < 8) return;
        if (_isBusy) return;

        _isBusy = true;
        try
        {
            await JsRuntime.InvokeAsync<bool>("setUserIdentifier", _importRequest.Passphrase);
            DialogService.Close();
            // We need a hard refresh to reload everything with the new ID
            await JsRuntime.InvokeVoidAsync("location.reload");
        }
        finally
        {
            _isBusy = false;
        }
    }

    public class CultureDisplay
    {
        public string Name { get; set; } = "";
        public string DisplayName { get; set; } = "";
    }
}
