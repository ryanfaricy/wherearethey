@using Microsoft.Extensions.Localization
@using Microsoft.Extensions.Options
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@using WhereAreThey.Helpers
@inject IDonationService DonationService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IJSRuntime JsRuntime
@inject IHapticFeedbackService HapticFeedbackService
@inject IOptions<SquareOptions> SquareOptions
@inject ILogger<DonateDialog> Logger
@inject IStringLocalizer<App> L

<RadzenStack Gap="1.5rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold; color: var(--rz-success);">@L["SUPPORT_US"]</RadzenText>
    
    <RadzenText TextStyle="TextStyle.Body2">
        @((MarkupString)L["Donate_Intro"].Value)
    </RadzenText>

    <RadzenTabs RenderMode="TabRenderMode.Client">
        <Tabs>
            <RadzenTabsItem Text="@L["DONATE"]">
                <RadzenTemplateForm Data="@_donation" Submit="@((Donation _) => ProcessDonation())">
                    <RadzenStack Gap="1rem">
                        <RadzenFormField Text="@L["Amount"]" Variant="Variant.Outlined" Component="Amount" Style="width: 100%;">
                            <ChildContent>
                                <RadzenNumeric Name="Amount" @bind-Value="@_donation.Amount" TValue="decimal" 
                                               Min="1" Max="10000" ShowUpDown="false" 
                                               Format="$0.00" Style="width: 100%; font-size: 1.25rem; font-weight: bold;" 
                                               Disabled="@_isProcessing" />
                            </ChildContent>
                            <Helper>
                                <RadzenNumericRangeValidator Component="Amount" Min="1" Max="10000" Text="@L["Amount_Range_Error"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenRow Gap="0.5rem">
                            <RadzenColumn Size="3">
                                <RadzenButton Text="$5" Click="@(() => _donation.Amount = 5)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" 
                                              Disabled="@_isProcessing" />
                            </RadzenColumn>
                            <RadzenColumn Size="3">
                                <RadzenButton Text="$10" Click="@(() => _donation.Amount = 10)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" 
                                              Disabled="@_isProcessing" />
                            </RadzenColumn>
                            <RadzenColumn Size="3">
                                <RadzenButton Text="$25" Click="@(() => _donation.Amount = 25)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" 
                                              Disabled="@_isProcessing" />
                            </RadzenColumn>
                            <RadzenColumn Size="3">
                                <RadzenButton Text="$50" Click="@(() => _donation.Amount = 50)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" 
                                              Disabled="@_isProcessing" />
                            </RadzenColumn>
                        </RadzenRow>

                        <div id="card-container" style="min-height: 80px; margin-bottom: 1rem;"></div>

                        <RadzenFormField Text="@L["Email_Optional"]" Variant="Variant.Outlined" Component="DonorEmail" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="DonorEmail" @bind-Value="@_donation.DonorEmail" 
                                               Placeholder="your@email.com" 
                                               Style="width: 100%;" 
                                               Disabled="@_isProcessing" />
                            </ChildContent>
                            <Helper>
                                <RadzenEmailValidator Component="DonorEmail" Text="@L["Invalid_Email"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenButton ButtonType="ButtonType.Submit" 
                                      Text="@(string.Format(L["DONATE_AMOUNT"], _donation.Amount.ToString("F2")))" 
                                      Icon="volunteer_activism" 
                                      ButtonStyle="ButtonStyle.Success" 
                                      Style="width: 100%; font-weight: bold;" 
                                      IsBusy="@_isProcessing" />
                    </RadzenStack>
                </RadzenTemplateForm>
            </RadzenTabsItem>
            <RadzenTabsItem Text="@L["Recent"]">
                @if (_recentDonations.Any())
                {
                    <RadzenDataList Data="@_recentDonations" TItem="DonationDisplay" AllowPaging="true" PageSize="5">
                        <Template Context="d">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Class="rz-mb-2 rz-p-2 rz-border-radius-2" Style="background-color: var(--rz-success-lighter);">
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: bold; margin-bottom: 0;">@(d.DisplayName == "Anonymous" ? L["Anonymous"] : d.DisplayName)</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Style="margin-bottom: 0;">@d.TimeAgo</RadzenText>
                                </RadzenStack>
                                <RadzenBadge Text="@($"${d.Amount:F0}")" BadgeStyle="BadgeStyle.Success" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataList>
                }
                else
                {
                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-p-4 text-center opacity-75">@L["No_recent_donations"]</RadzenText>
                }
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <RadzenButton Text="@L["CLOSE"]" Click="@(() => DialogService.Close())" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>
</RadzenStack>

@code {
    private Donation _donation = new() { Amount = 10 };
    private List<DonationDisplay> _recentDonations = [];
    private bool _isProcessing;

    protected override async Task OnInitializedAsync()
    {
        var donations = await DonationService.GetAllAsync(isAdmin: true);
        _recentDonations = donations
            .Where(d => d.Status == "completed")
            .Take(10)
            .Select(d => new DonationDisplay 
            { 
                DisplayName = string.IsNullOrWhiteSpace(d.DonorName) ? "Anonymous" : d.DonorName,
                Amount = d.Amount,
                TimeAgo = DateTimeUtils.GetTimeAgo(d.CreatedAt),
            }).ToList();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var appId = SquareOptions.Value.ApplicationId;
            var locId = SquareOptions.Value.LocationId;
            
            if (!string.IsNullOrEmpty(appId) && !string.IsNullOrEmpty(locId))
            {
                await JsRuntime.InvokeAsync<bool>("squarePayments.initialize", appId, locId);
            }
        }
    }

    private async Task ProcessDonation()
    {
        if (_isProcessing)
        {
            return;
        }

        _isProcessing = true;
        StateHasChanged();
        try
        {
            // 1. Get token from Square
            string token;
            try
            {
                token = await JsRuntime.InvokeAsync<string>("squarePayments.tokenize");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Payment initialization failed for Square");
                await HapticFeedbackService.VibrateErrorAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Payment initialization failed", ex.Message);
                return;
            }

            // 2. Create payment on backend
            var response = await DonationService.CreateSquarePaymentAsync(_donation.Amount, token);
            
            if (response.Errors != null && response.Errors.Any())
            {
                await HapticFeedbackService.VibrateErrorAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Payment failed", response.Errors[0].Detail);
                return;
            }

            // 3. Record donation
            _donation.Status = "completed";
            _donation.ExternalPaymentId = response.Payment.Id;
            var recordResult = await DonationService.CreateDonationAsync(_donation);

            if (recordResult.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, L["Donation_Success"]);
                await HapticFeedbackService.VibrateSuccessAsync();
                
                var displayName = string.IsNullOrWhiteSpace(_donation.DonorName) ? "Anonymous" : _donation.DonorName;
                _recentDonations.Insert(0, new DonationDisplay 
                { 
                    DisplayName = displayName, 
                    Amount = _donation.Amount, 
                    TimeAgo = "just now",
                });

                _donation = new Donation { Amount = 10 };
                
                // Close the dialog after successful payment
                DialogService.Close(true);
            }
            else
            {
                await HapticFeedbackService.VibrateErrorAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Recording failed", recordResult.Error ?? "Unknown error");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Donation failed for amount {Amount}", _donation.Amount);
            await HapticFeedbackService.VibrateErrorAsync();
            NotificationService.Notify(NotificationSeverity.Error, "Donation failed", ex.Message);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    public class DonationDisplay
    {
        public string DisplayName { get; set; } = "";
        public decimal Amount { get; set; }
        public string TimeAgo { get; set; } = "";
    }
}
