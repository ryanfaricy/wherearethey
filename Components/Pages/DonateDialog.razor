@using WhereAreThey.Models
@using WhereAreThey.Services
@using Microsoft.Extensions.Localization
@inject IDonationService DonationService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@inject ILogger<DonateDialog> Logger
@inject IStringLocalizer<App> L

<RadzenStack Gap="1.5rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold; color: var(--rz-success);">@L["SUPPORT_US"]</RadzenText>
    
    <RadzenText TextStyle="TextStyle.Body2">
        @((MarkupString)L["Donate_Intro"].Value)
    </RadzenText>

    <RadzenTabs RenderMode="TabRenderMode.Client">
        <Tabs>
            <RadzenTabsItem Text="@L["DONATE"]">
                <RadzenTemplateForm Data="@donation" Submit="@((Donation args) => ProcessDonation())">
                    <RadzenStack Gap="1rem">
                        <RadzenFormField Text="@L["Amount"]" Variant="Variant.Outlined">
                            <RadzenNumeric @bind-Value="@donation.Amount" TValue="decimal" 
                                           Min="1" Max="10000" ShowUpDown="false" 
                                           Format="$0.00" Style="width: 100%; font-size: 1.25rem; font-weight: bold;" 
                                           Disabled="@isProcessing" />
                        </RadzenFormField>

                        <div class="row g-2">
                            <div class="col-3">
                                <RadzenButton Text="$5" Click="@(() => donation.Amount = 5)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" 
                                              Disabled="@isProcessing" />
                            </div>
                            <div class="col-3">
                                <RadzenButton Text="$10" Click="@(() => donation.Amount = 10)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" 
                                              Disabled="@isProcessing" />
                            </div>
                            <div class="col-3">
                                <RadzenButton Text="$25" Click="@(() => donation.Amount = 25)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" 
                                              Disabled="@isProcessing" />
                            </div>
                            <div class="col-3">
                                <RadzenButton Text="$50" Click="@(() => donation.Amount = 50)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" 
                                              Disabled="@isProcessing" />
                            </div>
                        </div>

                        <div id="card-container" style="min-height: 80px; margin-bottom: 1rem;"></div>

                        <RadzenFormField Text="@L["Email_Optional"]" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="@donation.DonorEmail" 
                                           Placeholder="your@email.com" 
                                           Style="width: 100%;" 
                                           Disabled="@isProcessing" />
                        </RadzenFormField>

                        <RadzenButton ButtonType="ButtonType.Submit" 
                                      Text="@(string.Format(L["DONATE_AMOUNT"], donation.Amount.ToString("F2")))" 
                                      Icon="volunteer_activism" 
                                      ButtonStyle="ButtonStyle.Success" 
                                      Style="width: 100%; font-weight: bold;" 
                                      IsBusy="@isProcessing" />
                    </RadzenStack>
                </RadzenTemplateForm>
            </RadzenTabsItem>
            <RadzenTabsItem Text="@L["Recent"]">
                @if (recentDonations.Any())
                {
                    <RadzenDataList Data="@recentDonations" TItem="DonationDisplay" PageSize="4">
                        <Template Context="d">
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 rz-border-radius-2" style="background-color: var(--rz-success-lighter);">
                                <div>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: bold; margin-bottom: 0;">@(d.DisplayName == "Anonymous" ? L["Anonymous"] : d.DisplayName)</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Style="margin-bottom: 0;">@d.TimeAgo</RadzenText>
                                </div>
                                <RadzenBadge Text="@($"${d.Amount:F0}")" BadgeStyle="BadgeStyle.Success" />
                            </div>
                        </Template>
                    </RadzenDataList>
                }
                else
                {
                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-p-4 text-center opacity-75">@L["No_recent_donations"]</RadzenText>
                }
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <RadzenButton Text="@L["CLOSE"]" Click="@(() => DialogService.Close())" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>
</RadzenStack>

@code {
    private Donation donation = new Donation { Amount = 10 };
    private List<DonationDisplay> recentDonations = new();
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        var donations = await DonationService.GetAllDonationsAsync();
        recentDonations = donations
            .Where(d => d.Status == "completed")
            .Take(10)
            .Select(d => new DonationDisplay 
            { 
                DisplayName = string.IsNullOrWhiteSpace(d.DonorName) ? "Anonymous" : d.DonorName,
                Amount = d.Amount,
                TimeAgo = TimeAgo(d.CreatedAt)
            }).ToList();
    }

    private string TimeAgo(DateTime dateTime)
    {
        var span = DateTime.UtcNow - dateTime;
        if (span.TotalSeconds < 60) return "just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        return $"{(int)span.TotalDays}d ago";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var appId = Configuration["Square:ApplicationId"];
            var locId = Configuration["Square:LocationId"];
            
            if (!string.IsNullOrEmpty(appId) && !string.IsNullOrEmpty(locId))
            {
                await JSRuntime.InvokeAsync<bool>("squarePayments.initialize", appId, locId);
            }
        }
    }

    private async Task ProcessDonation()
    {
        if (isProcessing) return;

        if (donation.Amount < 1)
        {
            NotificationService.Notify(NotificationSeverity.Warning, L["Minimum_donation"]);
            return;
        }

        isProcessing = true;
        StateHasChanged();
        try
        {
            // 1. Get token from Square
            string token;
            try
            {
                token = await JSRuntime.InvokeAsync<string>("squarePayments.tokenize");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Payment initialization failed for Square");
                NotificationService.Notify(NotificationSeverity.Error, "Payment initialization failed", ex.Message);
                return;
            }

            // 2. Create payment on backend
            var response = await DonationService.CreateSquarePaymentAsync(donation.Amount, token);
            
            if (response.Errors != null && response.Errors.Any())
            {
                NotificationService.Notify(NotificationSeverity.Error, "Payment failed", response.Errors[0].Detail);
                return;
            }

            // 3. Record donation
            donation.Status = "completed";
            donation.ExternalPaymentId = response.Payment.Id;
            await DonationService.RecordDonationAsync(donation);

            NotificationService.Notify(NotificationSeverity.Success, L["Donation_Success"]);
            
            var displayName = string.IsNullOrWhiteSpace(donation.DonorName) ? "Anonymous" : donation.DonorName;
            recentDonations.Insert(0, new DonationDisplay 
            { 
                DisplayName = displayName, 
                Amount = donation.Amount, 
                TimeAgo = "just now" 
            });

            donation = new Donation { Amount = 10 };
            
            // Close the dialog after successful payment
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Donation failed for amount {Amount}", donation.Amount);
            NotificationService.Notify(NotificationSeverity.Error, "Donation failed", ex.Message);
        }
        finally
        {
            isProcessing = false;
        }
    }

    public class DonationDisplay
    {
        public string DisplayName { get; set; } = "";
        public decimal Amount { get; set; }
        public string TimeAgo { get; set; } = "";
    }
}
