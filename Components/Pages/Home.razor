@page "/"
@inject IAlertService AlertService
@inject IReportService ReportService
@inject IGeocodingService GeocodingService
@inject ISettingsService SettingsService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IMapService MapService
@inject IValidationService ValidationService
@inject IClientStorageService StorageService
@inject ILogger<Home> Logger
@inject IStringLocalizer<App> L
@inject IEventService EventService
@inject IHapticFeedbackService HapticFeedbackService
@inject IMapStateService MapState
@inject IMapInteractionService MapInteraction
@inject IClientLocationService ClientLocation
@inject IAdminService AdminService
@inject IMapNavigationManager MapNavigationManager
@using System.Text.Json
@using Microsoft.Extensions.Localization
@using WhereAreThey.Components.Home
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@implements IDisposable

<PageTitle>AreTheyHere - @L["Live Heat Map"]</PageTitle>
<RadzenMediaQuery Query="(max-width: 768px)" Change="@(args => _isMobile = args)" />

<RadzenStack Orientation="Orientation.Vertical" Gap="0" Style="height: 100%; width: 100%; position: absolute; top: 0; left: 0; overflow: hidden;">
    <!-- Toolbar -->
    <HomeToolbar IsMobile="@_isMobile" 
                 DonationsEnabled="@_systemSettings.DonationsEnabled"
                 OnReportClick="@OnReportClick"
                 OnAlertsClick="@OnAlertsClick"
                 OnDonateClick="@OnDonateClick"
                 OnSettingsClick="@(() => OnSettingsClick(false))"
                 OnHelpClick="@OnHelpClick"
                 OnRefreshClick="@(() => MapState.LoadReportsAsync(_selectedHours))" />

    <!-- Map Container -->
    <MapContainer @ref="_mapContainer"
                 ElementId="heatmap"
                 InitialLat="@_initialLat"
                 InitialLng="@_initialLng"
                 IsAdmin="@_isAdmin"
                 AlertCreationMode="@_alertCreationMode"
                 OnMapClick="@OnHeatMapClick"
                 OnMapMoveEnd="@OnHeatMapMoveEnd"
                 OnUserInteractedWithMap="@OnHeatMapUserInteracted"
                 OnLocationUpdated="@OnHeatMapLocationUpdated"
                 OnMapContextMenu="@OnHeatMapContextMenu"
                 OnAlertDeleteClick="@OnHeatMapAlertDeleteClick"
                 OnAlertAreaDefined="@OnHeatMapAlertAreaDefined"
                 OnManualPick="@HandleManualPick">
        
        <!-- Map Controls -->
        <HomeMapControls @bind-SearchAddress="@_searchAddress"
                         @bind-FollowMe="@_followMe"
                         @bind-SelectedHours="@_selectedHours"
                         @bind-AlertCreationMode="@_alertCreationMode"
                         ReportExpiryHours="@_systemSettings.ReportExpiryHours"
                         OnAddressSelected="@OnAddressSelected"
                         OnFollowMeChange="@OnFollowMeChange"
                         OnHoursChange="@(() => MapState.LoadReportsAsync(_selectedHours, GetIncludeExternalId()))" />

        <!-- Map Legend -->
        <HomeLegend />
    </MapContainer>
</RadzenStack>

@code {
    [Parameter] [SupplyParameterFromQuery(Name = "reportId")] public string? ReportIdQuery { get; set; }

    private MapContainer? _mapContainer;
    private bool _isMobile;
    private bool _disposed;
    private SystemSettings _systemSettings = new();
    private string? _userIdentifier;
    private bool _isAdmin;
    private int _locationWatchId = -1;
    private bool _followMe;
    private int _selectedHours = 24;
    private string? _searchAddress;
    private double _initialLat;
    private double _initialLng;
    private bool _alertCreationMode;
    private int? _lastHandledFocusReportId;
    private bool _hasExplicitInitialView;

    private async Task OnHeatMapClick(HeatMap.MapClickEventArgs args)
    {
        var handled = await MapInteraction.HandleMapClickAsync(args.Lat, args.Lng, args.IsMarkerClick, args.ReportId, args.AlertId, _alertCreationMode);
        if (!handled && !args.IsMarkerClick)
        {
            var mapState = await MapService.GetMapStateAsync();
            await ShowAlertsDialog(args.Lat, args.Lng, radiusKm: mapState?.RadiusKm);
        }
    }

    private async Task OnHeatMapMoveEnd(HeatMap.MapLocationEventArgs args) => await OnMapMoveEnd(args.Lat, args.Lng);
    private void OnHeatMapUserInteracted() => OnUserInteractedWithMap();
    private async Task OnHeatMapLocationUpdated(GeolocationPosition position) => await OnLocationUpdated(position);
    private async Task OnHeatMapContextMenu(HeatMap.MapLocationEventArgs args) => await MapInteraction.HandleMapContextMenuAsync(args.Lat, args.Lng, _userIdentifier, alertCreationMode: _alertCreationMode);
    private async Task OnHeatMapAlertDeleteClick(int alertId) => await OnAlertDeleteClick(alertId);

    private async Task OnHeatMapAlertAreaDefined(HeatMap.AlertAreaEventArgs args)
    {
        _alertCreationMode = false;
        await ShowAlertsDialog(args.Lat, args.Lng, radiusKm: args.RadiusKm);
    }

    protected override async Task OnInitializedAsync()
    {
        MapState.ShowDeleted = false;
        MapState.OnStateChanged += HandleStateChanged;
        ClientLocation.OnStateChanged += HandleStateChanged;
        EventService.OnSettingsChanged += HandleSettingsChanged;
        EventService.OnEntityChanged += HandleEntityChanged; // For notifications only
        AdminService.OnAdminLogin += HandleAdminLogin;
        AdminService.OnAdminLogout += HandleAdminLogout;

        _systemSettings = await SettingsService.GetSettingsAsync();
        _selectedHours = _systemSettings.ReportExpiryHours;
    }

    private void HandleAdminLogin()
    {
        _ = InvokeAsync(async () =>
        {
            _isAdmin = await AdminService.IsAdminAsync();
            await MapState.InitializeAsync(_userIdentifier, _isAdmin);
            await MapState.LoadReportsAsync(_selectedHours, GetIncludeExternalId());
            StateHasChanged();
        });
    }

    private void HandleAdminLogout()
    {
        _ = InvokeAsync(async () =>
        {
            _isAdmin = await AdminService.IsAdminAsync();
            await MapState.InitializeAsync(_userIdentifier, _isAdmin);
            await MapState.LoadReportsAsync(_selectedHours, GetIncludeExternalId());
            StateHasChanged();
        });
    }

    private void HandleStateChanged() => InvokeAsync(StateHasChanged);

    private void HandleSettingsChanged(SystemSettings settings)
    {
        InvokeAsync(() => {
            _systemSettings = settings;
            StateHasChanged();
        });
    }

    private void HandleEntityChanged(object entity, EntityChangeType type)
    {
        if (entity is Report report && type == EntityChangeType.Added)
        {
            HandleReportAdded(report);
        }
    }

    private void HandleReportAdded(Report report)
    {
        InvokeAsync(async () =>
        {
            if (_disposed)
            {
                return;
            }

            // Show toast if not from current user and we have our location
            if (report.ReporterIdentifier != _userIdentifier && ClientLocation.LastKnownPosition != null)
            {
                var distance = GeoUtils.CalculateDistance(
                    ClientLocation.LastKnownPosition.Coords.Latitude,
                    ClientLocation.LastKnownPosition.Coords.Longitude,
                    report.Latitude,
                    report.Longitude);

                // If it's nearby, vibrate
                if (distance <= 5) // Within 5km
                {
                    if (report.IsEmergency)
                    {
                        await HapticFeedbackService.VibrateEmergencyAsync();
                    }
                    else
                    {
                        await HapticFeedbackService.VibrateUpdateAsync();
                    }
                }

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = report.IsEmergency ? NotificationSeverity.Error : NotificationSeverity.Info,
                    Summary = L["New_Report"],
                    Detail = $"{string.Format(L["New_Report_Notification"], Math.Round(distance, 1))} ({L["VIEW"]})",
                    Duration = 10000,
                    Click = _ => InvokeAsync(async () => await HandleFocusReportAsync(report.Id)),
                });
            }
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _userIdentifier = await StorageService.GetUserIdentifierAsync();
            
            if (string.IsNullOrEmpty(_userIdentifier))
            {
                await OnSettingsClick(true);
                return;
            }
            
            _isAdmin = await AdminService.IsAdminAsync();
            await MapState.InitializeAsync(_userIdentifier, _isAdmin);
            await MapState.LoadReportsAsync(_selectedHours, GetIncludeExternalId());
            
            var isNew = await StorageService.IsNewUserAsync();
            
            // Check query parameters
            var navState = await MapNavigationManager.GetNavigationStateAsync();
            _hasExplicitInitialView = navState.FocusReportId.HasValue || navState.InitialLat.HasValue || navState.InitialLng.HasValue;

            if (navState.SelectedHours.HasValue)
            {
                _selectedHours = navState.SelectedHours.Value;
                await MapState.LoadReportsAsync(_selectedHours, GetIncludeExternalId());
            }

            var initialLat = navState.InitialLat ?? 0;
            var initialLng = navState.InitialLng ?? 0;
            var initialRadius = navState.InitialRadius;
            var focusReportId = navState.FocusReportId;

            if (initialLat == 0 && initialLng == 0 && !focusReportId.HasValue)
            {
                // Start background acquisition but don't block map initialization
                _ = GetLocationAndCenterMap();
            }

            if (_mapContainer?.Map != null)
            {
                await _mapContainer.Map.InitializeAsync(initialLat, initialLng);

                // If we already got a location while initializing, center now
                if (ClientLocation.LastKnownPosition != null && initialLat == 0 && initialLng == 0 && !focusReportId.HasValue)
                {
                    await MapService.SetMapViewAsync(ClientLocation.LastKnownPosition.Coords.Latitude, ClientLocation.LastKnownPosition.Coords.Longitude);
                }

                try
                {
                    _locationWatchId = await MapService.WatchLocationAsync(_mapContainer.Map.GetDotNetObjectReference()!);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error starting location watch");
                }
            }

            if (focusReportId.HasValue && focusReportId != _lastHandledFocusReportId)
            {
                _lastHandledFocusReportId = focusReportId;
                await HandleFocusReportAsync(focusReportId.Value);
            }
            else if (initialRadius.HasValue)
            {
                await MapService.SetMapViewAsync(initialLat, initialLng, initialRadius.Value);
            }

            if (isNew)
            {
                await StorageService.ClearNewUserFlagAsync();
                
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Info, 
                    Summary = L["Welcome_Summary"], 
                    Detail = L["Welcome_Detail"],
                    Duration = 10000,
                });

                // Show help dialog for first-ever load
                await OnHelpClick();
            }

            // Check for report draft
            await CheckForReportDraft();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (MapState.MapInitialized)
        {
            var navState = await MapNavigationManager.GetNavigationStateAsync();
            if (navState.FocusReportId.HasValue || navState.InitialLat.HasValue || navState.InitialLng.HasValue)
            {
                _hasExplicitInitialView = true;
            }

            if (navState.FocusReportId.HasValue)
            {
                if (navState.FocusReportId != _lastHandledFocusReportId)
                {
                    _lastHandledFocusReportId = navState.FocusReportId;
                    await HandleFocusReportAsync(navState.FocusReportId.Value);
                }
            }
            else
            {
                _lastHandledFocusReportId = null;
            }
        }
    }

    private async Task HandleFocusReportAsync(int reportId)
    {
        var report = MapState.Reports.FirstOrDefault(r => r.Id == reportId);
        var fetchedFromService = false;
        if (report == null)
        {
            var result = await ReportService.GetReportByIdAsync(reportId);
            if (result.IsSuccess)
            {
                report = result.Value;
                fetchedFromService = true;
            }
        }

        if (report != null)
        {
            if (fetchedFromService)
            {
                // Force it into state and on the map so focusing and clicking works
                MapState.AddReportToState(report);
                await MapService.AddSingleReportAsync(report);
            }
            await MapService.FocusReportAsync(report.Id, triggerClick: false);
            await MapInteraction.HandleMapClickAsync(report.Latitude, report.Longitude, isMarkerClick: true, reportId: report.Id);
        }
    }

    private async Task CheckForReportDraft()
    {
        var draftJson = await StorageService.GetItemAsync("report_draft");
        if (!string.IsNullOrEmpty(draftJson))
        {
            try
            {
                var draft = JsonSerializer.Deserialize<Report>(draftJson);
                if (draft != null && DateTime.UtcNow - draft.CreatedAt < TimeSpan.FromHours(24))
                {
                    var resume = await DialogService.Confirm(L["Resume_Draft_Message"], L["Resume_Draft_Title"]);
                    if (resume == true)
                    {
                        await ShowReportDialog(draft);
                    }
                    else
                    {
                        await StorageService.RemoveItemAsync("report_draft");
                    }
                }
                else
                {
                    await StorageService.RemoveItemAsync("report_draft");
                }
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to deserialize report draft");
                await StorageService.RemoveItemAsync("report_draft");
            }
        }
    }

    private async Task OnSettingsClick(bool force = false)
    {
        var options = force ? DialogConfigs.NonCloseable : DialogConfigs.Default;
        await DialogService.OpenAsync<SettingsDialog>(L["SETTINGS"], null, options);
    }

    private async Task OnHelpClick()
    {
        await DialogService.OpenAsync<HelpDialog>(L["HELP"], null, DialogConfigs.Default);
    }

    private async Task OnAlertsClick() => await ShowAlertsDialog();
    private async Task ShowAlertsDialog(double? lat = null, double? lng = null, int? alertId = null, double? radiusKm = null)
    {
        var parameters = new Dictionary<string, object>();
        if (alertId.HasValue)
        {
            parameters.Add("SelectedAlertId", alertId.Value);
        }

        try
        {
            var mapState = await MapService.GetMapStateAsync();
            if (mapState != null)
            {
                parameters.Add("InitialLat", lat ?? mapState.Lat);
                parameters.Add("InitialLng", lng ?? mapState.Lng);
                parameters.Add("InitialRadius", radiusKm ?? Math.Round(mapState.RadiusKm, 1));
            }
        }
        catch (Exception) { /* Ignore */ }

        var result = await DialogService.OpenAsync<AlertsDialog>(L["ALERTS"], parameters, DialogConfigs.Default);

        await MapState.LoadAlertsAsync();

        if (result is Alert alert)
        {
            await MapService.SetMapViewAsync(alert.Latitude, alert.Longitude, alert.RadiusKm);
        }
    }

    private async Task OnDonateClick()
    {
        await DialogService.OpenAsync<DonateDialog>(L["DONATE"], null, DialogConfigs.Default);
    }

    private async Task OnReportClick()
    {
        if (ClientLocation.LastKnownPosition != null && (DateTime.UtcNow - ClientLocation.LastLocationUpdate).TotalSeconds < 30)
        {
            await ProcessReportWithLocation(ClientLocation.LastKnownPosition);
            return;
        }

        double initialLat, initialLng;
        if (ClientLocation.LastKnownPosition != null)
        {
            initialLat = ClientLocation.LastKnownPosition.Coords.Latitude;
            initialLng = ClientLocation.LastKnownPosition.Coords.Longitude;
        }
        else
        {
            var mapState = await MapService.GetMapStateAsync();
            initialLat = mapState?.Lat ?? 0;
            initialLng = mapState?.Lng ?? 0;
        }

        var report = new Report
        {
            Latitude = initialLat,
            Longitude = initialLng,
            ReporterIdentifier = _userIdentifier,
            ReporterLatitude = initialLat,
            ReporterLongitude = initialLng,
        };

        await MapService.ShowGhostPinAsync(initialLat, initialLng);
        try
        {
            // Start location acquisition in background
            var locationTask = ClientLocation.GetLocationWithFallbackAsync(allowManual: true, showUi: false);
            
            // Show dialog immediately
            await ShowReportDialog(report, locationTask);
        }
        finally
        {
            await MapService.HideGhostPinAsync();
        }
    }

    private async Task ProcessReportWithLocation(GeolocationPosition position)
    {
        await MapService.ShowGhostPinAsync(position.Coords.Latitude, position.Coords.Longitude);
        try
        {
            var report = new Report
            {
                Latitude = position.Coords.Latitude,
                Longitude = position.Coords.Longitude,
                ReporterIdentifier = _userIdentifier,
                ReporterLatitude = position.Coords.Latitude,
                ReporterLongitude = position.Coords.Longitude,
            };
            
            await ShowReportDialog(report);
        }
        finally
        {
            await MapService.HideGhostPinAsync();
        }
    }

    private async Task OnFollowMeChange(bool value)
    {
        if (value && ClientLocation.LastKnownPosition != null)
        {
            await MapService.SetMapViewAsync(ClientLocation.LastKnownPosition.Coords.Latitude, ClientLocation.LastKnownPosition.Coords.Longitude);
            _searchAddress = await GeocodingService.ReverseGeocodeAsync(ClientLocation.LastKnownPosition.Coords.Latitude, ClientLocation.LastKnownPosition.Coords.Longitude);
        }
    }

    private void OnUserInteractedWithMap()
    {
        if (!_followMe)
        {
            return;
        }
        
        _followMe = false;
        StateHasChanged();
    }

    private static Task OnMapMoveEnd(double lat, double lng)
    {
        return Task.CompletedTask;
    }

    private async Task OnLocationUpdated(GeolocationPosition position)
    {
        var isFirstLocation = ClientLocation.LastKnownPosition == null;
        ClientLocation.UpdateLastKnownPosition(position);

        if (MapState.MapInitialized)
        {
            await MapService.UpdateUserLocationAsync( 
                position.Coords.Latitude, 
                position.Coords.Longitude, 
                position.Coords.Accuracy);

            if (_followMe || (isFirstLocation && !_hasExplicitInitialView))
            {
                await MapService.SetMapViewAsync(position.Coords.Latitude, position.Coords.Longitude);
                
                // Only reverse geocode if search box is empty or we are following
                if (string.IsNullOrEmpty(_searchAddress) || _followMe)
                {
                    _searchAddress = await GeocodingService.ReverseGeocodeAsync(position.Coords.Latitude, position.Coords.Longitude);
                    StateHasChanged();
                }
            }
        }
    }

    private async Task OnAddressSelected(GeocodingResult selected)
    {
        if (selected != null)
        {
            _searchAddress = selected.Address;
            await MapService.SetMapViewAsync(selected.Latitude, selected.Longitude, 2.0); // 2km radius
            _followMe = false; // Disable follow me if user manually searches
        }
    }

    private async Task OnAlertDeleteClick(int alertId)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this alert zone?", "Delete Alert", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            await ValidationService.ExecuteAsync(
                () => AlertService.DeleteAlertAsync(alertId),
                successMessage: "Alert deleted",
                errorTitle: "Delete failed",
                onSuccess: async () => await MapState.LoadAlertsAsync(),
                logContext: $"Home.OnAlertDeleteClick {alertId}"
            );
        }
    }

    private async Task ShowReportDialog(Report report, Task<GeolocationPosition?>? locationTask = null, bool updateReportLocation = true)
    {
        var result = await DialogService.OpenAsync<ReportDialog>("REPORT LOCATION",
            new Dictionary<string, object> 
            { 
                { "Report", report },
                { "LocationTask", locationTask ?? Task.FromResult<GeolocationPosition?>(null) },
                { "UpdateReportLocation", updateReportLocation },
            },
            DialogConfigs.Default);

        if (result == true)
        {
            await MapState.LoadReportsAsync(_selectedHours, GetIncludeExternalId());
        }
    }

    private Guid? GetIncludeExternalId()
    {
        if (Guid.TryParse(ReportIdQuery, out var rGuid))
        {
            return rGuid;
        }
        return null;
    }

    private async Task HandleManualPick()
    {
        try
        {
            var mapState = await MapService.GetMapStateAsync();
            if (mapState != null)
            {
                ClientLocation.ConfirmManualPick(new GeolocationPosition 
                { 
                    Coords = new GeolocationCoordinates { Latitude = mapState.Lat, Longitude = mapState.Lng },
                });
            }
            else
            {
                ClientLocation.ConfirmManualPick(null);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to get map state for manual pick");
            ClientLocation.ConfirmManualPick(null);
        }
    }

    private async Task GetLocationAndCenterMap()
    {
        var position = await ClientLocation.GetLocationWithFallbackAsync(allowManual: false, showUi: false);
        if (position != null && MapState.MapInitialized)
        {
            await MapService.SetMapViewAsync(position.Coords.Latitude, position.Coords.Longitude);
        }
    }

    public void Dispose()
    {
        if (_disposed)
        {
            return;
        }

        _disposed = true;

        MapState.OnStateChanged -= HandleStateChanged;
        ClientLocation.OnStateChanged -= HandleStateChanged;
        EventService.OnSettingsChanged -= HandleSettingsChanged;
        EventService.OnEntityChanged -= HandleEntityChanged;
        AdminService.OnAdminLogin -= HandleAdminLogin;
        AdminService.OnAdminLogout -= HandleAdminLogout;

        if (_locationWatchId != -1)
        {
            _ = MapService.StopWatchingAsync(_locationWatchId);
        }
    }
}
