@page "/"
@using WhereAreThey.Models
@using WhereAreThey.Services
@inject LocationService LocationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject DialogService DialogService
@inject NotificationService NotificationService
@implements IDisposable

<PageTitle>WhereAreThey - Live Heat Map</PageTitle>

<div class="d-flex flex-column" style="height: calc(100vh - 56px);">
    <!-- Toolbar -->
    <div class="rz-p-2 rz-background-color-primary-lighter d-flex align-items-center justify-content-between flex-wrap gap-2" style="border-bottom: 1px solid rgba(0,0,0,0.1);">
        <div class="d-flex align-items-center gap-2">
            <RadzenButton Text="REPORT" Icon="report_problem" ButtonStyle="ButtonStyle.Danger" Click="@OnReportClick" Size="ButtonSize.Medium" />
            <RadzenNumeric @bind-Value="@hoursBack" TValue="int" Min="1" Max="168" Style="width: 80px;" Change="@LoadReports" />
            <RadzenText TextStyle="TextStyle.Caption" Class="rz-m-0">hrs</RadzenText>
            <RadzenButton Icon="refresh" Click="@LoadReports" ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat" Size="ButtonSize.Medium" />
        </div>
        
        <div class="d-flex align-items-center gap-2">
            <RadzenButton Text="ALERTS" Icon="notifications" Click="@(() => NavigationManager.NavigateTo("/alerts"))" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Flat" Size="ButtonSize.Medium" />
            <RadzenButton Text="DONATE" Icon="volunteer_activism" Click="@(() => NavigationManager.NavigateTo("/donate"))" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.Medium" />
        </div>
    </div>

    <!-- Map Container -->
    <div style="flex: 1; position: relative;">
        <div id="heatmap" style="height: 100%; width: 100%;"></div>
        
        @if (isGettingLocation)
        {
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
                <RadzenCard Class="rz-shadow-10">
                    <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        <RadzenText TextStyle="TextStyle.Body1">Acquiring GPS Location...</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </div>
        }
    </div>
</div>

@code {
    private List<LocationReport> reports = new();
    private int hoursBack = 24;
    private bool mapInitialized = false;
    private bool isGettingLocation = false;
    private DotNetObjectReference<Home>? objRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadReports();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            
            double initialLat = 0;
            double initialLng = 0;

            try
            {
                isGettingLocation = true;
                StateHasChanged();
                var position = await JSRuntime.InvokeAsync<GeolocationPosition>("getLocation");
                initialLat = position.Coords.Latitude;
                initialLng = position.Coords.Longitude;
            }
            catch (Exception)
            {
                // Fallback to (0,0) if location access denied or fails
            }
            finally
            {
                isGettingLocation = false;
                StateHasChanged();
            }

            await JSRuntime.InvokeVoidAsync("initHeatMap", "heatmap", initialLat, initialLng, reports, objRef);
            mapInitialized = true;
        }
    }

    private async Task LoadReports()
    {
        reports = await LocationService.GetRecentReportsAsync(hoursBack);
        if (mapInitialized)
        {
            await JSRuntime.InvokeVoidAsync("updateHeatMap", reports);
        }
    }

    private async Task OnReportClick()
    {
        isGettingLocation = true;
        StateHasChanged();
        try
        {
            var position = await JSRuntime.InvokeAsync<GeolocationPosition>("getLocation");
            var report = new LocationReport
            {
                Latitude = position.Coords.Latitude,
                Longitude = position.Coords.Longitude
            };
            
            await ShowReportDialog(report);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to get location", ex.Message);
            // Fallback: show dialog without location? Or just let them try again.
        }
        finally
        {
            isGettingLocation = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnMapDoubleClick(double lat, double lng)
    {
        var report = new LocationReport
        {
            Latitude = lat,
            Longitude = lng
        };
        await ShowReportDialog(report);
    }

    private async Task ShowReportDialog(LocationReport report)
    {
        var result = await DialogService.OpenAsync<ReportDialog>("REPORT LOCATION",
            new Dictionary<string, object> { { "report", report } },
            new DialogOptions { Width = "350px", Resizable = false, Draggable = true });

        if (result == true)
        {
            await LoadReports();
        }
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }

    public class GeolocationPosition
    {
        public GeolocationCoordinates Coords { get; set; } = new();
    }

    public class GeolocationCoordinates
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }
}
