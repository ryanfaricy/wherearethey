@page "/"
@inject IReportService ReportService
@inject IAlertService AlertService
@inject IGeocodingService GeocodingService
@inject NavigationManager NavigationManager
@inject ISettingsService SettingsService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IMapService MapService
@inject IClientStorageService StorageService
@inject ILogger<Home> Logger
@inject IStringLocalizer<App> L
@inject IEventService EventService
@inject IHapticFeedbackService HapticFeedbackService
@using System.Globalization
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@using System.Text.Json
@using WhereAreThey.Components.Home
@implements IDisposable

<PageTitle>AreTheyHere - @L["Live Heat Map"]</PageTitle>
<RadzenMediaQuery Query="(max-width: 768px)" Change=@(args => _isMobile = args) />

<RadzenStack Orientation="Orientation.Vertical" Gap="0" Style="height: 100%; width: 100%; position: absolute; top: 0; left: 0; overflow: hidden;">
    <!-- Toolbar -->
    <HomeToolbar IsMobile="@_isMobile" 
                 DonationsEnabled="@_systemSettings.DonationsEnabled"
                 OnReportClick="@OnReportClick"
                 OnAlertsClick="@OnAlertsClick"
                 OnDonateClick="@OnDonateClick"
                 OnSettingsClick="@(() => OnSettingsClick(false))"
                 OnHelpClick="@OnHelpClick"
                 OnRefreshClick="@LoadReports" />

    <!-- Map Container -->
    <RadzenStack Gap="0" Style="flex: 1; position: relative;">
        <HeatMap @ref="_heatMap"
                 ElementId="heatmap"
                 Reports="@_reports" 
                 Alerts="@_userAlerts"
                 InitialLat="@_initialLat"
                 InitialLng="@_initialLng"
                 OnMapClick="@OnHeatMapClick"
                 OnMapMoveEnd="@OnHeatMapMoveEnd"
                 OnUserInteractedWithMap="@OnHeatMapUserInteracted"
                 OnLocationUpdated="@OnHeatMapLocationUpdated"
                 OnMapContextMenu="@OnHeatMapContextMenu"
                 OnAlertDeleteClick="@OnHeatMapAlertDeleteClick" />
        
        <!-- Map Controls -->
        <HomeMapControls @bind-SearchAddress="@_searchAddress"
                         @bind-FollowMe="@_followMe"
                         @bind-SelectedHours="@_selectedHours"
                         ReportExpiryHours="@_systemSettings.ReportExpiryHours"
                         OnAddressSelected="@OnAddressSelected"
                         OnFollowMeChange="@OnFollowMeChange"
                         OnHoursChange="@LoadReports" />

        <!-- Map Legend -->
        <HomeLegend />

        @if (_isGettingLocation)
        {
            <RadzenStack Style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
                <RadzenCard Class="rz-shadow-10">
                    <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        <RadzenText TextStyle="TextStyle.Body1">@L["Acquiring_Location"]</RadzenText>
                        @if (_showManualPick)
                        {
                            <RadzenButton Text="@L["Manual_Pick"]" Click="@HandleManualPick" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Size="ButtonSize.Small" />
                        }
                    </RadzenStack>
                </RadzenCard>
            </RadzenStack>
        }
    </RadzenStack>
</RadzenStack>

@code {
    private HeatMap? _heatMap;
    private bool _isMobile;
    private bool _disposed;
    private List<LocationReport> _reports = new();
    private List<Alert> _userAlerts = new();
    private SystemSettings _systemSettings = new();
    private bool _mapInitialized;
    private bool _isGettingLocation;
    private bool _showManualPick;
    private TaskCompletionSource<GeolocationPosition?>? _manualPickTcs;
    private string? _userIdentifier;
    private int _locationWatchId = -1;
    private GeolocationPosition? _lastKnownPosition;
    private DateTime _lastLocationUpdate;
    private bool _followMe;
    private int _selectedHours = 24;
    private string? _searchAddress;
    private double _initialLat;
    private double _initialLng;

    private async Task OnHeatMapClick(HeatMap.MapClickEventArgs args) => await OnMapClick(args.Lat, args.Lng, args.IsMarkerClick);
    private async Task OnHeatMapMoveEnd(HeatMap.MapLocationEventArgs args) => await OnMapMoveEnd(args.Lat, args.Lng);
    private void OnHeatMapUserInteracted() => OnUserInteractedWithMap();
    private async Task OnHeatMapLocationUpdated(GeolocationPosition position) => await OnLocationUpdated(position);
    private async Task OnHeatMapContextMenu(HeatMap.MapLocationEventArgs args) => await OnMapContextMenu(args.Lat, args.Lng);
    private async Task OnHeatMapAlertDeleteClick(int alertId) => await OnAlertDeleteClick(alertId);

    protected override async Task OnInitializedAsync()
    {
        // Subscribe early to ensure unsubscription in Dispose
        EventService.OnReportAdded += HandleReportAdded;
        EventService.OnReportUpdated += HandleReportUpdated;
        EventService.OnReportDeleted += HandleReportDeleted;
        EventService.OnAlertAdded += HandleAlertAdded;
        EventService.OnAlertUpdated += HandleAlertUpdated;
        EventService.OnAlertDeleted += HandleAlertDeleted;
        EventService.OnSettingsChanged += HandleSettingsChanged;

        _systemSettings = await SettingsService.GetSettingsAsync();
        if (_disposed) return;

        _selectedHours = _systemSettings.ReportExpiryHours;
        await LoadReports();
        if (_disposed) return;
    }

    private void HandleSettingsChanged(SystemSettings settings)
    {
        InvokeAsync(() => {
            _systemSettings = settings;
            StateHasChanged();
        });
    }

    private void HandleReportAdded(LocationReport report)
    {
        InvokeAsync(async () =>
        {
            // Incremental update if it matches current time filter
            var cutoff = DateTime.UtcNow.AddHours(-_selectedHours);
            if (report.Timestamp >= cutoff && _reports.All(r => r.Id != report.Id))
            {
                _reports.Insert(0, report);
                if (_mapInitialized)
                {
                    await MapService.AddSingleReportAsync(report);

                    // Show toast if not from current user and we have our location
                    if (report.ReporterIdentifier != _userIdentifier && _lastKnownPosition != null)
                    {
                        var distance = GeoUtils.CalculateDistance(
                            _lastKnownPosition.Coords.Latitude,
                            _lastKnownPosition.Coords.Longitude,
                            report.Latitude,
                            report.Longitude);

                        // If it's nearby, vibrate
                        if (distance <= 5) // Within 5km
                        {
                            if (report.IsEmergency)
                            {
                                await HapticFeedbackService.VibrateEmergencyAsync();
                            }
                            else
                            {
                                await HapticFeedbackService.VibrateUpdateAsync();
                            }
                        }

                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = report.IsEmergency ? NotificationSeverity.Error : NotificationSeverity.Info,
                            Summary = L["New_Report"],
                            Detail = $"{string.Format(L["New_Report_Notification"], distance)} ({L["VIEW"]})",
                            Duration = 10000,
                            Click = _ => MapService.FocusReportAsync(report.Id)
                        });
                    }
                }
            }
            StateHasChanged();
        });
    }

    private void HandleReportUpdated(LocationReport report)
    {
        InvokeAsync(async () =>
        {
            var existing = _reports.FirstOrDefault(r => r.Id == report.Id);
            if (existing != null)
            {
                var index = _reports.IndexOf(existing);
                _reports[index] = report;
                if (_mapInitialized)
                {
                    // Map update: remove and re-add for simplicity if no specific update function exists
                    await MapService.RemoveSingleReportAsync(report.Id);
                    await MapService.AddSingleReportAsync(report);
                }
                StateHasChanged();
            }
            else
            {
                HandleReportAdded(report);
            }
        });
    }

    private void HandleReportDeleted(int id)
    {
        InvokeAsync(async () =>
        {
            var report = _reports.FirstOrDefault(r => r.Id == id);
            if (report != null)
            {
                _reports.Remove(report);
                if (_mapInitialized)
                {
                    await MapService.RemoveSingleReportAsync(id);
                }
                StateHasChanged();
            }
        });
    }

    private void HandleAlertAdded(Alert alert)
    {
        InvokeAsync(async () =>
        {
            if (alert.UserIdentifier == _userIdentifier && _userAlerts.All(a => a.Id != alert.Id))
            {
                _userAlerts.Add(alert);
                if (_mapInitialized)
                {
                    await MapService.UpdateAlertsAsync(_userAlerts);
                }
                StateHasChanged();
            }
        });
    }

    private void HandleAlertUpdated(Alert alert)
    {
        InvokeAsync(async () =>
        {
            if (alert.UserIdentifier == _userIdentifier)
            {
                var index = _userAlerts.FindIndex(a => a.Id == alert.Id);
                if (index != -1)
                {
                    if (alert.IsActive)
                    {
                        _userAlerts[index] = alert;
                    }
                    else
                    {
                        _userAlerts.RemoveAt(index);
                    }

                    if (_mapInitialized)
                    {
                        await MapService.UpdateAlertsAsync(_userAlerts);
                    }
                    StateHasChanged();
                }
                else if (alert.IsActive)
                {
                    HandleAlertAdded(alert);
                }
            }
        });
    }

    private void HandleAlertDeleted(int id)
    {
        InvokeAsync(async () =>
        {
            var alert = _userAlerts.FirstOrDefault(a => a.Id == id);
            if (alert != null)
            {
                _userAlerts.Remove(alert);
                if (_mapInitialized)
                {
                    await MapService.UpdateAlertsAsync(_userAlerts);
                }
                StateHasChanged();
            }
        });
    }

    /// <summary>
    /// Initializes the map and JS interop after the component has rendered.
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _userIdentifier = await StorageService.GetUserIdentifierAsync();
            
            if (string.IsNullOrEmpty(_userIdentifier))
            {
                await OnSettingsClick(true);
                return; // The dialog will trigger a reload, so we should not continue in this instance
            }
            
            var isNew = await StorageService.IsNewUserAsync();
            
            await LoadUserAlerts();
            
            double initialLat = 0;
            double initialLng = 0;
            double? initialRadius = null;
            int? focusReportId = null;

            // Check query parameters
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);

            if (query.TryGetValue("hours", out var hoursStr) && int.TryParse(hoursStr, out var h))
            {
                _selectedHours = h;
            }

            if (query.TryGetValue("reportId", out var reportIdStr))
            {
                if (Guid.TryParse(reportIdStr, out var rGuid))
                {
                    var report = await ReportService.GetReportByExternalIdAsync(rGuid);
                    if (report != null)
                    {
                        focusReportId = report.Id;
                        initialLat = report.Latitude;
                        initialLng = report.Longitude;
                    }
                }
                else if (int.TryParse(reportIdStr, out var rId))
                {
                    focusReportId = rId;
                }
            }

            if (query.TryGetValue("alertId", out var alertIdStr) && Guid.TryParse(alertIdStr, out var aGuid))
            {
                var alert = await AlertService.GetAlertByExternalIdAsync(aGuid);
                if (alert != null)
                {
                    initialLat = alert.Latitude;
                    initialLng = alert.Longitude;
                    initialRadius = alert.RadiusKm;
                }
            }

            if (initialLat == 0 && query.TryGetValue("lat", out var latStr) && double.TryParse(latStr, CultureInfo.InvariantCulture, out var lat))
            {
                initialLat = lat;
            }
            if (initialLng == 0 && query.TryGetValue("lng", out var lngStr) && double.TryParse(lngStr, CultureInfo.InvariantCulture, out var lng))
            {
                initialLng = lng;
            }
            if (!initialRadius.HasValue && query.TryGetValue("radius", out var radiusStr) && double.TryParse(radiusStr, CultureInfo.InvariantCulture, out var radius))
            {
                initialRadius = radius;
            }

            if (initialLat == 0 && initialLng == 0 && !focusReportId.HasValue)
            {
                // Start background acquisition but don't block map initialization
                _ = GetLocationAndCenterMap();
            }

            if (_heatMap != null)
            {
                await _heatMap.InitializeAsync(initialLat, initialLng);
                _mapInitialized = true;

                // If we already got a location while initializing, center now
                if (_lastKnownPosition != null && initialLat == 0 && initialLng == 0 && !focusReportId.HasValue)
                {
                    await MapService.SetMapViewAsync(_lastKnownPosition.Coords.Latitude, _lastKnownPosition.Coords.Longitude, null);
                }

                try
                {
                    _locationWatchId = await MapService.WatchLocationAsync(_heatMap.GetDotNetObjectReference());
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error starting location watch");
                }
            }

            if (focusReportId.HasValue)
            {
                await MapService.FocusReportAsync(focusReportId.Value);
            }
            else if (initialRadius.HasValue)
            {
                await MapService.SetMapViewAsync(initialLat, initialLng, initialRadius.Value);
            }

            if (isNew)
            {
                await StorageService.ClearNewUserFlagAsync();
                
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Info, 
                    Summary = L["Welcome_Summary"], 
                    Detail = L["Welcome_Detail"],
                    Duration = 10000
                });

                // Show help dialog for first-ever load
                await OnHelpClick();
            }

            // Check for report draft
            var draftJson = await StorageService.GetItemAsync("report_draft");
            if (!string.IsNullOrEmpty(draftJson))
            {
                try
                {
                    var draft = JsonSerializer.Deserialize<LocationReport>(draftJson);
                    if (draft != null)
                    {
                        // Only prompt if draft is less than 24 hours old
                        if (DateTime.UtcNow - draft.Timestamp < TimeSpan.FromHours(24))
                        {
                            var resume = await DialogService.Confirm(L["Resume_Draft_Message"], L["Resume_Draft_Title"]);
                            if (resume == true)
                            {
                                await ShowReportDialog(draft);
                            }
                            else
                            {
                                await StorageService.RemoveItemAsync("report_draft");
                            }
                        }
                        else
                        {
                            // Draft is too old, clear it
                            await StorageService.RemoveItemAsync("report_draft");
                        }
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Failed to deserialize report draft");
                    // Clear broken draft
                    await StorageService.RemoveItemAsync("report_draft");
                }
            }
        }
    }

    private async Task LoadReports()
    {
        _reports = await ReportService.GetRecentReportsAsync(_selectedHours);
        if (_mapInitialized)
        {
            await MapService.UpdateHeatMapAsync(_reports);
        }
    }

    private async Task LoadUserAlerts()
    {
        if (!string.IsNullOrEmpty(_userIdentifier))
        {
            _userAlerts = await AlertService.GetActiveAlertsAsync(_userIdentifier, onlyVerified: false);
            if (_mapInitialized)
            {
                await MapService.UpdateAlertsAsync(_userAlerts);
            }
        }
    }

    private async Task OnSettingsClick(bool force = false)
    {
        var options = force ? DialogConfigs.NonCloseable : DialogConfigs.Default;

        await DialogService.OpenAsync<SettingsDialog>(L["SETTINGS"],
            null,
            options);
    }

    private async Task OnHelpClick()
    {
        await DialogService.OpenAsync<HelpDialog>(L["HELP"],
            null,
            DialogConfigs.Default);
    }

    private async Task OnAlertsClick() => await ShowAlertsDialog();

    private async Task ShowAlertsDialog(double? lat = null, double? lng = null)
    {
        var parameters = new Dictionary<string, object>();
        try
        {
            if (lat.HasValue && lng.HasValue)
            {
                parameters.Add("InitialLat", lat.Value);
                parameters.Add("InitialLng", lng.Value);
                
                var mapState = await MapService.GetMapStateAsync();
                if (mapState != null)
                {
                    parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
                }
            }
            else
            {
                var mapState = await MapService.GetMapStateAsync();
                if (mapState != null)
                {
                    parameters.Add("InitialLat", mapState.Lat);
                    parameters.Add("InitialLng", mapState.Lng);
                    parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
                }
            }
        }
        catch (Exception)
        {
            // Ignore if map state cannot be retrieved
        }

        var result = await DialogService.OpenAsync<AlertsDialog>(L["ALERTS"],
            parameters,
            DialogConfigs.Default);

        await LoadUserAlerts();

        if (result is Alert alert)
        {
            await MapService.SetMapViewAsync(alert.Latitude, alert.Longitude, alert.RadiusKm);
        }
    }

    private async Task OnDonateClick()
    {
        await DialogService.OpenAsync<DonateDialog>(L["DONATE"],
            null,
            DialogConfigs.Default);
    }

    /// <summary>
    /// Triggered when the user clicks the "REPORT" button.
    /// Handles GPS acquisition and shows the report dialog.
    /// </summary>
    private async Task OnReportClick()
    {
        if (_lastKnownPosition != null && (DateTime.UtcNow - _lastLocationUpdate).TotalSeconds < 30)
        {
            await ProcessReportWithLocation(_lastKnownPosition);
            return;
        }

        // Use last known position if available, otherwise map center
        double initialLat, initialLng;
        if (_lastKnownPosition != null)
        {
            initialLat = _lastKnownPosition.Coords.Latitude;
            initialLng = _lastKnownPosition.Coords.Longitude;
        }
        else
        {
            var mapState = await MapService.GetMapStateAsync();
            initialLat = mapState?.Lat ?? 0;
            initialLng = mapState?.Lng ?? 0;
        }

        var report = new LocationReport
        {
            Latitude = initialLat,
            Longitude = initialLng,
            ReporterIdentifier = _userIdentifier,
            ReporterLatitude = initialLat,
            ReporterLongitude = initialLng
        };

        await MapService.ShowGhostPinAsync(initialLat, initialLng);
        try
        {
            // Start location acquisition in background
            var locationTask = GetLocationWithFallback(allowManual: true, showUI: false);
            
            // Show dialog immediately
            await ShowReportDialog(report, locationTask);
        }
        finally
        {
            await MapService.HideGhostPinAsync();
        }
    }

    private async Task ProcessReportWithLocation(GeolocationPosition position)
    {
        await MapService.ShowGhostPinAsync(position.Coords.Latitude, position.Coords.Longitude);
        try
        {
            var report = new LocationReport
            {
                Latitude = position.Coords.Latitude,
                Longitude = position.Coords.Longitude,
                ReporterIdentifier = _userIdentifier,
                ReporterLatitude = position.Coords.Latitude,
                ReporterLongitude = position.Coords.Longitude
            };
            
            await ShowReportDialog(report);
        }
        finally
        {
            await MapService.HideGhostPinAsync();
        }
    }

    private async Task OnFollowMeChange(bool value)
    {
        if (value && _lastKnownPosition != null)
        {
            await MapService.SetMapViewAsync(_lastKnownPosition.Coords.Latitude, _lastKnownPosition.Coords.Longitude, null);
            _searchAddress = await GeocodingService.ReverseGeocodeAsync(_lastKnownPosition.Coords.Latitude, _lastKnownPosition.Coords.Longitude);
        }
    }

    private void OnUserInteractedWithMap()
    {
        if (_followMe)
        {
            _followMe = false;
            StateHasChanged();
        }
    }

    private async Task OnMapMoveEnd(double lat, double lng)
    {
        if (_followMe) return;

        _searchAddress = await GeocodingService.ReverseGeocodeAsync(lat, lng);
        StateHasChanged();
    }

    private async Task OnLocationUpdated(GeolocationPosition position)
    {
        var isFirstLocation = _lastKnownPosition == null;
        _lastKnownPosition = position;
        _lastLocationUpdate = DateTime.UtcNow;

        if (_mapInitialized)
        {
            await MapService.UpdateUserLocationAsync( 
                position.Coords.Latitude, 
                position.Coords.Longitude, 
                position.Coords.Accuracy);

            if (_followMe || isFirstLocation)
            {
                await MapService.SetMapViewAsync(position.Coords.Latitude, position.Coords.Longitude, null);
                
                // Only reverse geocode if search box is empty or we are following
                if (string.IsNullOrEmpty(_searchAddress) || _followMe)
                {
                    _searchAddress = await GeocodingService.ReverseGeocodeAsync(position.Coords.Latitude, position.Coords.Longitude);
                    StateHasChanged();
                }
            }
        }
    }

    private async Task OnAddressSelected(GeocodingResult selected)
    {
        if (selected != null)
        {
            _searchAddress = selected.Address;
            await MapService.SetMapViewAsync(selected.Latitude, selected.Longitude, 2.0); // 2km radius
            _followMe = false; // Disable follow me if user manually searches
        }
    }

    private async Task OnMapClick(double lat, double lng, bool force = false)
    {
        _followMe = false;
        var zoom = await MapService.GetZoomLevelAsync();

        // Find reports within a certain radius
        // - Marker clicks (force): 50m
        // - High zoom map clicks: 200m tap tolerance for near-misses on mobile
        // - Low zoom map clicks: 5km area search for heatmap blobs
        double searchRadiusKm;
        if (force)
        {
            searchRadiusKm = 0.05;
        }
        else if (zoom >= 15)
        {
            searchRadiusKm = 0.2;
        }
        else
        {
            searchRadiusKm = 5.0;
        }

        var nearbyReports = _reports
            .Where(r => GeoUtils.CalculateDistance(lat, lng, r.Latitude, r.Longitude) <= searchRadiusKm)
            .OrderByDescending(r => r.Timestamp)
            .ToList();

        var nearbyAlerts = _userAlerts
            .Where(a => GeoUtils.CalculateDistance(lat, lng, a.Latitude, a.Longitude) <= searchRadiusKm)
            .ToList();

        if (nearbyReports.Any() || nearbyAlerts.Any())
        {
            // If it's a single report, highlight it immediately for better feedback
            if (nearbyReports.Count == 1 && !nearbyAlerts.Any())
            {
                await MapService.SelectReportAsync(nearbyReports[0].Id);
            }

            // Tapping on a blob or marker reveals area details
            var result = await DialogService.OpenAsync<ReportDetailsDialog>("AREA DETAILS",
                new Dictionary<string, object> 
                { 
                    { "Reports", nearbyReports },
                    { "Alerts", nearbyAlerts }
                },
                DialogConfigs.Default);

            if (result == true) // If an alert was deleted
            {
                await LoadUserAlerts();
            }
        }
        else if (!force)
        {
            // Tapping on a non-blob area opens create alert (only for map clicks, not marker clicks)
            await ShowAlertsDialog(lat, lng);
        }
    }

    [JSInvokable]
    public async Task OnMapContextMenu(double lat, double lng)
    {
        // Long-press/right click reveals create report
        // We need user's current location to verify distance
        
        await MapService.ShowGhostPinAsync(lat, lng);
        
        try
        {
            if (_lastKnownPosition != null && (DateTime.UtcNow - _lastLocationUpdate).TotalSeconds < 30)
            {
                var report = new LocationReport
                {
                    Latitude = lat,
                    Longitude = lng,
                    ReporterIdentifier = _userIdentifier,
                    ReporterLatitude = _lastKnownPosition.Coords.Latitude,
                    ReporterLongitude = _lastKnownPosition.Coords.Longitude
                };
                await ShowReportDialog(report);
            }
            else
            {
                // Start location acquisition in background for reporter location
                var locationTask = GetLocationWithFallback(allowManual: true, showUI: false);

                var report = new LocationReport
                {
                    Latitude = lat,
                    Longitude = lng,
                    ReporterIdentifier = _userIdentifier,
                    ReporterLatitude = _lastKnownPosition?.Coords.Latitude ?? lat,
                    ReporterLongitude = _lastKnownPosition?.Coords.Longitude ?? lng
                };

                // Show dialog immediately, don't update report location from GPS (it's fixed to map click)
                await ShowReportDialog(report, locationTask, updateReportLocation: false);
            }
        }
        finally
        {
            await MapService.HideGhostPinAsync();
        }
    }

    [JSInvokable]
    public async Task OnAlertDeleteClick(int alertId)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this alert zone?", "Delete Alert", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            await AlertService.DeactivateAlertAsync(alertId);
            NotificationService.Notify(NotificationSeverity.Success, "Alert deleted");
            await LoadUserAlerts();
        }
    }

    private async Task ShowReportDialog(LocationReport report, Task<GeolocationPosition?>? locationTask = null, bool updateReportLocation = true)
    {
        var result = await DialogService.OpenAsync<ReportDialog>("REPORT LOCATION",
            new Dictionary<string, object> 
            { 
                { "Report", report },
                { "LocationTask", locationTask },
                { "UpdateReportLocation", updateReportLocation }
            },
            DialogConfigs.Default);

        if (result == true)
        {
            await LoadReports();
        }
    }

    private async Task HandleManualPick()
    {
        try
        {
            var mapState = await MapService.GetMapStateAsync();
            if (mapState != null)
            {
                _manualPickTcs?.TrySetResult(new GeolocationPosition 
                { 
                    Coords = new GeolocationCoordinates { Latitude = mapState.Lat, Longitude = mapState.Lng } 
                });
            }
            else
            {
                _manualPickTcs?.TrySetResult(null);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to get map state for manual pick");
            _manualPickTcs?.TrySetResult(null);
        }
    }

    private async Task GetLocationAndCenterMap()
    {
        var position = await GetLocationWithFallback(allowManual: false, showUI: false);
        if (position != null && _lastKnownPosition == null)
        {
            _lastKnownPosition = position;
            _lastLocationUpdate = DateTime.UtcNow;
            if (_mapInitialized)
            {
                await MapService.SetMapViewAsync(position.Coords.Latitude, position.Coords.Longitude, null);
            }
        }
    }

    private async Task<GeolocationPosition?> GetLocationWithFallback(bool allowManual = true, bool showUI = true)
    {
        if (showUI)
        {
            _isGettingLocation = true;
            _showManualPick = false;
            _manualPickTcs = new TaskCompletionSource<GeolocationPosition?>();
            StateHasChanged();
        }

        using var cts = new CancellationTokenSource();
        var locationTask = StorageService.GetLocationAsync();
        var timerTask = Task.Delay(7000, cts.Token);

        try
        {
            var firstTask = await Task.WhenAny(locationTask, timerTask);
            if (firstTask == timerTask && !locationTask.IsCompleted)
            {
                if (showUI)
                {
                    _showManualPick = allowManual;
                    StateHasChanged();

                    var secondTask = await Task.WhenAny(locationTask, _manualPickTcs.Task);
                    if (secondTask == _manualPickTcs.Task)
                    {
                        cts.Cancel();
                        return await _manualPickTcs.Task;
                    }
                }
            }

            cts.Cancel();
            return await locationTask;
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to get location");
            return null;
        }
        finally
        {
            if (showUI)
            {
                _isGettingLocation = false;
                _showManualPick = false;
                StateHasChanged();
            }
        }
    }

    public void Dispose()
    {
        if (_disposed) return;
        _disposed = true;

        EventService.OnReportAdded -= HandleReportAdded;
        EventService.OnReportUpdated -= HandleReportUpdated;
        EventService.OnReportDeleted -= HandleReportDeleted;
        EventService.OnAlertAdded -= HandleAlertAdded;
        EventService.OnAlertUpdated -= HandleAlertUpdated;
        EventService.OnAlertDeleted -= HandleAlertDeleted;
        EventService.OnSettingsChanged -= HandleSettingsChanged;

        if (_locationWatchId != -1)
        {
            _ = MapService.StopWatchingAsync(_locationWatchId);
        }
    }
}
