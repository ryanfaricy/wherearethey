@page "/"
@using System.Globalization
@using WhereAreThey.Models
@using WhereAreThey.Services
@using Microsoft.AspNetCore.WebUtilities
@inject LocationService LocationService
@inject AlertService AlertService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject DialogService DialogService
@inject NotificationService NotificationService
@implements IDisposable

<PageTitle>AreTheyHere - Live Heat Map</PageTitle>

<div class="d-flex flex-column" style="height: calc(100vh - 56px);">
    <!-- Toolbar -->
    <div class="rz-p-2 rz-background-color-primary-lighter d-flex align-items-center flex-wrap gap-2" style="border-bottom: 1px solid rgba(0,0,0,0.1);">
        <RadzenButton Text="REPORT" Icon="report_problem" ButtonStyle="ButtonStyle.Danger" Click="@OnReportClick" Size="ButtonSize.Medium" />
        <RadzenButton Text="ALERTS" Icon="notifications" Click="@OnAlertsClick" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Flat" Size="ButtonSize.Medium" class="responsive-button-text" />
        <RadzenButton Text="DONATE" Icon="volunteer_activism" Click="@OnDonateClick" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.Medium" class="responsive-button-text" />
        <RadzenButton Text="SETTINGS" Icon="settings" Click="@OnSettingsClick" ButtonStyle="ButtonStyle.Base" Variant="Variant.Flat" Size="ButtonSize.Medium" class="responsive-button-text" />
        <RadzenButton Text="HELP" Icon="help_outline" Click="@OnHelpClick" ButtonStyle="ButtonStyle.Base" Variant="Variant.Flat" Size="ButtonSize.Medium" class="responsive-button-text" />
        <RadzenButton Text="REFRESH" Icon="refresh" Click="@LoadReports" ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat" Size="ButtonSize.Medium" class="responsive-button-text" />
    </div>

    <!-- Map Container -->
    <div style="flex: 1; position: relative;">
        <div id="heatmap" style="height: 100%; width: 100%;"></div>
        
        @if (isGettingLocation)
        {
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
                <RadzenCard Class="rz-shadow-10">
                    <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        <RadzenText TextStyle="TextStyle.Body1">Acquiring GPS Location...</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </div>
        }
    </div>
</div>

@code {
    private List<LocationReport> reports = new();
    private List<Alert> userAlerts = new();
    private int hoursBack = 24;
    private bool mapInitialized = false;
    private bool isGettingLocation = false;
    private string? userIdentifier;
    private DotNetObjectReference<Home>? objRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadReports();
        LocationService.OnReportAdded += HandleReportAdded;
    }

    private void HandleReportAdded()
    {
        InvokeAsync(async () =>
        {
            await LoadReports();
            StateHasChanged();
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            userIdentifier = await JSRuntime.InvokeAsync<string>("getUserIdentifier");
            
            var isNew = await JSRuntime.InvokeAsync<bool>("isNewUser");
            if (isNew)
            {
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Info, 
                    Summary = "Welcome!", 
                    Detail = "You have a new anonymous profile. See Settings to save your ID for recovery.",
                    Duration = 10000
                });
            }

            await LoadUserAlerts();
            
            objRef = DotNetObjectReference.Create(this);
            
            double initialLat = 0;
            double initialLng = 0;
            double? initialRadius = null;
            int? focusReportId = null;

            // Check query parameters
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);

            if (query.TryGetValue("reportId", out var reportIdStr) && int.TryParse(reportIdStr, out var rId))
            {
                focusReportId = rId;
            }

            if (query.TryGetValue("lat", out var latStr) && double.TryParse(latStr, CultureInfo.InvariantCulture, out var lat))
            {
                initialLat = lat;
            }
            if (query.TryGetValue("lng", out var lngStr) && double.TryParse(lngStr, CultureInfo.InvariantCulture, out var lng))
            {
                initialLng = lng;
            }
            if (query.TryGetValue("radius", out var radiusStr) && double.TryParse(radiusStr, CultureInfo.InvariantCulture, out var radius))
            {
                initialRadius = radius;
            }

            if (initialLat == 0 && initialLng == 0 && !focusReportId.HasValue)
            {
                try
                {
                    isGettingLocation = true;
                    StateHasChanged();
                    var position = await JSRuntime.InvokeAsync<GeolocationPosition>("getLocation");
                    initialLat = position.Coords.Latitude;
                    initialLng = position.Coords.Longitude;
                }
                catch (Exception)
                {
                    // Fallback to (0,0) if location access denied or fails
                }
                finally
                {
                    isGettingLocation = false;
                    StateHasChanged();
                }
            }

            await JSRuntime.InvokeVoidAsync("initHeatMap", "heatmap", initialLat, initialLng, reports, objRef, userAlerts);
            mapInitialized = true;

            if (focusReportId.HasValue)
            {
                await JSRuntime.InvokeVoidAsync("focusReport", focusReportId.Value);
            }
            else if (initialRadius.HasValue)
            {
                await JSRuntime.InvokeVoidAsync("setMapView", initialLat, initialLng, initialRadius.Value);
            }
        }
    }

    private async Task LoadReports()
    {
        reports = await LocationService.GetRecentReportsAsync(hoursBack);
        if (mapInitialized)
        {
            await JSRuntime.InvokeVoidAsync("updateHeatMap", reports);
        }
    }

    private async Task LoadUserAlerts()
    {
        if (!string.IsNullOrEmpty(userIdentifier))
        {
            userAlerts = await AlertService.GetActiveAlertsAsync(userIdentifier, onlyVerified: false);
            if (mapInitialized)
            {
                await JSRuntime.InvokeVoidAsync("updateAlerts", userAlerts);
            }
        }
    }

    private async Task OnSettingsClick()
    {
        var result = await DialogService.OpenAsync<SettingsDialog>("SETTINGS",
            new Dictionary<string, object> { { "HoursBack", hoursBack } },
            new DialogOptions { Width = "400px" });

        if (result != null)
        {
            hoursBack = (int)result;
            await LoadReports();
        }
    }

    private async Task OnHelpClick()
    {
        await DialogService.OpenAsync<HelpDialog>("HELP",
            null,
            new DialogOptions { Width = "500px" });
    }

    private async Task OnAlertsClick() => await ShowAlertsDialog();

    private async Task ShowAlertsDialog(double? lat = null, double? lng = null)
    {
        var parameters = new Dictionary<string, object>();
        try
        {
            if (lat.HasValue && lng.HasValue)
            {
                parameters.Add("InitialLat", lat.Value);
                parameters.Add("InitialLng", lng.Value);
                
                var mapState = await JSRuntime.InvokeAsync<MapState>("getMapState");
                if (mapState != null)
                {
                    parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
                }
            }
            else
            {
                var mapState = await JSRuntime.InvokeAsync<MapState>("getMapState");
                if (mapState != null)
                {
                    parameters.Add("InitialLat", mapState.Lat);
                    parameters.Add("InitialLng", mapState.Lng);
                    parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
                }
            }
        }
        catch (Exception)
        {
            // Ignore if map state cannot be retrieved
        }

        var result = await DialogService.OpenAsync<AlertsDialog>("ALERTS",
            parameters,
            new DialogOptions { Width = "500px" });

        await LoadUserAlerts();

        if (result is Alert alert)
        {
            await JSRuntime.InvokeVoidAsync("setMapView", alert.Latitude, alert.Longitude, alert.RadiusKm);
        }
    }

    private async Task OnDonateClick()
    {
        await DialogService.OpenAsync<DonateDialog>("DONATE",
            null,
            new DialogOptions { Width = "500px" });
    }

    private async Task OnReportClick()
    {
        isGettingLocation = true;
        StateHasChanged();
        try
        {
            var position = await JSRuntime.InvokeAsync<GeolocationPosition>("getLocation");
            var report = new LocationReport
            {
                Latitude = position.Coords.Latitude,
                Longitude = position.Coords.Longitude,
                ReporterIdentifier = userIdentifier,
                ReporterLatitude = position.Coords.Latitude,
                ReporterLongitude = position.Coords.Longitude
            };
            
            await ShowReportDialog(report);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to get location", ex.Message);
            // Fallback: show dialog without location? Or just let them try again.
        }
        finally
        {
            isGettingLocation = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnMapClick(double lat, double lng)
    {
        var zoom = await JSRuntime.InvokeAsync<double>("getZoomLevel");
        if (zoom >= 15) return;

        // Find reports within a certain radius (e.g. 5km)
        double searchRadiusKm = 5.0; 

        var nearbyReports = reports
            .Where(r => GeoUtils.CalculateDistance(lat, lng, r.Latitude, r.Longitude) <= searchRadiusKm)
            .OrderByDescending(r => r.Timestamp)
            .ToList();

        var nearbyAlerts = userAlerts
            .Where(a => GeoUtils.CalculateDistance(lat, lng, a.Latitude, a.Longitude) <= searchRadiusKm)
            .ToList();

        if (nearbyReports.Any() || nearbyAlerts.Any())
        {
            // Tapping on a blob reveals area details
            var result = await DialogService.OpenAsync<ReportDetailsDialog>("AREA DETAILS",
                new Dictionary<string, object> 
                { 
                    { "Reports", nearbyReports },
                    { "Alerts", nearbyAlerts }
                },
                new DialogOptions { Width = "500px" });

            if (result == true) // If an alert was deleted
            {
                await LoadUserAlerts();
            }
        }
        else
        {
            // Tapping on a non-blob area opens create alert
            await ShowAlertsDialog(lat, lng);
        }
    }

    [JSInvokable]
    public async Task OnMapContextMenu(double lat, double lng)
    {
        // Long-press/right click reveals create report
        // We need user's current location to verify distance
        isGettingLocation = true;
        StateHasChanged();
        try
        {
            var position = await JSRuntime.InvokeAsync<GeolocationPosition>("getLocation");
            var report = new LocationReport
            {
                Latitude = lat,
                Longitude = lng,
                ReporterIdentifier = userIdentifier,
                ReporterLatitude = position.Coords.Latitude,
                ReporterLongitude = position.Coords.Longitude
            };
            await ShowReportDialog(report);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to get your location", "We need your location to verify the report.");
        }
        finally
        {
            isGettingLocation = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnAlertDeleteClick(int alertId)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this alert zone?", "Delete Alert", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            await AlertService.DeactivateAlertAsync(alertId);
            NotificationService.Notify(NotificationSeverity.Success, "Alert deleted");
            await LoadUserAlerts();
        }
    }

    private async Task ShowReportDialog(LocationReport report)
    {
        var result = await DialogService.OpenAsync<ReportDialog>("REPORT LOCATION",
            new Dictionary<string, object> { { "report", report } },
            new DialogOptions { Width = "500px", Resizable = false, Draggable = true });

        if (result == true)
        {
            await LoadReports();
        }
    }

    public void Dispose()
    {
        LocationService.OnReportAdded -= HandleReportAdded;
        objRef?.Dispose();
    }

    public class GeolocationPosition
    {
        public GeolocationCoordinates Coords { get; set; } = new();
    }

    public class GeolocationCoordinates
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }
}
