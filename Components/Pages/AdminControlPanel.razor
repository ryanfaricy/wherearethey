@page "/cp"
@using WhereAreThey.Models
@using WhereAreThey.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ILocationService LocationService
@inject IAlertService AlertService
@inject IDonationService DonationService
@inject IFeedbackService FeedbackService
@inject IAdminService AdminService
@inject ISettingsService SettingsService
@inject ProtectedSessionStorage SessionStorage
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<AdminControlPanel> Logger
@inject UserTimeZoneService TimeZoneService
@inject UserConnectionService UserConnectionService
@implements IDisposable

<PageTitle>Admin Control Panel</PageTitle>

<div class="rz-p-4">
    @if (!_isAuthenticated)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 70vh;">
            <RadzenCard Style="width: 400px;">
                <RadzenText TextStyle="TextStyle.H5" Class="rz-mb-4">Admin Login</RadzenText>
                <RadzenStack Gap="1rem">
                    <RadzenFormField Text="Password">
                        <RadzenPassword @bind-Value="@_passwordInput" @onkeypress="@OnKeyPress" />
                    </RadzenFormField>
                    <RadzenButton Text="LOGIN" Click="@Login" ButtonStyle="ButtonStyle.Primary" />
                </RadzenStack>
            </RadzenCard>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center rz-mb-4">
            <RadzenText TextStyle="TextStyle.H4">Control Panel</RadzenText>
            <RadzenButton Text="LOGOUT" Click="@Logout" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" />
        </div>

        <RadzenTabs RenderMode="TabRenderMode.Client">
            <Tabs>
                <RadzenTabsItem Text="OVERVIEW" Icon="dashboard">
                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenCard Class="rz-variant-flat rz-background-color-primary-lighter">
                                <RadzenText TextStyle="TextStyle.Subtitle2">Connected Users</RadzenText>
                                <RadzenText TextStyle="TextStyle.H3">@UserConnectionService.ConnectionCount</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenCard Class="rz-variant-flat rz-background-color-info-lighter">
                                <RadzenText TextStyle="TextStyle.Subtitle2">Total Reports</RadzenText>
                                <RadzenText TextStyle="TextStyle.H3">@_reports.Count</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenCard Class="rz-variant-flat rz-background-color-warning-lighter">
                                <RadzenText TextStyle="TextStyle.Subtitle2">Active Alerts</RadzenText>
                                <RadzenText TextStyle="TextStyle.H3">@_alerts.Count(a => a.IsActive)</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow Class="rz-mt-4">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenCard Class="rz-variant-flat rz-background-color-success-lighter">
                                <RadzenText TextStyle="TextStyle.Subtitle2">Total Donations</RadzenText>
                                <RadzenText TextStyle="TextStyle.H3">@_donations.Count(d => d.Status == "succeeded" || d.Status == "completed")</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenCard Class="rz-variant-flat rz-background-color-secondary-lighter">
                                <RadzenText TextStyle="TextStyle.Subtitle2">Feedback Items</RadzenText>
                                <RadzenText TextStyle="TextStyle.H3">@_feedbacks.Count</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenText TextStyle="TextStyle.H6" Class="rz-mt-4 rz-mb-2">Recent Login Attempts</RadzenText>
                    <RadzenDataGrid Data="@_loginAttempts.Take(5)" TItem="AdminLoginAttempt">
                        <Columns>
                            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="Timestamp" Title="Time">
                                <Template Context="attempt">
                                    @TimeZoneService.FormatLocal(attempt.Timestamp, "g")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="IpAddress" Title="IP Address" />
                            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="IsSuccessful" Title="Status">
                                <Template Context="attempt">
                                    <RadzenBadge BadgeStyle="@(attempt.IsSuccessful ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                                 Text="@(attempt.IsSuccessful ? "SUCCESS" : "FAILED")" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenTabsItem>

                <RadzenTabsItem Text="REPORTS" Icon="report_problem">
                    <RadzenDataGrid Data="@_reports" TItem="LocationReport" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
                        <Columns>
                            <RadzenDataGridColumn TItem="LocationReport" Property="Id" Title="ID" Width="70px" />
                            <RadzenDataGridColumn TItem="LocationReport" Property="Timestamp" Title="Time">
                                <Template Context="report">
                                    @TimeZoneService.FormatLocal(report.Timestamp, "g")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="LocationReport" Property="Message" Title="Message" />
                            <RadzenDataGridColumn TItem="LocationReport" Property="ReporterIdentifier" Title="Reporter ID" />
                            <RadzenDataGridColumn TItem="LocationReport" Title="Reporter Location">
                                <Template Context="report">
                                    @(report.ReporterLatitude.HasValue ? $"{report.ReporterLatitude.Value:F4}, {report.ReporterLongitude.Value:F4}" : "N/A")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="LocationReport" Property="IsEmergency" Title="Emergency" Width="100px">
                                <Template Context="report">
                                    <RadzenBadge BadgeStyle="@(report.IsEmergency ? BadgeStyle.Danger : BadgeStyle.Secondary)" 
                                                 Text="@(report.IsEmergency ? "YES" : "NO")" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="LocationReport" Title="Location">
                                <Template Context="report">
                                    @report.Latitude.ToString("F4"), @report.Longitude.ToString("F4")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="LocationReport" Title="Actions" Width="100px" Filterable="false" Sortable="false">
                                <Template Context="report">
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                                  Click="@(() => DeleteReport(report.Id))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenTabsItem>

                <RadzenTabsItem Text="ALERTS" Icon="notifications">
                    <RadzenDataGrid Data="@_alerts" TItem="Alert" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
                        <Columns>
                            <RadzenDataGridColumn TItem="Alert" Property="Id" Title="ID" Width="70px" />
                            <RadzenDataGridColumn TItem="Alert" Title="Email">
                                <Template Context="alert">
                                    @AlertService.DecryptEmail(alert.EncryptedEmail)
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Alert" Property="IsVerified" Title="Verified" Width="100px">
                                <Template Context="alert">
                                    <RadzenBadge BadgeStyle="@(alert.IsVerified ? BadgeStyle.Success : BadgeStyle.Warning)" 
                                                 Text="@(alert.IsVerified ? "YES" : "NO")" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Alert" Property="IsActive" Title="Active" Width="100px">
                                <Template Context="alert">
                                    <RadzenBadge BadgeStyle="@(alert.IsActive ? BadgeStyle.Info : BadgeStyle.Secondary)" 
                                                 Text="@(alert.IsActive ? "ACTIVE" : "OFF")" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Alert" Property="RadiusKm" Title="Radius (km)" Width="100px" />
                            <RadzenDataGridColumn TItem="Alert" Title="Actions" Width="100px" Filterable="false" Sortable="false">
                                <Template Context="alert">
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                                  Click="@(() => DeleteAlert(alert.Id))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenTabsItem>

                <RadzenTabsItem Text="DONATIONS" Icon="volunteer_activism">
                    <RadzenDataGrid Data="@_donations" TItem="Donation" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
                        <Columns>
                            <RadzenDataGridColumn TItem="Donation" Property="CreatedAt" Title="Date">
                                <Template Context="donation">
                                    @TimeZoneService.FormatLocal(donation.CreatedAt, "g")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Donation" Property="DonorEmail" Title="Donor" />
                            <RadzenDataGridColumn TItem="Donation" Property="Amount" Title="Amount">
                                <Template Context="donation">
                                    @donation.Amount @donation.Currency.ToUpper()
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Donation" Property="Status" Title="Status">
                                <Template Context="donation">
                                    <RadzenBadge BadgeStyle="@(donation.Status == "succeeded" || donation.Status == "completed" ? BadgeStyle.Success : BadgeStyle.Secondary)" 
                                                 Text="@donation.Status" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenTabsItem>

                <RadzenTabsItem Text="FEEDBACK" Icon="chat">
                    <RadzenDataGrid Data="@_feedbacks" TItem="Feedback" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
                        <Columns>
                            <RadzenDataGridColumn TItem="Feedback" Property="Id" Title="ID" Width="70px" />
                            <RadzenDataGridColumn TItem="Feedback" Property="Timestamp" Title="Time">
                                <Template Context="feedback">
                                    @TimeZoneService.FormatLocal(feedback.Timestamp, "g")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Feedback" Property="Type" Title="Type" Width="100px">
                                <Template Context="fb">
                                    <RadzenBadge BadgeStyle="@(fb.Type == "Bug" ? BadgeStyle.Danger : BadgeStyle.Info)" Text="@fb.Type" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="Feedback" Property="Message" Title="Message" />
                            <RadzenDataGridColumn TItem="Feedback" Property="UserIdentifier" Title="User ID" />
                            <RadzenDataGridColumn TItem="Feedback" Title="Actions" Width="100px" Filterable="false" Sortable="false">
                                <Template Context="fb">
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                                  Click="@(() => DeleteFeedback(fb.Id))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenTabsItem>

                <RadzenTabsItem Text="LOGINS" Icon="security">
                    <RadzenDataGrid Data="@_loginAttempts" TItem="AdminLoginAttempt" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
                        <Columns>
                            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="Timestamp" Title="Time">
                                <Template Context="attempt">
                                    @TimeZoneService.FormatLocal(attempt.Timestamp, "g")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="IpAddress" Title="IP Address" />
                            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="IsSuccessful" Title="Status">
                                <Template Context="attempt">
                                    <RadzenBadge BadgeStyle="@(attempt.IsSuccessful ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                                 Text="@(attempt.IsSuccessful ? "SUCCESS" : "FAILED")" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenTabsItem>

                <RadzenTabsItem Text="SETTINGS" Icon="settings">
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-4">Global Anti-Spam Settings</RadzenText>
                        <RadzenStack Gap="1.5rem" Style="max-width: 500px;">
                            <RadzenFormField Text="Report Expiry (Hours)" Variant="Variant.Outlined">
                                <RadzenNumeric @bind-Value="@_systemSettings.ReportExpiryHours" TValue="int" Min="1" Max="168" />
                                <RadzenText TextStyle="TextStyle.Caption">Reports disappear from public view after this many hours.</RadzenText>
                            </RadzenFormField>

                            <RadzenFormField Text="Submission Cooldown (Minutes)" Variant="Variant.Outlined">
                                <RadzenNumeric @bind-Value="@_systemSettings.ReportCooldownMinutes" TValue="int" Min="1" Max="60" />
                                <RadzenText TextStyle="TextStyle.Caption">Time users must wait between submitting reports or feedback.</RadzenText>
                            </RadzenFormField>

                            <RadzenFormField Text="Alert Creation Limit" Variant="Variant.Outlined">
                                <RadzenNumeric @bind-Value="@_systemSettings.AlertLimitCount" TValue="int" Min="1" Max="100" />
                                <RadzenText TextStyle="TextStyle.Caption">Number of alerts a user can create within the cooldown period.</RadzenText>
                            </RadzenFormField>

                            <RadzenFormField Text="Max Report Distance (Miles)" Variant="Variant.Outlined">
                                <RadzenNumeric @bind-Value="@_systemSettings.MaxReportDistanceMiles" TValue="decimal" Min="0.1m" Max="100.0m" />
                                <RadzenText TextStyle="TextStyle.Caption">Users must be within this distance of the reported location.</RadzenText>
                            </RadzenFormField>

                            <RadzenFormField Text="Mapbox Token (Optional)" Variant="Variant.Outlined">
                                <RadzenTextBox @bind-Value="@_systemSettings.MapboxToken" />
                                <RadzenText TextStyle="TextStyle.Caption">Required for map thumbnails in alert emails. Leave empty to disable thumbnails.</RadzenText>
                            </RadzenFormField>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenSwitch @bind-Value="@_systemSettings.DonationsEnabled" />
                                <RadzenLabel Text="Enable Public Donations" />
                            </RadzenStack>

                            <RadzenButton Text="SAVE SETTINGS" Click="@SaveSettings" ButtonStyle="ButtonStyle.Primary" Icon="save" />
                        </RadzenStack>
                    </RadzenCard>
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>
    }
</div>

@code {
    private bool _isAuthenticated = false;
    private string _passwordInput = "";
    private List<LocationReport> _reports = new();
    private List<Alert> _alerts = new();
    private List<Donation> _donations = new();
    private List<Feedback> _feedbacks = new();
    private List<AdminLoginAttempt> _loginAttempts = new();
    private SystemSettings _systemSettings = new();
    private string? _clientIp;

    protected override void OnInitialized()
    {
        _clientIp = HttpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString();
        UserConnectionService.OnConnectionCountChanged += HandleConnectionCountChanged;
    }

    private void HandleConnectionCountChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        UserConnectionService.OnConnectionCountChanged -= HandleConnectionCountChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var result = await SessionStorage.GetAsync<bool>("isAdmin");
            if (result.Success && result.Value)
            {
                _isAuthenticated = true;
                await LoadData();
                StateHasChanged();
            }
        }
    }

    private async Task Login()
    {
        try
        {
            if (await AdminService.LoginAsync(_passwordInput, _clientIp))
            {
                _isAuthenticated = true;
                await SessionStorage.SetAsync("isAdmin", true);
                await LoadData();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Invalid password");
                await LoadData(); // Refresh login attempts list
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin login failed for IP {ClientIp}", _clientIp);
            NotificationService.Notify(NotificationSeverity.Error, "Login failed", ex.Message);
            await LoadData();
        }
    }

    private async Task Logout()
    {
        _isAuthenticated = false;
        _passwordInput = "";
        await SessionStorage.DeleteAsync("isAdmin");
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Login();
        }
    }

    private async Task LoadData()
    {
        try
        {
            _reports = await LocationService.GetAllReportsAsync();
            _alerts = await AlertService.GetAllAlertsAdminAsync();
            _donations = await DonationService.GetAllDonationsAsync();
            _feedbacks = await FeedbackService.GetAllFeedbackAsync();
            _systemSettings = await SettingsService.GetSettingsAsync();
            _loginAttempts = await AdminService.GetRecentLoginAttemptsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading admin data");
            NotificationService.Notify(NotificationSeverity.Error, "Data load failed", ex.Message);
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            await SettingsService.UpdateSettingsAsync(_systemSettings);
            NotificationService.Notify(NotificationSeverity.Success, "Settings saved successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save settings");
            NotificationService.Notify(NotificationSeverity.Error, "Save failed", ex.Message);
        }
    }

    private async Task DeleteReport(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this report?", "Delete Report", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
        
        if (confirm == true)
        {
            try
            {
                await LocationService.DeleteReportAsync(id);
                await LoadData();
                NotificationService.Notify(NotificationSeverity.Success, "Report deleted");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete report {ReportId}", id);
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", ex.Message);
            }
        }
    }

    private async Task DeleteAlert(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this alert? This cannot be undone.", "Delete Alert", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirm == true)
        {
            try
            {
                await AlertService.DeleteAlertAsync(id);
                await LoadData();
                NotificationService.Notify(NotificationSeverity.Success, "Alert deleted");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete alert {AlertId}", id);
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", ex.Message);
            }
        }
    }
    private async Task DeleteFeedback(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this feedback?", "Delete Feedback", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
        
        if (confirm == true)
        {
            try
            {
                await FeedbackService.DeleteFeedbackAsync(id);
                await LoadData();
                NotificationService.Notify(NotificationSeverity.Success, "Feedback deleted");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete feedback {FeedbackId}", id);
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", ex.Message);
            }
        }
    }
}
