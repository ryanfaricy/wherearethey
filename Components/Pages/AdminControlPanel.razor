@page "/cp"
@inject IAdminService AdminService
@inject IAdminPasskeyService PasskeyService
@inject ProtectedSessionStorage SessionStorage
@inject ProtectedLocalStorage LocalStorage
@inject NotificationService NotificationService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<AdminControlPanel> Logger
@inject IEventService EventService
@inject IJSRuntime JsRuntime
@using System.Text.Json
@using Fido2NetLib
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using WhereAreThey.Components.Admin
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@implements IDisposable

<PageTitle>Admin Control Panel</PageTitle>

<div class="rz-p-2 rz-p-md-4">
    @if (!_isAuthenticated)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 70vh;">
            <RadzenCard Style="max-width: 400px; width: 100%;">
                <RadzenText TextStyle="TextStyle.H5" Class="rz-mb-4">Admin Login</RadzenText>
                <RadzenStack Gap="1rem">
                    <RadzenFormField Text="Password">
                        <RadzenPassword @bind-Value="@_passwordInput" @onkeypress="@OnKeyPress" />
                    </RadzenFormField>
                    <RadzenButton Text="LOGIN" Click="@Login" ButtonStyle="ButtonStyle.Primary" />
                    
                    <RadzenText TextStyle="TextStyle.Caption" TextAlign="TextAlign.Center" Class="rz-my-2">OR</RadzenText>
                    
                    <RadzenButton Text="LOGIN WITH PASSKEY" Icon="fingerprint" Click="@LoginWithPasskey" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined" />
                </RadzenStack>
            </RadzenCard>
        </RadzenStack>
    }
    else
    {
        <RadzenMediaQuery Query="(max-width: 768px)" Change=@(args => _isMobile = args) />
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-4">
            <RadzenText TextStyle="@(_isMobile ? TextStyle.H5 : TextStyle.H4)">Control Panel</RadzenText>
            <RadzenButton Text="LOGOUT" Click="@Logout" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" />
        </RadzenStack>

        <RadzenTabs RenderMode="TabRenderMode.Client">
            <Tabs>
                <RadzenTabsItem Text="@(_isMobile ? "" : "REAL-TIME")" Icon="bolt">
                    <AdminMapFeed />
                </RadzenTabsItem>
                <RadzenTabsItem Text="@(_isMobile ? "" : "OVERVIEW")" Icon="dashboard">
                    <AdminOverviewTab IsMobile="@_isMobile" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="@(_isMobile ? "" : "REPORTS")" Icon="report_problem">
                    <AdminReportsTab IsMobile="@_isMobile" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="@(_isMobile ? "" : "ALERTS")" Icon="notifications">
                    <AdminAlertsTab IsMobile="@_isMobile" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="@(_isMobile ? "" : "DONATIONS")" Icon="volunteer_activism">
                    <AdminDonationsTab IsMobile="@_isMobile" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="@(_isMobile ? "" : "FEEDBACK")" Icon="chat">
                    <AdminFeedbackTab IsMobile="@_isMobile" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="@(_isMobile ? "" : "LOGINS")" Icon="security">
                    <AdminLoginsTab IsMobile="@_isMobile" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="@(_isMobile ? "" : "SETTINGS")" Icon="settings">
                    <AdminSettingsTab />
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>
    }
</div>

@code {
    private bool _isMobile;
    private bool _isAuthenticated;
    private string _passwordInput = "";
    private string? _clientIp;
    private bool _disposed;
    private IJSObjectReference? _module;

    protected override void OnInitialized()
    {
        _clientIp = HttpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.ToString();
        
        EventService.OnReportAdded += HandleReportAdded;
        EventService.OnFeedbackAdded += HandleFeedbackAdded;
        EventService.OnDonationAdded += HandleDonationAdded;
        EventService.OnAdminLoginAttempt += HandleAdminLoginAttempt;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./passkey.js");

            try
            {
                var result = await SessionStorage.GetAsync<bool>("isAdmin");
                if (result is { Success: true, Value: true })
                {
                    _isAuthenticated = true;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to read from session storage");
            }
        }
    }

    private async Task Login()
    {
        try
        {
            if (await AdminService.LoginAsync(_passwordInput, _clientIp))
            {
                _isAuthenticated = true;
                await SessionStorage.SetAsync("isAdmin", true);
                await LocalStorage.SetAsync("lastAdminLogin", DateTime.UtcNow);
                AdminService.NotifyAdminLogin();
                NotificationService.Notify(NotificationSeverity.Success, "Login successful");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Login failed", "Invalid password");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin login failed for IP {ClientIp}", _clientIp);
            NotificationService.Notify(NotificationSeverity.Error, "Login failed", ex.Message);
        }
    }

    private async Task LoginWithPasskey()
    {
        if (_module == null)
        {
            return;
        }

        try
        {
            var options = await PasskeyService.GetAssertionOptionsAsync();
            var jsonOptions = options.ToJson();

            var responseJson = await _module.InvokeAsync<string>("loginWithPasskey", jsonOptions);
            var assertionRawResponse = JsonSerializer.Deserialize<AuthenticatorAssertionRawResponse>(responseJson);

            if (assertionRawResponse == null)
            {
                throw new Exception("Failed to parse authenticator response");
            }

            if (await PasskeyService.CompleteAssertionAsync(assertionRawResponse, options, _clientIp))
            {
                _isAuthenticated = true;
                await SessionStorage.SetAsync("isAdmin", true);
                await LocalStorage.SetAsync("lastAdminLogin", DateTime.UtcNow);
                AdminService.NotifyAdminLogin();
                NotificationService.Notify(NotificationSeverity.Success, "Login successful");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Login failed", "Invalid passkey");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin passkey login failed for IP {ClientIp}", _clientIp);
            NotificationService.Notify(NotificationSeverity.Error, "Login failed", ex.Message);
        }
    }

    private async Task Logout()
    {
        _isAuthenticated = false;
        _passwordInput = "";
        await SessionStorage.DeleteAsync("isAdmin");
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Login();
        }
    }

    private void HandleReportAdded(LocationReport report)
    {
        if (!_isAuthenticated)
        {
            return;
        }

        InvokeAsync(() => {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = report.IsEmergency ? NotificationSeverity.Error : NotificationSeverity.Info,
                Summary = report.IsEmergency ? "ðŸš¨ EMERGENCY REPORT" : "New Report",
                Detail = report.Message ?? "Report received",
                Duration = report.IsEmergency ? 15000 : 5000
            });
        });
    }

    private void HandleFeedbackAdded(Feedback feedback)
    {
        if (!_isAuthenticated)
        {
            return;
        }

        InvokeAsync(() => {
            NotificationService.Notify(NotificationSeverity.Info, "New Feedback", feedback.Type, 5000);
        });
    }

    private void HandleDonationAdded(Donation donation)
    {
        if (!_isAuthenticated)
        {
            return;
        }

        InvokeAsync(() => {
            NotificationService.Notify(NotificationSeverity.Success, "New Donation Received", $"{donation.Amount} {donation.Currency}", 7000);
        });
    }

    private void HandleAdminLoginAttempt(AdminLoginAttempt attempt)
    {
        if (!_isAuthenticated)
        {
            return;
        }

        InvokeAsync(() => {
            if (!attempt.IsSuccessful)
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Security Alert", $"Failed login attempt from {attempt.IpAddress}", 7000);
            }
        });
    }

    public void Dispose()
    {
        if (_disposed)
        {
            return;
        }

        _disposed = true;
        EventService.OnReportAdded -= HandleReportAdded;
        EventService.OnFeedbackAdded -= HandleFeedbackAdded;
        EventService.OnDonationAdded -= HandleDonationAdded;
        EventService.OnAdminLoginAttempt -= HandleAdminLoginAttempt;
    }
}
