@using WhereAreThey.Models
@using WhereAreThey.Services
@inject AlertService AlertService
@inject NotificationService NotificationService
@inject DialogService DialogService

<RadzenStack Gap="1.5rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">Distance-Based Alerts</RadzenText>
    
    <RadzenTabs RenderMode="TabRenderMode.Client">
        <Tabs>
            <RadzenTabsItem Text="Create New">
                <RadzenTemplateForm Data="@newAlert" Submit="@((Alert args) => CreateAlert())">
                    <RadzenStack Gap="1rem">
                        <div class="row">
                            <div class="col-6">
                                <RadzenFormField Text="Latitude" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="@newAlert.Latitude" TValue="double" 
                                                   ShowUpDown="false" Style="width: 100%;" />
                                </RadzenFormField>
                            </div>
                            <div class="col-6">
                                <RadzenFormField Text="Longitude" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="@newAlert.Longitude" TValue="double" 
                                                   ShowUpDown="false" Style="width: 100%;" />
                                </RadzenFormField>
                            </div>
                        </div>

                        <RadzenFormField Text="Radius (km)" Variant="Variant.Outlined">
                            <RadzenNumeric @bind-Value="@newAlert.RadiusKm" TValue="double" 
                                           Min="0.1m" Max="100m" ShowUpDown="true" 
                                           Step="0.5m" Style="width: 100%;" />
                        </RadzenFormField>

                        <RadzenFormField Text="Alert Message" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="@newAlert.Message" Style="width: 100%;" 
                                           Placeholder="e.g., Reports near home" />
                        </RadzenFormField>

                        <RadzenFormField Text="Email for Alerts" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="@email" Style="width: 100%;" 
                                           Placeholder="your@email.com" />
                            <RadzenText TextStyle="TextStyle.Caption" Class="rz-color-info mt-1">
                                Stored encrypted at rest.
                            </RadzenText>
                        </RadzenFormField>

                        <RadzenButton ButtonType="ButtonType.Submit" Text="CREATE ALERT" 
                                      Icon="add_alert" ButtonStyle="ButtonStyle.Primary" 
                                      Style="width: 100%;" Disabled="@isSubmitting" />
                    </RadzenStack>
                </RadzenTemplateForm>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Active Alerts">
                @if (activeAlerts.Any())
                {
                    <RadzenDataList Data="@activeAlerts" TItem="Alert" AllowPaging="true" PageSize="3">
                        <Template Context="alert">
                            <RadzenCard Class="rz-mb-2 rz-p-2">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenStack Gap="0">
                                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin-bottom: 0;">@alert.Message</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption">@alert.RadiusKm km around @alert.Latitude.ToString("F2"), @alert.Longitude.ToString("F2")</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption">@MaskEmail(AlertService.DecryptEmail(alert.EncryptedEmail))</RadzenText>
                                    </RadzenStack>
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Variant="Variant.Flat"
                                                  Click="@(() => DeactivateAlert(alert.Id))" />
                                </RadzenStack>
                            </RadzenCard>
                        </Template>
                    </RadzenDataList>
                }
                else
                {
                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-p-4 text-center opacity-75">No active alerts.</RadzenText>
                }
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <RadzenButton Text="CLOSE" Click="@(() => DialogService.Close())" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>
</RadzenStack>

@code {
    private Alert newAlert = new Alert { RadiusKm = 5.0 };
    private string email = "";
    private List<Alert> activeAlerts = new();
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadAlerts();
    }

    private async Task CreateAlert()
    {
        if (string.IsNullOrWhiteSpace(email))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Email is required");
            return;
        }

        isSubmitting = true;
        try
        {
            await AlertService.CreateAlertAsync(newAlert, email);
            NotificationService.Notify(NotificationSeverity.Success, "Alert created successfully");
            
            newAlert = new Alert { RadiusKm = 5.0 };
            email = "";
            await LoadAlerts();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to create alert", ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task DeactivateAlert(int id)
    {
        try
        {
            await AlertService.DeactivateAlertAsync(id);
            NotificationService.Notify(NotificationSeverity.Success, "Alert deactivated");
            await LoadAlerts();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to deactivate alert", ex.Message);
        }
    }

    private async Task LoadAlerts()
    {
        activeAlerts = await AlertService.GetActiveAlertsAsync();
    }

    private string MaskEmail(string? email)
    {
        if (string.IsNullOrEmpty(email)) return "Unknown";
        var parts = email.Split('@');
        if (parts.Length != 2) return "****";
        var name = parts[0];
        var domain = parts[1];
        if (name.Length <= 2) return "**@" + domain;
        return name.Substring(0, 2) + "****@" + domain;
    }
}
