@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IAlertService AlertService
@inject IValidationService ValidationService
@inject IGeocodingService GeocodingService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IHapticFeedbackService HapticFeedbackService
@inject IJSRuntime JsRuntime
@inject IClientStorageService StorageService
@inject IPwaService PwaService
@inject ISettingsService SettingsService
@inject ILogger<AlertsDialog> Logger
@inject IStringLocalizer<App> L
<RadzenMediaQuery Query="(max-width: 768px)" Change="@(args => _isMobile = args)" />

<RadzenStack Gap="1.5rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">@L["Distance_Based_Alerts"]</RadzenText>
    
    <RadzenTabs RenderMode="TabRenderMode.Client" @bind-SelectedIndex="_selectedTabIndex">
        <Tabs>
            <RadzenTabsItem Text="@L["Create_New"]">
                <RadzenTemplateForm Data="@_newAlert" Submit="@((Alert _) => CreateAlert())">
                    <RadzenStack Gap="1rem">
                        <RadzenFormField Text="@L["Search_Address"]" Variant="Variant.Outlined" Style="width: 100%;">
                            <AddressSearch @bind-SearchValue="@_approxAddress" 
                                           OnResultSelected="@OnAddressResultSelected"
                                           Placeholder="@L["Search_Address_Placeholder"]" 
                                           CustomStyle="width: 100%;"
                                           InputType="search" />
                        </RadzenFormField>

                        <RadzenRow Gap="1rem">
                            <RadzenColumn Size="12" SizeSM="6">
                                <RadzenFormField Text="@L["Latitude"]" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="@_newAlert.Latitude" TValue="double" 
                                                   ShowUpDown="false" Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeSM="6">
                                <RadzenFormField Text="@L["Longitude"]" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="@_newAlert.Longitude" TValue="double" 
                                                   ShowUpDown="false" Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenFormField Text="@L["Radius_Km"]" Variant="Variant.Outlined" Component="RadiusKm" Style="width: 100%;">
                            <ChildContent>
                                <RadzenNumeric Name="RadiusKm" @bind-Value="@_newAlert.RadiusKm" TValue="double" 
                                               Min="0.1m" Max="160.9m" ShowUpDown="true" 
                                               Step="0.5m" Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                <RadzenNumericRangeValidator Component="RadiusKm" Min="0.1" Max="160.9" Text="@L["Radius_Range_Error"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenFormField Text="@L["Alert_Message"]" Variant="Variant.Outlined" Component="AlertMessage" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="AlertMessage" @bind-Value="@_newAlert.Message" Style="width: 100%;" 
                                               Placeholder="@L["Alert_Message_Placeholder"]" MaxLength="100" />
                            </ChildContent>
                            <Helper>
                                <RadzenLengthValidator Component="AlertMessage" Max="100" Text="@L["Message_Too_Long"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" Class="rz-mb-2">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenSwitch @bind-Value="@_newAlert.UseEmail" Name="UseEmail" />
                                <RadzenLabel Text="@L["Send_Email_Notification"]" Component="UseEmail" />
                            </RadzenStack>

                            <RadzenFormField Text="@L["Email_for_Alerts"]" Variant="Variant.Outlined" Component="Email" Style="width: 100%;" Visible="@_newAlert.UseEmail">
                                <ChildContent>
                                    <RadzenTextBox Name="Email" @bind-Value="@_email" Style="width: 100%;" 
                                                   Placeholder="your@email.com" />
                                </ChildContent>
                                <Helper>
                                    <RadzenRequiredValidator Component="Email" Text="@L["Email_Required"]" 
                                                             Visible="@_newAlert.UseEmail" />
                                    <RadzenEmailValidator Component="Email" Text="@L["Invalid_Email"]" 
                                                          Visible="@(_newAlert.UseEmail && !string.IsNullOrEmpty(_email))" />
                                </Helper>
                            </RadzenFormField>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenSwitch @bind-Value="@_newAlert.UsePush" Name="UsePush" Disabled="@(!_isSubscribedToPush)" />
                                <RadzenLabel Text="@L["Send_Push_Notification"]" Component="UsePush" />
                                @if (!_isSubscribedToPush && _isPushSupported)
                                {
                                    <RadzenButton Text="@L["Enable_Browser_Push"]" Size="ButtonSize.ExtraSmall" Click="@SubscribeToPush" 
                                                  ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" />
                                }
                            </RadzenStack>
                            @if (!_isPushSupported)
                            {
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">
                                    <RadzenIcon Icon="info" Size="12px" Style="vertical-align: middle;" /> @L["Browser_Push_Unsupported"]
                                </RadzenText>
                            }
                        </RadzenStack>

                        <RadzenButton ButtonType="ButtonType.Submit" Text="@L["CREATE_ALERT"]" 
                                      Icon="add_alert" ButtonStyle="ButtonStyle.Primary" 
                                      Style="width: 100%;" IsBusy="@_isSubmitting" />
                    </RadzenStack>
                </RadzenTemplateForm>
            </RadzenTabsItem>
            <RadzenTabsItem Text="@L["Active_Alerts"]">
                @if (_activeAlerts.Any())
                {
                    <RadzenDataList @ref="_dataList" Data="@_activeAlerts" TItem="Alert" AllowPaging="true" PageSize="3">
                        <Template Context="alert">
                            <AlertCard Alert="@alert" 
                                       IsSelected="@(alert.Id == SelectedAlertId)"
                                       IsMobile="@_isMobile"
                                       OnShowOnMap="@(() => ShowOnMap(alert))"
                                       OnDeactivate="@(() => DeactivateAlert(alert.Id))" />
                        </Template>
                    </RadzenDataList>
                }
                else
                {
                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-p-4 text-center opacity-75">@L["No_active_alerts"]</RadzenText>
                }
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <RadzenButton Text="@L["CLOSE"]" Click="@(() => DialogService.Close())" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>
</RadzenStack>

@code {
    private bool _isMobile;
    private int _selectedTabIndex;
    [Parameter] public double? InitialLat { get; set; }
    [Parameter] public double? InitialLng { get; set; }
    [Parameter] public double? InitialRadius { get; set; }
    [Parameter] public int? SelectedAlertId { get; set; }

    private Alert _newAlert = new() { RadiusKm = 5.0 };
    private string _email = "";
    private List<Alert> _activeAlerts = [];
    private RadzenDataList<Alert> _dataList;
    private bool _isSubmitting;
    private string? _userIdentifier;
    private string? _approxAddress;
    private bool _isPushSupported = true;
    private bool _isSubscribedToPush;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (SelectedAlertId.HasValue)
            {
                _selectedTabIndex = 1;
            }

            _userIdentifier = await StorageService.GetUserIdentifierAsync();
            
            var lastEmail = await StorageService.GetItemAsync("last-alert-email");
            if (!string.IsNullOrEmpty(lastEmail) && string.IsNullOrEmpty(_email))
            {
                _email = lastEmail;
            }

            if (InitialLat.HasValue)
            {
                _newAlert.Latitude = InitialLat.Value;
            }

            if (InitialLng.HasValue)
            {
                _newAlert.Longitude = InitialLng.Value;
            }

            if (InitialRadius.HasValue)
            {
                _newAlert.RadiusKm = Math.Min(InitialRadius.Value, 160.9);
            }

            if (InitialLat.HasValue && InitialLng.HasValue)
            {
                _approxAddress = await GeocodingService.ReverseGeocodeAsync(InitialLat.Value, InitialLng.Value);
            }
            
            await LoadAlerts();
            await CheckPushStatus();

            if (SelectedAlertId.HasValue && _dataList != null)
            {
                var index = _activeAlerts.FindIndex(a => a.Id == SelectedAlertId.Value);
                if (index >= 0)
                {
                    var page = index / 3;
                    if (page > 0)
                    {
                        await _dataList.GoToPage(page);
                    }
                    await Task.Delay(100);
                    await JsRuntime.InvokeVoidAsync("scrollToElement", "selected-alert-card");
                }
            }

            StateHasChanged();
        }
    }

    private async Task CheckPushStatus()
    {
        try
        {
            var subscription = await PwaService.GetPushSubscriptionAsync();
            _isSubscribedToPush = subscription != null;
            if (_isSubscribedToPush && subscription != null)
            {
                _newAlert.UsePush = true;

                // Sync subscription with server to ensure it exists in DB
                var webPushSub = new WebPushSubscription
                {
                    UserIdentifier = _userIdentifier ?? "unknown",
                    Endpoint = subscription.Endpoint,
                    P256DH = subscription.Keys.P256DH,
                    Auth = subscription.Keys.Auth,
                };
                await AlertService.AddPushSubscriptionAsync(webPushSub);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Push notifications not supported or error checking status");
            _isPushSupported = false;
        }
    }

    private async Task SubscribeToPush()
    {
        try
        {
            var permission = await PwaService.RequestPushPermissionAsync();
            if (permission == "granted")
            {
                var settings = await SettingsService.GetSettingsAsync();
                if (string.IsNullOrEmpty(settings.VapidPublicKey))
                {
                    NotificationService.Notify(NotificationSeverity.Warning, L["Notifications"], "Push server not configured.");
                    return;
                }

                var subscription = await PwaService.SubscribeUserAsync(settings.VapidPublicKey);
                if (subscription != null)
                {
                    var webPushSub = new WebPushSubscription
                    {
                        UserIdentifier = _userIdentifier ?? "unknown",
                        Endpoint = subscription.Endpoint,
                        P256DH = subscription.Keys.P256DH,
                        Auth = subscription.Keys.Auth,
                    };

                    var result = await AlertService.AddPushSubscriptionAsync(webPushSub);
                    if (result.IsSuccess)
                    {
                        _isSubscribedToPush = true;
                        _newAlert.UsePush = true;
                        NotificationService.Notify(NotificationSeverity.Success, L["Notifications"], L["Push_Subscribed_Success"]);
                        await HapticFeedbackService.VibrateSuccessAsync();
                    }
                    else
                    {
                        NotificationService.Notify(NotificationSeverity.Error, L["Notifications"], "Failed to save subscription: " + result.Error);
                    }
                }
            }
            else if (permission == "denied")
            {
                NotificationService.Notify(NotificationSeverity.Error, L["Notifications"], L["Push_Permission_Denied"]);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error subscribing to push");
            NotificationService.Notify(NotificationSeverity.Error, L["Notifications"], "An error occurred.");
        }
    }

    private void OnAddressResultSelected(GeocodingResult result)
    {
        _newAlert.Latitude = result.Latitude;
        _newAlert.Longitude = result.Longitude;
    }

    private async Task CreateAlert()
    {
        if (_isSubmitting) return;

        if (!_newAlert.UseEmail && !_newAlert.UsePush)
        {
            NotificationService.Notify(NotificationSeverity.Warning, L["Notifications"], L["Select_At_Least_One_Notification"]);
            return;
        }

        _isSubmitting = true;
        _newAlert.UserIdentifier = _userIdentifier;

        await ValidationService.ExecuteAsync(
            async () => await AlertService.CreateAlertAsync(_newAlert, _newAlert.UseEmail ? _email : ""),
            successMessage: "Alert created successfully",
            errorTitle: "Failed to create alert",
            onSuccess: async (alert) =>
            {
                await StorageService.SetItemAsync("last-alert-email", _email);
                _newAlert = new Alert { RadiusKm = 5.0, UserIdentifier = _userIdentifier };
                _email = "";
                await LoadAlerts();
                DialogService.Close(true);
            },
            logContext: $"CreateAlert for email {_email}"
        );

        _isSubmitting = false;
    }

    private async Task DeactivateAlert(int id)
    {
        await ValidationService.ExecuteAsync(
            () => AlertService.DeleteAlertAsync(id),
            successMessage: "Alert deleted",
            errorTitle: "Failed to delete alert",
            onSuccess: async () => await LoadAlerts(),
            logContext: $"DeactivateAlert {id}"
        );
    }

    private void ShowOnMap(Alert alert)
    {
        DialogService.Close(alert);
    }

    private async Task LoadAlerts()
    {
        _activeAlerts = await AlertService.GetActiveAlertsAsync(_userIdentifier, onlyVerified: false);
    }

}
