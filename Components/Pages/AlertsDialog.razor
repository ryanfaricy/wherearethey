@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IAlertService AlertService
@inject IGeocodingService GeocodingService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IHapticFeedbackService HapticFeedbackService
@inject IJSRuntime JsRuntime
@inject IClientStorageService StorageService
@inject ILogger<AlertsDialog> Logger
@inject IStringLocalizer<App> L
<RadzenMediaQuery Query="(max-width: 768px)" Change="@(args => _isMobile = args)" />

<RadzenStack Gap="1.5rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">@L["Distance_Based_Alerts"]</RadzenText>
    
    <RadzenTabs RenderMode="TabRenderMode.Client" @bind-SelectedIndex="_selectedTabIndex">
        <Tabs>
            <RadzenTabsItem Text="@L["Create_New"]">
                <RadzenTemplateForm Data="@_newAlert" Submit="@((Alert _) => CreateAlert())">
                    <RadzenStack Gap="1rem">
                        <RadzenFormField Text="@L["Search_Address"]" Variant="Variant.Outlined" Style="width: 100%;">
                            <AddressSearch @bind-SearchValue="@_approxAddress" 
                                           OnResultSelected="@OnAddressResultSelected"
                                           Placeholder="@L["Search_Address_Placeholder"]" 
                                           CustomStyle="width: 100%;"
                                           InputType="search" />
                        </RadzenFormField>

                        <RadzenRow Gap="1rem">
                            <RadzenColumn Size="12" SizeSM="6">
                                <RadzenFormField Text="@L["Latitude"]" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="@_newAlert.Latitude" TValue="double" 
                                                   ShowUpDown="false" Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeSM="6">
                                <RadzenFormField Text="@L["Longitude"]" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="@_newAlert.Longitude" TValue="double" 
                                                   ShowUpDown="false" Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenFormField Text="@L["Radius_Km"]" Variant="Variant.Outlined" Component="RadiusKm" Style="width: 100%;">
                            <ChildContent>
                                <RadzenNumeric Name="RadiusKm" @bind-Value="@_newAlert.RadiusKm" TValue="double" 
                                               Min="0.1m" Max="160.9m" ShowUpDown="true" 
                                               Step="0.5m" Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                <RadzenNumericRangeValidator Component="RadiusKm" Min="0.1" Max="160.9" Text="@L["Radius_Range_Error"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenFormField Text="@L["Alert_Message"]" Variant="Variant.Outlined" Component="AlertMessage" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="AlertMessage" @bind-Value="@_newAlert.Message" Style="width: 100%;" 
                                               Placeholder="@L["Alert_Message_Placeholder"]" MaxLength="100" />
                            </ChildContent>
                            <Helper>
                                <RadzenLengthValidator Component="AlertMessage" Max="100" Text="@L["Message_Too_Long"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenFormField Text="@L["Email_for_Alerts"]" Variant="Variant.Outlined" Component="Email" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="Email" @bind-Value="@_email" Style="width: 100%;" 
                                               Placeholder="your@email.com" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="Email" Text="@L["Email_Required"]" />
                                <RadzenEmailValidator Component="Email" Text="@L["Invalid_Email"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenButton ButtonType="ButtonType.Submit" Text="@L["CREATE_ALERT"]" 
                                      Icon="add_alert" ButtonStyle="ButtonStyle.Primary" 
                                      Style="width: 100%;" IsBusy="@_isSubmitting" />
                    </RadzenStack>
                </RadzenTemplateForm>
            </RadzenTabsItem>
            <RadzenTabsItem Text="@L["Active_Alerts"]">
                @if (_activeAlerts.Any())
                {
                    <RadzenDataList @ref="_dataList" Data="@_activeAlerts" TItem="Alert" AllowPaging="true" PageSize="3">
                        <Template Context="alert">
                            <AlertCard Alert="@alert" 
                                       IsSelected="@(alert.Id == SelectedAlertId)"
                                       IsMobile="@_isMobile"
                                       OnShowOnMap="@(() => ShowOnMap(alert))"
                                       OnDeactivate="@(() => DeactivateAlert(alert.Id))" />
                        </Template>
                    </RadzenDataList>
                }
                else
                {
                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-p-4 text-center opacity-75">@L["No_active_alerts"]</RadzenText>
                }
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <RadzenButton Text="@L["CLOSE"]" Click="@(() => DialogService.Close())" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>
</RadzenStack>

@code {
    private bool _isMobile;
    private int _selectedTabIndex;
    [Parameter] public double? InitialLat { get; set; }
    [Parameter] public double? InitialLng { get; set; }
    [Parameter] public double? InitialRadius { get; set; }
    [Parameter] public int? SelectedAlertId { get; set; }

    private Alert _newAlert = new() { RadiusKm = 5.0 };
    private string _email = "";
    private List<Alert> _activeAlerts = [];
    private RadzenDataList<Alert> _dataList;
    private bool _isSubmitting;
    private string? _userIdentifier;
    private string? _approxAddress;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (SelectedAlertId.HasValue)
            {
                _selectedTabIndex = 1;
            }

            _userIdentifier = await StorageService.GetUserIdentifierAsync();
            
            var lastEmail = await StorageService.GetItemAsync("last-alert-email");
            if (!string.IsNullOrEmpty(lastEmail) && string.IsNullOrEmpty(_email))
            {
                _email = lastEmail;
            }

            if (InitialLat.HasValue)
            {
                _newAlert.Latitude = InitialLat.Value;
            }

            if (InitialLng.HasValue)
            {
                _newAlert.Longitude = InitialLng.Value;
            }

            if (InitialRadius.HasValue)
            {
                _newAlert.RadiusKm = Math.Min(InitialRadius.Value, 160.9);
            }

            if (InitialLat.HasValue && InitialLng.HasValue)
            {
                _approxAddress = await GeocodingService.ReverseGeocodeAsync(InitialLat.Value, InitialLng.Value);
            }
            
            await LoadAlerts();

            if (SelectedAlertId.HasValue && _dataList != null)
            {
                var index = _activeAlerts.FindIndex(a => a.Id == SelectedAlertId.Value);
                if (index >= 0)
                {
                    var page = index / 3;
                    if (page > 0)
                    {
                        await _dataList.GoToPage(page);
                    }
                    await Task.Delay(100);
                    await JsRuntime.InvokeVoidAsync("scrollToElement", "selected-alert-card");
                }
            }

            StateHasChanged();
        }
    }

    private void OnAddressResultSelected(GeocodingResult result)
    {
        _newAlert.Latitude = result.Latitude;
        _newAlert.Longitude = result.Longitude;
    }

    private async Task CreateAlert()
    {
        if (_isSubmitting)
        {
            return;
        }

        _isSubmitting = true;
        try
        {
            _newAlert.UserIdentifier = _userIdentifier;
            var result = await AlertService.CreateAlertAsync(_newAlert, _email);
            if (result.IsSuccess)
            {
                await StorageService.SetItemAsync("last-alert-email", _email);
                await HapticFeedbackService.VibrateSuccessAsync();
                NotificationService.Notify(NotificationSeverity.Success, "Alert created successfully");
                
                _newAlert = new Alert { RadiusKm = 5.0, UserIdentifier = _userIdentifier };
                _email = "";
                await LoadAlerts();
                DialogService.Close(true);
            }
            else
            {
                await HapticFeedbackService.VibrateErrorAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Failed to create alert", result.Error ?? "Unknown error");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create alert for email {Email}", _email);
            await HapticFeedbackService.VibrateErrorAsync();
            NotificationService.Notify(NotificationSeverity.Error, "Failed to create alert", ex.Message);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task DeactivateAlert(int id)
    {
        try
        {
            var result = await AlertService.DeleteAlertAsync(id);
            if (result.IsSuccess)
            {
                await HapticFeedbackService.VibrateWarningAsync();
                NotificationService.Notify(NotificationSeverity.Success, "Alert deleted");
                await LoadAlerts();
            }
            else
            {
                await HapticFeedbackService.VibrateErrorAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Failed to delete alert", result.Error ?? "Unknown error");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete alert {AlertId}", id);
            await HapticFeedbackService.VibrateErrorAsync();
            NotificationService.Notify(NotificationSeverity.Error, "Failed to delete alert", ex.Message);
        }
    }

    private void ShowOnMap(Alert alert)
    {
        DialogService.Close(alert);
    }

    private async Task LoadAlerts()
    {
        _activeAlerts = await AlertService.GetActiveAlertsAsync(_userIdentifier, onlyVerified: false);
    }

}
