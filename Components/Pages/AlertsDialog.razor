@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IAlertService AlertService
@inject IGeocodingService GeocodingService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IHapticFeedbackService HapticFeedbackService
@inject IJSRuntime JsRuntime
@inject ILogger<AlertsDialog> Logger
@inject IStringLocalizer<App> L
<RadzenMediaQuery Query="(max-width: 768px)" Change="@(args => _isMobile = args)" />

<RadzenStack Gap="1.5rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">@L["Distance_Based_Alerts"]</RadzenText>
    
    <RadzenTabs RenderMode="TabRenderMode.Client">
        <Tabs>
            <RadzenTabsItem Text="@L["Create_New"]">
                <RadzenTemplateForm Data="@_newAlert" Submit="@((Alert _) => CreateAlert())">
                    <RadzenStack Gap="1rem">
                        <RadzenFormField Text="@L["Search_Address"]" Variant="Variant.Outlined" Style="width: 100%;">
                            <RadzenAutoComplete @bind-Value="@_approxAddress" Data="@_geocodingResults" TextProperty="Address" 
                                                LoadData="@OnAddressSearch" Change="@OnAddressSelected"
                                                Placeholder="@L["Search_Address_Placeholder"]" Style="width: 100%;"
                                                InputType="search" />
                        </RadzenFormField>

                        <RadzenRow Gap="1rem">
                            <RadzenColumn Size="12" SizeSM="6">
                                <RadzenFormField Text="@L["Latitude"]" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="@_newAlert.Latitude" TValue="double" 
                                                   ShowUpDown="false" Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeSM="6">
                                <RadzenFormField Text="@L["Longitude"]" Variant="Variant.Outlined" Style="width: 100%;">
                                    <RadzenNumeric @bind-Value="@_newAlert.Longitude" TValue="double" 
                                                   ShowUpDown="false" Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenFormField Text="@L["Radius_Km"]" Variant="Variant.Outlined" Component="RadiusKm" Style="width: 100%;">
                            <ChildContent>
                                <RadzenNumeric Name="RadiusKm" @bind-Value="@_newAlert.RadiusKm" TValue="double" 
                                               Min="0.1m" Max="160.9m" ShowUpDown="true" 
                                               Step="0.5m" Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                <RadzenNumericRangeValidator Component="RadiusKm" Min="0.1" Max="160.9" Text="@L["Radius_Range_Error"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenFormField Text="@L["Alert_Message"]" Variant="Variant.Outlined" Component="AlertMessage" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="AlertMessage" @bind-Value="@_newAlert.Message" Style="width: 100%;" 
                                               Placeholder="@L["Alert_Message_Placeholder"]" MaxLength="100" />
                            </ChildContent>
                            <Helper>
                                <RadzenLengthValidator Component="AlertMessage" Max="100" Text="@L["Message_Too_Long"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenFormField Text="@L["Email_for_Alerts"]" Variant="Variant.Outlined" Component="Email" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="Email" @bind-Value="@_email" Style="width: 100%;" 
                                               Placeholder="your@email.com" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="Email" Text="@L["Email_Required"]" />
                                <RadzenEmailValidator Component="Email" Text="@L["Invalid_Email"]" />
                            </Helper>
                        </RadzenFormField>

                        <RadzenButton ButtonType="ButtonType.Submit" Text="@L["CREATE_ALERT"]" 
                                      Icon="add_alert" ButtonStyle="ButtonStyle.Primary" 
                                      Style="width: 100%;" IsBusy="@_isSubmitting" />
                    </RadzenStack>
                </RadzenTemplateForm>
            </RadzenTabsItem>
            <RadzenTabsItem Text="@L["Active_Alerts"]">
                @if (_activeAlerts.Any())
                {
                    <RadzenDataList Data="@_activeAlerts" TItem="Alert" AllowPaging="true" PageSize="3">
                        <Template Context="alert">
                            <RadzenCard Class="rz-mb-2 rz-p-2">
                                <RadzenStack Orientation="@(_isMobile ? Orientation.Vertical : Orientation.Horizontal)" JustifyContent="JustifyContent.SpaceBetween" AlignItems="@(_isMobile ? AlignItems.Start : AlignItems.Center)" Gap="@(_isMobile ? "1rem" : "0.5rem")">
                                    <RadzenStack Gap="0">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="0.5rem">
                                            <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin-bottom: 0;">@alert.Message</RadzenText>
                                            @if (!alert.IsVerified)
                                            {
                                                <RadzenBadge Text="@L["Pending_Verification"]" BadgeStyle="BadgeStyle.Warning" IsPill="true" />
                                            }
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption">@alert.RadiusKm km around @alert.LocationDisplay()</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption">@MaskEmail(AlertService.DecryptEmail(alert.EncryptedEmail))</RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="@(_isMobile ? JustifyContent.End : JustifyContent.Start)" Class="@(_isMobile ? "rz-w-100" : "")">
                                        <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Variant="Variant.Flat"
                                                      Click="@(() => ShowOnMap(alert))" ToolTip="@L["Show_on_Map"]" />
                                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Variant="Variant.Flat"
                                                      Click="@(() => DeactivateAlert(alert.Id))" ToolTip="@L["Deactivate"]" />
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenCard>
                        </Template>
                    </RadzenDataList>
                }
                else
                {
                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-p-4 text-center opacity-75">@L["No_active_alerts"]</RadzenText>
                }
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <RadzenButton Text="@L["CLOSE"]" Click="@(() => DialogService.Close())" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>
</RadzenStack>

@code {
    private bool _isMobile;
    [Parameter] public double? InitialLat { get; set; }
    [Parameter] public double? InitialLng { get; set; }
    [Parameter] public double? InitialRadius { get; set; }

    private Alert _newAlert = new() { RadiusKm = 5.0 };
    private string _email = "";
    private List<Alert> _activeAlerts = [];
    private List<GeocodingResult> _geocodingResults = [];
    private bool _isSubmitting;
    private string? _userIdentifier;
    private string? _approxAddress;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _userIdentifier = await JsRuntime.InvokeAsync<string>("getUserIdentifier");
            if (InitialLat.HasValue)
            {
                _newAlert.Latitude = InitialLat.Value;
            }

            if (InitialLng.HasValue)
            {
                _newAlert.Longitude = InitialLng.Value;
            }

            if (InitialRadius.HasValue)
            {
                _newAlert.RadiusKm = Math.Min(InitialRadius.Value, 160.9);
            }

            if (InitialLat.HasValue && InitialLng.HasValue)
            {
                _approxAddress = await GeocodingService.ReverseGeocodeAsync(InitialLat.Value, InitialLng.Value);
            }
            
            await LoadAlerts();

            StateHasChanged();
        }
    }

    private async Task OnAddressSearch(LoadDataArgs args)
    {
        if (!string.IsNullOrWhiteSpace(args.Filter) && args.Filter.Length > 3)
        {
            _geocodingResults = await GeocodingService.SearchAsync(args.Filter);
        }
    }

    private void OnAddressSelected(object value)
    {
        if (value is not string address)
        {
            return;
        }
        
        var selected = _geocodingResults.FirstOrDefault(r => r.Address == address);
        
        if (selected == null)
        {
            return;
        }
        
        _newAlert.Latitude = selected.Latitude;
        _newAlert.Longitude = selected.Longitude;
        _approxAddress = selected.Address;
    }

    private async Task CreateAlert()
    {
        if (_isSubmitting)
        {
            return;
        }

        _isSubmitting = true;
        try
        {
            _newAlert.UserIdentifier = _userIdentifier;
            var result = await AlertService.CreateAlertAsync(_newAlert, _email);
            if (result.IsSuccess)
            {
                await HapticFeedbackService.VibrateSuccessAsync();
                NotificationService.Notify(NotificationSeverity.Success, "Alert created successfully");
                
                _newAlert = new Alert { RadiusKm = 5.0, UserIdentifier = _userIdentifier };
                _email = "";
                await LoadAlerts();
                DialogService.Close(true);
            }
            else
            {
                await HapticFeedbackService.VibrateErrorAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Failed to create alert", result.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create alert for email {Email}", _email);
            await HapticFeedbackService.VibrateErrorAsync();
            NotificationService.Notify(NotificationSeverity.Error, "Failed to create alert", ex.Message);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task DeactivateAlert(int id)
    {
        try
        {
            var result = await AlertService.DeactivateAlertAsync(id);
            if (result.IsSuccess)
            {
                await HapticFeedbackService.VibrateWarningAsync();
                NotificationService.Notify(NotificationSeverity.Success, "Alert deactivated");
                await LoadAlerts();
            }
            else
            {
                await HapticFeedbackService.VibrateErrorAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Failed to deactivate alert", result.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to deactivate alert {AlertId}", id);
            await HapticFeedbackService.VibrateErrorAsync();
            NotificationService.Notify(NotificationSeverity.Error, "Failed to deactivate alert", ex.Message);
        }
    }

    private void ShowOnMap(Alert alert)
    {
        DialogService.Close(alert);
    }

    private async Task LoadAlerts()
    {
        _activeAlerts = await AlertService.GetActiveAlertsAsync(_userIdentifier, onlyVerified: false);
    }

    private static string MaskEmail(string? email)
    {
        if (string.IsNullOrEmpty(email))
        {
            return "Unknown";
        }

        var parts = email.Split('@');
        if (parts.Length != 2)
        {
            return "****";
        }

        var name = parts[0];
        var domain = parts[1];
        if (name.Length <= 2)
        {
            return "**@" + domain;
        }

        return name[..2] + "****@" + domain;
    }
}
