@page "/donate"
@using WhereAreThey.Models
@using WhereAreThey.Services
@inject DonationService DonationService
@inject NotificationService NotificationService

<PageTitle>Support WhereAreThey - Donation</PageTitle>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <RadzenCard Class="rz-shadow-10 rz-border-radius-6 mb-4" Style="border-top: 8px solid var(--rz-success);">
                <RadzenText TextStyle="TextStyle.H4" Class="mb-3" Style="font-weight: bold; color: var(--rz-success-darker);">
                    SUPPORT US
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Class="mb-4">
                    Your donation helps keep this life-saving service online and accessible to everyone who needs it.
                    <strong>People's lives depend on it.</strong>
                </RadzenText>

                <RadzenTemplateForm Data="@donation" Submit="@((Donation args) => ProcessDonation())">
                    <RadzenStack Gap="1.5rem">
                        <RadzenFormField Text="Amount" Variant="Variant.Outlined">
                            <RadzenNumeric @bind-Value="@donation.Amount" TValue="decimal" 
                                           Min="1" Max="10000" ShowUpDown="false" 
                                           Format="c" Style="width: 100%; font-size: 1.5rem; font-weight: bold;" />
                        </RadzenFormField>

                        <div class="row g-2">
                            <div class="col-3">
                                <RadzenButton Text="$5" Click="@(() => donation.Amount = 5)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" />
                            </div>
                            <div class="col-3">
                                <RadzenButton Text="$10" Click="@(() => donation.Amount = 10)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" />
                            </div>
                            <div class="col-3">
                                <RadzenButton Text="$25" Click="@(() => donation.Amount = 25)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" />
                            </div>
                            <div class="col-3">
                                <RadzenButton Text="$50" Click="@(() => donation.Amount = 50)" 
                                              ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Style="width: 100%;" />
                            </div>
                        </div>

                        <RadzenFormField Text="Email (Optional)" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="@donation.DonorEmail" 
                                           Placeholder="your@email.com" 
                                           Style="width: 100%;" />
                        </RadzenFormField>

                        <RadzenButton ButtonType="ButtonType.Submit" 
                                      Text="@($"DONATE ${donation.Amount:F2}")" 
                                      Icon="volunteer_activism" 
                                      ButtonStyle="ButtonStyle.Success" 
                                      Size="ButtonSize.Large"
                                      Style="width: 100%; font-weight: bold;" 
                                      Disabled="@isProcessing" />
                        
                        <RadzenText TextStyle="TextStyle.Caption" Class="text-center opacity-75">
                            Secure payment processing via Stripe.<br />
                            Thank you for your support.
                        </RadzenText>
                    </RadzenStack>
                </RadzenTemplateForm>
            </RadzenCard>

            @if (recentDonations.Any())
            {
                <RadzenCard Class="rz-shadow-5 rz-border-radius-4">
                    <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Recent Supporters</RadzenText>
                    <RadzenDataList Data="@recentDonations" TItem="DonationDisplay" PageSize="3" ShowPagingSummary="false">
                        <Template Context="d">
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 rz-border-radius-2" style="background-color: var(--rz-success-lighter);">
                                <div>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: bold; margin-bottom: 0;">@d.DisplayName</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Style="margin-bottom: 0;">@d.TimeAgo</RadzenText>
                                </div>
                                <RadzenBadge Text="@($"${d.Amount:F0}")" BadgeStyle="BadgeStyle.Success" />
                            </div>
                        </Template>
                    </RadzenDataList>
                </RadzenCard>
            }
        </div>
    </div>
</div>

@code {
    private Donation donation = new Donation { Amount = 10 };
    private List<DonationDisplay> recentDonations = new();
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        // Simulate recent donations for demonstration
        recentDonations = new List<DonationDisplay>
        {
            new DonationDisplay { DisplayName = "Anonymous", Amount = 25, TimeAgo = "2 hours ago" },
            new DonationDisplay { DisplayName = "John D.", Amount = 50, TimeAgo = "5 hours ago" },
            new DonationDisplay { DisplayName = "Anonymous", Amount = 10, TimeAgo = "1 day ago" },
        };
    }

    private async Task ProcessDonation()
    {
        if (donation.Amount < 1)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Minimum donation amount is $1");
            return;
        }

        isProcessing = true;
        try
        {
            // In production, this would create a Stripe Payment Intent
            // and handle the payment flow
            await Task.Delay(1000); // Simulate API call
            
            donation.Status = "completed";
            donation.StripePaymentIntentId = Guid.NewGuid().ToString();
            await DonationService.RecordDonationAsync(donation);

            NotificationService.Notify(NotificationSeverity.Success, 
                "Thank you for your donation!", 
                "Your support helps keep this service running.");
            
            var displayName = string.IsNullOrWhiteSpace(donation.DonorName) ? "Anonymous" : donation.DonorName;
            recentDonations.Insert(0, new DonationDisplay 
            { 
                DisplayName = displayName, 
                Amount = donation.Amount, 
                TimeAgo = "just now" 
            });

            donation = new Donation { Amount = 10 };
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Donation failed", ex.Message);
        }
        finally
        {
            isProcessing = false;
        }
    }

    public class DonationDisplay
    {
        public string DisplayName { get; set; } = "";
        public decimal Amount { get; set; }
        public string TimeAgo { get; set; } = "";
    }
}
