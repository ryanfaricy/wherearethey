@page "/report"
@rendermode InteractiveServer
@using WhereAreThey.Models
@using WhereAreThey.Services
@inject LocationService LocationService
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime

<PageTitle>Report Location - WhereAreThey</PageTitle>

<div class="container-fluid">
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.H4" Class="mb-3">Report Location</RadzenText>
        <RadzenText TextStyle="TextStyle.Body1" Class="mb-4">
            Report your location or the location of someone in need. All reports are anonymous.
        </RadzenText>

        <RadzenTemplateForm Data="@report" Submit="@((LocationReport args) => SubmitReport())">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Latitude" Variant="Variant.Outlined">
                    <RadzenNumeric @bind-Value="@report.Latitude" TValue="double" 
                                   ShowUpDown="false" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Longitude" Variant="Variant.Outlined">
                    <RadzenNumeric @bind-Value="@report.Longitude" TValue="double" 
                                   ShowUpDown="false" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenButton Text="Use My Current Location" Icon="my_location" 
                              Click="@GetCurrentLocation" ButtonStyle="ButtonStyle.Secondary" 
                              Style="width: 100%;" Disabled="@isGettingLocation" />

                <RadzenFormField Text="Message (Optional)" Variant="Variant.Outlined">
                    <RadzenTextArea @bind-Value="@report.Message" Rows="3" 
                                    Style="width: 100%;" MaxLength="500" />
                </RadzenFormField>

                <RadzenCheckBox @bind-Value="@report.IsEmergency" TValue="bool" />
                <RadzenLabel Text="This is an emergency" Component="IsEmergency" Style="margin-left: 0.5rem;" />

                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Class="mt-3">
                    <RadzenButton ButtonType="ButtonType.Submit" Text="Submit Report" 
                                  Icon="send" ButtonStyle="ButtonStyle.Primary" 
                                  Style="width: 100%;" Disabled="@isSubmitting" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenCard>

    @if (recentReports.Any())
    {
        <RadzenCard Class="mt-4">
            <RadzenText TextStyle="TextStyle.H5" Class="mb-3">Recent Reports (Last 24 Hours)</RadzenText>
            <RadzenDataGrid Data="@recentReports" TItem="LocationReport" 
                            AllowPaging="true" PageSize="10" 
                            AllowSorting="true" Style="width: 100%;">
                <Columns>
                    <RadzenDataGridColumn TItem="LocationReport" Property="Timestamp" Title="Time" 
                                          FormatString="{0:g}" Width="150px" />
                    <RadzenDataGridColumn TItem="LocationReport" Property="Latitude" Title="Latitude" 
                                          FormatString="{0:F6}" Width="120px" />
                    <RadzenDataGridColumn TItem="LocationReport" Property="Longitude" Title="Longitude" 
                                          FormatString="{0:F6}" Width="120px" />
                    <RadzenDataGridColumn TItem="LocationReport" Property="Message" Title="Message" />
                    <RadzenDataGridColumn TItem="LocationReport" Property="IsEmergency" Title="Emergency" Width="100px">
                        <Template Context="data">
                            @if (data.IsEmergency)
                            {
                                <RadzenBadge Text="YES" BadgeStyle="BadgeStyle.Danger" />
                            }
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    }
</div>

@code {
    private LocationReport report = new LocationReport();
    private List<LocationReport> recentReports = new();
    private bool isSubmitting = false;
    private bool isGettingLocation = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentReports();
    }

    private async Task GetCurrentLocation()
    {
        isGettingLocation = true;
        try
        {
            var position = await JSRuntime.InvokeAsync<GeolocationPosition>("getLocation");
            report.Latitude = position.Coords.Latitude;
            report.Longitude = position.Coords.Longitude;
            NotificationService.Notify(NotificationSeverity.Success, "Location retrieved successfully");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to get location", ex.Message);
        }
        finally
        {
            isGettingLocation = false;
        }
    }

    private async Task SubmitReport()
    {
        isSubmitting = true;
        try
        {
            // Generate anonymous session ID if not exists
            if (string.IsNullOrEmpty(report.ReporterIdentifier))
            {
                report.ReporterIdentifier = Guid.NewGuid().ToString();
            }

            await LocationService.AddLocationReportAsync(report);
            NotificationService.Notify(NotificationSeverity.Success, "Location reported successfully");
            
            report = new LocationReport();
            await LoadRecentReports();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to submit report", ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task LoadRecentReports()
    {
        recentReports = await LocationService.GetRecentReportsAsync(24);
    }

    public class GeolocationPosition
    {
        public GeolocationCoordinates Coords { get; set; } = new();
    }

    public class GeolocationCoordinates
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }
}
