@page "/heatmap"
@using WhereAreThey.Models
@using WhereAreThey.Services
@using Microsoft.AspNetCore.WebUtilities
@inject LocationService LocationService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>ARE THEY HERE? - Heat Map</PageTitle>

<div class="container-fluid py-4">
    <RadzenCard Class="rz-shadow-10 rz-border-radius-6 mb-4" Style="border-top: 8px solid var(--rz-info);">
        <RadzenText TextStyle="TextStyle.H4" Class="mb-3" Style="font-weight: bold; color: var(--rz-info-darker);">
            ARE THEY HERE?
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Body1" Class="mb-4">
            View all reported locations from the last 24 hours. Red heat areas indicate higher concentrations of reports.
        </RadzenText>

        <RadzenStack Gap="1rem" Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Wrap="FlexWrap.Wrap">
            <RadzenButton Icon="settings" Click="@OnSettingsClick" ButtonStyle="ButtonStyle.Base" Variant="Variant.Flat" Size="ButtonSize.Large" />
            <RadzenButton Icon="help_outline" Click="@OnHelpClick" ButtonStyle="ButtonStyle.Base" Variant="Variant.Flat" Size="ButtonSize.Large" />
            <RadzenButton Text="REFRESH" Icon="refresh" Click="@LoadReports" 
                          ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Large" 
                          Style="font-weight: bold;" />
        </RadzenStack>
    </RadzenCard>

    <RadzenCard Class="rz-shadow-10 rz-border-radius-6 mb-4" Style="padding: 0; overflow: hidden; height: 450px;">
        <div id="heatmap" style="height: 100%; width: 100%;"></div>
    </RadzenCard>

    <RadzenCard Class="rz-shadow-5 rz-border-radius-4">
        <RadzenText TextStyle="TextStyle.H5" Class="mb-3">
            Reports (@reports.Count total)
        </RadzenText>
        
        @if (reports.Any())
        {
            <RadzenDataList Data="@reports" TItem="LocationReport" AllowPaging="true" PageSize="10">
                <Template Context="r">
                    <div class="rz-card mb-2 p-3 @(r.IsEmergency ? "report-emergency" : "report-normal")">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenStack Gap="0">
                                <RadzenText TextStyle="TextStyle.H6" Style="margin-bottom: 0;">
                                    @r.Latitude.ToString("F4"), @r.Longitude.ToString("F4")
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">
                                    @r.Timestamp.ToLocalTime().ToString("g")
                                </RadzenText>
                            </RadzenStack>
                            @if (r.IsEmergency)
                            {
                                <RadzenBadge Text="EMERGENCY" BadgeStyle="BadgeStyle.Danger" />
                            }
                        </RadzenStack>
                        @if (!string.IsNullOrEmpty(r.Message))
                        {
                            <RadzenText TextStyle="TextStyle.Body2" Class="mt-2">
                                @r.Message
                            </RadzenText>
                        }
                    </div>
                </Template>
            </RadzenDataList>
        }
        else
        {
            <RadzenText TextStyle="TextStyle.Body1" Class="text-center py-5 opacity-75">
                No reports found for this time range.
            </RadzenText>
        }
    </RadzenCard>
</div>

@code {
    private List<LocationReport> reports = new();
    private int hoursBack = 24;
    private bool mapInitialized = false;
    private DotNetObjectReference<HeatMap>? objRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadReports();
        LocationService.OnReportAdded += HandleReportAdded;
    }

    private void HandleReportAdded()
    {
        InvokeAsync(async () =>
        {
            await LoadReports();
            StateHasChanged();
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            double initialLat = 0;
            double initialLng = 0;
            double? initialRadius = null;

            // Check query parameters
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);
            if (query.TryGetValue("lat", out var latStr) && double.TryParse(latStr, out var lat))
            {
                initialLat = lat;
            }
            if (query.TryGetValue("lng", out var lngStr) && double.TryParse(lngStr, out var lng))
            {
                initialLng = lng;
            }
            if (query.TryGetValue("radius", out var radiusStr) && double.TryParse(radiusStr, out var radius))
            {
                initialRadius = radius;
            }

            if (initialLat == 0 && initialLng == 0)
            {
                try
                {
                    var position = await JSRuntime.InvokeAsync<GeolocationPosition>("getLocation");
                    initialLat = position.Coords.Latitude;
                    initialLng = position.Coords.Longitude;
                }
                catch (Exception)
                {
                    // Fallback
                }
            }

            await JSRuntime.InvokeVoidAsync("initHeatMap", "heatmap", initialLat, initialLng, reports, objRef);
            mapInitialized = true;

            if (initialRadius.HasValue)
            {
                await JSRuntime.InvokeVoidAsync("setMapView", initialLat, initialLng, initialRadius.Value);
            }
        }
    }

    [JSInvokable]
    public async Task OnMapClick(double lat, double lng)
    {
        // Find reports within a certain radius (e.g. 5km)
        double searchRadiusKm = 5.0; 

        var nearbyReports = reports
            .Where(r => GeoUtils.CalculateDistance(lat, lng, r.Latitude, r.Longitude) <= searchRadiusKm)
            .OrderByDescending(r => r.Timestamp)
            .ToList();

        if (nearbyReports.Any())
        {
            // Tapping on a blob reveals report details
            await DialogService.OpenAsync<ReportDetailsDialog>("AREA DETAILS",
                new Dictionary<string, object> { { "Reports", nearbyReports } },
                new DialogOptions { Width = "350px" });
        }
        else
        {
            // Tapping on a non-blob area opens create alert
            await ShowAlertsDialog(lat, lng);
        }
    }

    [JSInvokable]
    public async Task OnMapContextMenu(double lat, double lng)
    {
        // Long-press/right click reveals create report
        var report = new LocationReport
        {
            Latitude = lat,
            Longitude = lng
        };
        
        var result = await DialogService.OpenAsync<ReportDialog>("REPORT LOCATION",
            new Dictionary<string, object> { { "report", report } },
            new DialogOptions { Width = "350px", Resizable = false, Draggable = true });

        if (result == true)
        {
            await LoadReports();
        }
    }

    private async Task ShowAlertsDialog(double? lat = null, double? lng = null)
    {
        var parameters = new Dictionary<string, object>();
        try
        {
            if (lat.HasValue && lng.HasValue)
            {
                parameters.Add("InitialLat", lat.Value);
                parameters.Add("InitialLng", lng.Value);
                
                var mapState = await JSRuntime.InvokeAsync<MapState>("getMapState");
                if (mapState != null)
                {
                    parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
                }
            }
            else
            {
                var mapState = await JSRuntime.InvokeAsync<MapState>("getMapState");
                if (mapState != null)
                {
                    parameters.Add("InitialLat", mapState.Lat);
                    parameters.Add("InitialLng", mapState.Lng);
                    parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
                }
            }
        }
        catch (Exception)
        {
            // Ignore if map state cannot be retrieved
        }

        var result = await DialogService.OpenAsync<AlertsDialog>("ALERTS",
            parameters,
            new DialogOptions { Width = "350px" });

        if (result is Alert alert)
        {
            await JSRuntime.InvokeVoidAsync("setMapView", alert.Latitude, alert.Longitude, alert.RadiusKm);
        }
    }

    public void Dispose()
    {
        LocationService.OnReportAdded -= HandleReportAdded;
        objRef?.Dispose();
    }

    public class GeolocationPosition
    {
        public GeolocationCoordinates Coords { get; set; } = new();
    }

    public class GeolocationCoordinates
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }

    private async Task LoadReports()
    {
        reports = await LocationService.GetRecentReportsAsync(hoursBack);
        if (mapInitialized)
        {
            await JSRuntime.InvokeVoidAsync("updateHeatMap", reports);
        }
    }

    private async Task OnSettingsClick()
    {
        var result = await DialogService.OpenAsync<SettingsDialog>("SETTINGS",
            new Dictionary<string, object> { { "HoursBack", hoursBack } },
            new DialogOptions { Width = "300px" });

        if (result != null)
        {
            hoursBack = (int)result;
            await LoadReports();
        }
    }

    private async Task OnHelpClick()
    {
        await DialogService.OpenAsync<HelpDialog>("HELP",
            null,
            new DialogOptions { Width = "350px" });
    }
}
