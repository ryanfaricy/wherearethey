@page "/heatmap"
@using WhereAreThey.Models
@using WhereAreThey.Services
@inject LocationService LocationService
@inject IJSRuntime JSRuntime

<PageTitle>ARE THEY HERE? - Heat Map</PageTitle>

<div class="container-fluid py-4">
    <RadzenCard Class="rz-shadow-10 rz-border-radius-6 mb-4" Style="border-top: 8px solid var(--rz-info);">
        <RadzenText TextStyle="TextStyle.H4" Class="mb-3" Style="font-weight: bold; color: var(--rz-info-darker);">
            ARE THEY HERE?
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Body1" Class="mb-4">
            View all reported locations from the last 24 hours. Red heat areas indicate higher concentrations of reports.
        </RadzenText>

        <RadzenStack Gap="1rem" Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Wrap="FlexWrap.Wrap">
            <RadzenFormField Text="Time Range (Hours)" Variant="Variant.Outlined" Style="flex: 1; min-width: 150px;">
                <RadzenNumeric @bind-Value="@hoursBack" TValue="int" Min="1" Max="168" 
                               ShowUpDown="true" Style="width: 100%;" />
            </RadzenFormField>
            <RadzenButton Text="REFRESH" Icon="refresh" Click="@LoadReports" 
                          ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Large" 
                          Style="font-weight: bold;" />
        </RadzenStack>
    </RadzenCard>

    <RadzenCard Class="rz-shadow-10 rz-border-radius-6 mb-4" Style="padding: 0; overflow: hidden; height: 450px;">
        <div id="heatmap" style="height: 100%; width: 100%;"></div>
    </RadzenCard>

    <RadzenCard Class="rz-shadow-5 rz-border-radius-4">
        <RadzenText TextStyle="TextStyle.H5" Class="mb-3">
            Reports (@reports.Count total)
        </RadzenText>
        
        @if (reports.Any())
        {
            <RadzenDataList Data="@reports" TItem="LocationReport" AllowPaging="true" PageSize="10">
                <Template Context="r">
                    <div class="rz-card mb-2 p-3 @(r.IsEmergency ? "report-emergency" : "report-normal")">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenStack Gap="0">
                                <RadzenText TextStyle="TextStyle.H6" Style="margin-bottom: 0;">
                                    @r.Latitude.ToString("F4"), @r.Longitude.ToString("F4")
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">
                                    @r.Timestamp.ToLocalTime().ToString("g")
                                </RadzenText>
                            </RadzenStack>
                            @if (r.IsEmergency)
                            {
                                <RadzenBadge Text="EMERGENCY" BadgeStyle="BadgeStyle.Danger" />
                            }
                        </RadzenStack>
                        @if (!string.IsNullOrEmpty(r.Message))
                        {
                            <RadzenText TextStyle="TextStyle.Body2" Class="mt-2">
                                @r.Message
                            </RadzenText>
                        }
                    </div>
                </Template>
            </RadzenDataList>
        }
        else
        {
            <RadzenText TextStyle="TextStyle.Body1" Class="text-center py-5 opacity-75">
                No reports found for this time range.
            </RadzenText>
        }
    </RadzenCard>
</div>

@code {
    private List<LocationReport> reports = new();
    private int hoursBack = 24;
    private bool mapInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadReports();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initial center (0,0), updateHeatMap will fit bounds if reports exist
            await JSRuntime.InvokeVoidAsync("initHeatMap", "heatmap", 0, 0, reports);
            mapInitialized = true;
        }
    }

    private async Task LoadReports()
    {
        reports = await LocationService.GetRecentReportsAsync(hoursBack);
        if (mapInitialized)
        {
            await JSRuntime.InvokeVoidAsync("updateHeatMap", reports);
        }
    }
}
