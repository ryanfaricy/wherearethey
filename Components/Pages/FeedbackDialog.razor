@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IFeedbackService FeedbackService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IHapticFeedbackService HapticFeedbackService
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime
@inject ILogger<FeedbackDialog> Logger
@inject IStringLocalizer<App> L

<RadzenStack Gap="1.5rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">@L["Feedback_Title"]</RadzenText>
    
    <RadzenText TextStyle="TextStyle.Body2">
        @L["Feedback_Intro"]
    </RadzenText>

    <RadzenTemplateForm Data="@_feedback" Submit="@((Feedback _) => SubmitFeedback())">
        <RadzenStack Gap="1rem">
            <RadzenFormField Text="@L["Type"]" Variant="Variant.Outlined" Style="width: 100%;">
                <RadzenDropDown @bind-Value="@_feedback.Type" Data="@_feedbackTypes" Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="@L["Message"]" Variant="Variant.Outlined" Component="FeedbackMessage" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextArea Name="FeedbackMessage" @bind-Value="@_feedback.Message" Style="width: 100%; height: 150px;" 
                                    Placeholder="@L["Feedback_Placeholder"]" />
                </ChildContent>
                <Helper>
                    <RadzenRequiredValidator Component="FeedbackMessage" Text="@L["Message_Required"]" />
                </Helper>
            </RadzenFormField>

            <RadzenButton ButtonType="ButtonType.Submit" Text="@L["SUBMIT"]" 
                          Icon="send" ButtonStyle="ButtonStyle.Primary" 
                          Style="width: 100%;" Disabled="@_isSubmitting" />
        </RadzenStack>
    </RadzenTemplateForm>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <RadzenButton Text="@L["CANCEL"]" Click="@(() => DialogService.Close())" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>
</RadzenStack>

@code {
    private readonly Feedback _feedback = new();
    private List<string> _feedbackTypes = [];
    private bool _isSubmitting;
    private string? _userIdentifier;

    protected override void OnInitialized()
    {
        _feedbackTypes = [L["Bug"], L["Feature"]];
        _feedback.Type = L["Bug"];
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _userIdentifier = await JsRuntime.InvokeAsync<string>("getUserIdentifier");

            StateHasChanged();
        }
    }

    private async Task SubmitFeedback()
    {
        if (_isSubmitting)
        {
            return;
        }

        _isSubmitting = true;
        try
        {
            // Easter egg to get to admin login screen
            if (_feedback.Type == L["Feature"] && _feedback.Message?.Trim().Equals("let me into cp", StringComparison.OrdinalIgnoreCase) == true)
            {
                DialogService.Close(true);
                NavigationManager.NavigateTo("/cp");
                return;
            }

            _feedback.UserIdentifier = _userIdentifier;
            await FeedbackService.AddFeedbackAsync(_feedback);
            await HapticFeedbackService.VibrateSuccessAsync();
            NotificationService.Notify(NotificationSeverity.Success, L["Feedback_Success"]);
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to submit feedback");
            await HapticFeedbackService.VibrateErrorAsync();
            NotificationService.Notify(NotificationSeverity.Error, L["Feedback_Fail"], ex.Message);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
