@using System.Text.Json
@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IReportService ReportService
@inject IGeocodingService GeocodingService
@inject DialogService DialogService
@inject IMapService MapService
@inject IValidationService ValidationService
@inject IClientStorageService StorageService
@inject IHapticFeedbackService HapticFeedbackService
@inject ILogger<ReportDialog> Logger
@inject IStringLocalizer<App> L

<RadzenTemplateForm Data="@Report" Submit="@((Report _) => SubmitReport())">
    <RadzenStack Gap="1rem" Class="rz-p-4">
        <RadzenFormField Text="@L["Search_Address"]" Variant="Variant.Outlined" Style="width: 100%;">
            <AddressSearch @bind-SearchValue="@_approxAddress" 
                           OnResultSelected="@OnAddressResultSelected"
                           Placeholder="@L["Search_Address_Placeholder"]" 
                           CustomStyle="width: 100%;"
                           InputType="search" />
        </RadzenFormField>

        @if (_isDeterminingLocation)
        {
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin-bottom: 0;">@L["Acquiring_Location"]</RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenText TextStyle="TextStyle.Subtitle2">@((MarkupString)string.Format(L["Report_Coordinates"], $"<b>{Report.LocationDisplay(6)}</b>"))</RadzenText>
        }
        
        <RadzenFormField Text="@L["Message_Optional"]" Variant="Variant.Outlined" Component="Message" Style="width: 100%;">
            <ChildContent>
                <RadzenTextArea Name="Message" @bind-Value="@Report.Message" Rows="3" 
                                Style="width: 100%;" MaxLength="500" Change="@SaveDraft" />
            </ChildContent>
            <Helper>
                <RadzenLengthValidator Component="Message" Max="500" Text="@L["Message_Too_Long_Detail"]" />
            </Helper>
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
            <RadzenCheckBox @bind-Value="@Report.IsEmergency" TValue="bool" Name="IsEmergency" Change="@SaveDraft" />
            <RadzenLabel Text="@L["Emergency_Checkbox"]" Component="IsEmergency" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Class="rz-mt-3" JustifyContent="JustifyContent.End">
            <RadzenButton Text="@L["CANCEL"]" Click="@Cancel" ButtonStyle="ButtonStyle.Light" />
            <RadzenButton ButtonType="ButtonType.Submit" Text="@L["SUBMIT_REPORT"]" 
                          Icon="report_problem" ButtonStyle="ButtonStyle.Danger" 
                          IsBusy="@_isSubmitting" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Report Report { get; set; } = new();
    [Parameter] public Task<GeolocationPosition?>? LocationTask { get; set; }
    [Parameter] public bool UpdateReportLocation { get; set; } = true;
    private bool _isSubmitting;
    private bool _isDeterminingLocation;
    private string? _approxAddress;

    protected override async Task OnInitializedAsync()
    {
        if (LocationTask is { IsCompleted: false })
        {
            _isDeterminingLocation = true;
            _ = UpdateLocationAsync();
        }
        else
        {
            _approxAddress = await GeocodingService.ReverseGeocodeAsync(Report.Latitude, Report.Longitude);
        }
    }

    private async Task SaveDraft()
    {
        try
        {
            Report.CreatedAt = DateTime.UtcNow;
            var json = JsonSerializer.Serialize(Report);
            await StorageService.SetItemAsync("report_draft", json);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to save report draft");
        }
    }

    private async Task ClearDraft()
    {
        try
        {
            await StorageService.RemoveItemAsync("report_draft");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to clear report draft");
        }
    }

    private async Task Cancel()
    {
        await ClearDraft();
        DialogService.Close(false);
    }

    private async Task UpdateLocationAsync()
    {
        try
        {
            var position = await LocationTask!;
            if (position != null)
            {
                if (UpdateReportLocation)
                {
                    Report.Latitude = position.Coords.Latitude;
                    Report.Longitude = position.Coords.Longitude;
                    
                    // Update Ghost Pin on map
                    await MapService.ShowGhostPinAsync(Report.Latitude, Report.Longitude);
                    
                    _approxAddress = await GeocodingService.ReverseGeocodeAsync(Report.Latitude, Report.Longitude);
                }

                Report.ReporterLatitude = position.Coords.Latitude;
                Report.ReporterLongitude = position.Coords.Longitude;
                await SaveDraft();
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to update location in background");
        }
        finally
        {
            _isDeterminingLocation = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnAddressResultSelected(GeocodingResult result)
    {
        Report.Latitude = result.Latitude;
        Report.Longitude = result.Longitude;
        await SaveDraft();
    }

    private async Task SubmitReport()
    {
        if (_isSubmitting)
        {
            return;
        }

        _isSubmitting = true;

        await ValidationService.ExecuteAsync(
            async () => await ReportService.CreateReportAsync(Report),
            successMessage: L["Report_Success"],
            errorTitle: L["Report_Fail"],
            onSuccess: async () =>
            {
                await ClearDraft();
                if (Report.IsEmergency)
                {
                    await HapticFeedbackService.VibrateEmergencyAsync();
                }

                DialogService.Close(true);
            },
            logContext: $"SubmitReport at {Report.Latitude}, {Report.Longitude}"
        );

        _isSubmitting = false;
    }
}
