@using WhereAreThey.Components.Admin
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@inject DialogService DialogService
@inject IAlertService AlertService
@inject NotificationService NotificationService
@inject UserTimeZoneService TimeZoneService
@inject IAdminService AdminService
@inject IJSRuntime JsRuntime

<RadzenStack Gap="1rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-primary-darker); font-weight: bold;">Area Details</RadzenText>
    
    <RadzenTabs RenderMode="TabRenderMode.Client" @bind-SelectedIndex="_selectedTabIndex">
        <Tabs>
            <RadzenTabsItem Text="Reports" Icon="visibility">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Body1">Reports in this area:</RadzenText>
                        <RadzenBadge Text="@Reports.Count.ToString()" BadgeStyle="BadgeStyle.Primary" />
                    </RadzenStack>

                    @if (EmergencyCount > 0)
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" ShowIcon="true" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false">
                            <b>@EmergencyCount</b> emergency reports detected!
                        </RadzenAlert>
                    }

                    @if (Reports.Any())
                    {
                        <RadzenText TextStyle="TextStyle.Caption">
                            <strong>Most recent:</strong> @TimeZoneService.FormatLocal(MostRecentTimestamp) 
                            <span class="rz-color-info">(@TimeAgo(MostRecentTimestamp))</span>
                        </RadzenText>

                        <div style="max-height: 400px; overflow-y: auto;">
                            <RadzenDataList Data="@(_isAdmin ? Reports : Reports.Take(15))" TItem="LocationReport">
                                <Template Context="r">
                                    <RadzenCard id="@(r.Id == SelectedReportId ? "selected-report-card" : null)" Class="@GetReportCardClass(r)" Style="@GetReportCardStyle(r)">
                                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: bold;">@TimeZoneService.FormatLocal(r.Timestamp, "g")</RadzenText>
                                            @if (r.IsEmergency)
                                            {
                                                <RadzenBadge Text="EMERGENCY" BadgeStyle="BadgeStyle.Danger" Size="BadgeSize.ExtraSmall" />
                                            }
                                        </RadzenStack>
                                        @if (!string.IsNullOrEmpty(r.Message))
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-text-wrap" Style="font-size: 0.85rem;">@r.Message</RadzenText>
                                        }
                                        @if (_isAdmin)
                                        {
                                            <RadzenStack Gap="0" Class="rz-mt-2 rz-pt-2" Style="@(r.IsEmergency ? "border-top: 1px dashed rgba(255,0,0,0.2); opacity: 0.8;" : "border-top: 1px dashed rgba(0,0,0,0.1); opacity: 0.8;")">
                                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                                    <RadzenText TextStyle="TextStyle.Caption" Style="font-family: monospace; font-weight: bold;">ID: @r.ReporterIdentifier</RadzenText>
                                                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.ExtraSmall" Variant="Variant.Flat" Click="@(() => EditReport(r))" />
                                                </RadzenStack>
                                                <RadzenText TextStyle="TextStyle.Caption">Loc: @r.LocationDisplay()</RadzenText>
                                                @if (r.HasReporterLocation())
                                                {
                                                    <RadzenText TextStyle="TextStyle.Caption">Rep: @r.ReporterLocationDisplay()</RadzenText>
                                                }
                                            </RadzenStack>
                                        }
                                    </RadzenCard>
                                </Template>
                            </RadzenDataList>
                        </div>

                        @if (!_isAdmin && Reports.Count > 15)
                        {
                            <RadzenText TextStyle="TextStyle.Caption" Class="rz-text-align-center opacity-75">+ @(Reports.Count - 15) more reports</RadzenText>
                        }
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="opacity-75 rz-p-4 text-center">No reports in this area.</RadzenText>
                    }
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Alert Zones" Icon="notifications">
                <RadzenStack Gap="0.5rem">
                    @if (Alerts.Any())
                    {
                        <div style="max-height: 300px; overflow-y: auto;">
                            <RadzenDataList Data="@Alerts" TItem="Alert">
                                <Template Context="a">
                                    <RadzenCard id="@(a.Id == SelectedAlertId ? "selected-alert-card" : null)" Class="@GetAlertCardClass(a)" Style="@GetAlertCardStyle(a)">
                                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                            <RadzenStack Gap="0">
                                                <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin-bottom: 0;">@GetAlertName(a)</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Caption">Radius: @a.RadiusKm km</RadzenText>
                                                @if (_isAdmin)
                                                {
                                                    <RadzenText TextStyle="TextStyle.Caption" Style="font-family: monospace; font-weight: bold;">ID: @a.UserIdentifier</RadzenText>
                                                }
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                                @if (_isAdmin)
                                                {
                                                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Variant="Variant.Flat"
                                                                  Click="@(() => EditAlert(a))" />
                                                }
                                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Variant="Variant.Flat"
                                                              Click="@(() => DeleteAlert(a))" />
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenCard>
                                </Template>
                            </RadzenDataList>
                        </div>
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="opacity-75 rz-p-4 text-center">No alert zones in this area.</RadzenText>
                    }
                </RadzenStack>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Class="rz-mt-3">
        <RadzenButton Text="CLOSE" Click="@(() => DialogService.Close(_alertDeleted))" ButtonStyle="ButtonStyle.Primary" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public List<LocationReport> Reports { get; set; } = [];
    [Parameter] public List<Alert> Alerts { get; set; } = [];
    [Parameter] public int? SelectedReportId { get; set; }
    [Parameter] public int? SelectedAlertId { get; set; }

    private bool _alertDeleted;
    private bool _isAdmin;
    private int _selectedTabIndex;

    private string GetReportCardClass(LocationReport r)
    {
        var baseClass = "rz-p-2 rz-mb-1";
        return r.Id == SelectedReportId ? $"{baseClass} rz-border-primary rz-shadow-4" : baseClass;
    }

    private string GetReportCardStyle(LocationReport r)
    {
        var style = r.IsEmergency
            ? "border-left: 4px solid var(--rz-danger); background-color: var(--rz-danger-lighter);"
            : "border-left: 4px solid var(--rz-info);";

        if (r.Id == SelectedReportId)
        {
            style += " border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px;";
        }
        return style;
    }

    private string GetAlertCardClass(Alert a)
    {
        var baseClass = "rz-p-2 rz-mb-1";
        return a.Id == SelectedAlertId ? $"{baseClass} rz-border-primary rz-shadow-4" : baseClass;
    }

    private string GetAlertCardStyle(Alert a)
    {
        var style = "border-left: 4px solid #ff9800;";
        if (a.Id == SelectedAlertId)
        {
            style += " border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px;";
        }
        return style;
    }

    private int EmergencyCount => Reports.Count(r => r.IsEmergency);
    private DateTime MostRecentTimestamp => Reports.Any() ? Reports.Max(r => r.Timestamp) : DateTime.MinValue;

    protected override async Task OnInitializedAsync()
    {
        _isAdmin = await AdminService.IsAdminAsync();

        if (SelectedAlertId.HasValue && !SelectedReportId.HasValue)
        {
            _selectedTabIndex = 1;
        }
    }

    private async Task EditReport(LocationReport report)
    {
        var result = await DialogService.OpenAsync<ReportDialog>($"Edit Report {report.Id}", 
            new Dictionary<string, object> { { "Report", report }, { "IsAdminMode", true } },
            DialogConfigs.Admin);

        if (result == true)
        {
            _alertDeleted = true; // Trigger refresh on close
            DialogService.Close(true); // Close details and refresh map
        }
    }

    private async Task DeleteAlert(Alert alert)
    {
        var extra = string.IsNullOrEmpty(alert.Message) ? "" : $" ({alert.Message})";
        var confirmed = await DialogService.Confirm($"Are you sure you want to delete this alert zone?{extra}", 
            "Delete Alert", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            await AlertService.DeactivateAlertAsync(alert.Id);
            Alerts.Remove(alert);
            _alertDeleted = true;
            NotificationService.Notify(NotificationSeverity.Success, "Alert deleted");
            StateHasChanged();
        }
    }

    private async Task EditAlert(Alert alert)
    {
        var result = await DialogService.OpenAsync<AdminEditAlertDialog>($"Edit Alert {alert.Id}", 
            new Dictionary<string, object> { { "Alert", alert } },
            DialogConfigs.Admin);

        if (result == true)
        {
            _alertDeleted = true; // Trigger refresh on close
            DialogService.Close(true); // Close details and refresh map
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Small delay to ensure the DOM is ready and tabs are rendered
            await Task.Delay(100);
            if (SelectedReportId.HasValue)
            {
                await JsRuntime.InvokeVoidAsync("scrollToElement", "selected-report-card");
            }
            else if (SelectedAlertId.HasValue)
            {
                await JsRuntime.InvokeVoidAsync("scrollToElement", "selected-alert-card");
            }
        }
    }

    private static string TimeAgo(DateTime dateTime)
    {
        var span = DateTime.UtcNow - dateTime;
        if (span.TotalSeconds < 30)
        {
            return "just now";
        }

        if (span.TotalMinutes < 1)
        {
            return "less than a minute ago";
        }

        if (span.TotalMinutes < 60)
        {
            return $"{(int)span.TotalMinutes}m ago";
        }

        if (span.TotalHours < 24)
        {
            return $"{(int)span.TotalHours}h ago";
        }

        return $"{(int)span.TotalDays}d ago";
    }

    private static string GetAlertName(Alert alert)
    {
        return string.IsNullOrEmpty(alert.Message) ? "Alert Zone" : alert.Message;
    }
}
