@using WhereAreThey.Components.Admin
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@using WhereAreThey.Helpers
@inject DialogService DialogService
@inject IAlertService AlertService
@inject IReportService ReportService
@inject IClientStorageService StorageService
@inject NotificationService NotificationService
@inject UserTimeZoneService TimeZoneService
@inject IAdminService AdminService
@inject IMapStateService MapState
@inject IJSRuntime JsRuntime

<RadzenStack Gap="1rem" Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-primary-darker); font-weight: bold;">Area Details</RadzenText>
    
    <RadzenTabs RenderMode="TabRenderMode.Client" @bind-SelectedIndex="_selectedTabIndex">
        <Tabs>
            <RadzenTabsItem Text="Reports" Icon="visibility">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Body1">Reports in this area:</RadzenText>
                        <RadzenBadge Text="@Reports.Count.ToString()" BadgeStyle="BadgeStyle.Primary" />
                    </RadzenStack>

                    @if (EmergencyCount > 0)
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" ShowIcon="true" Variant="Variant.Flat" Shade="Shade.Lighter" AllowClose="false">
                            <b>@EmergencyCount</b> emergency reports detected!
                        </RadzenAlert>
                    }

                    @if (Reports.Any())
                    {
                        <RadzenText TextStyle="TextStyle.Caption">
                            <strong>Most recent:</strong> @TimeZoneService.FormatLocal(MostRecentCreatedAt) 
                            <span class="rz-color-info">(@DateTimeUtils.GetTimeAgo(MostRecentCreatedAt))</span>
                        </RadzenText>

                        <div style="max-height: 400px; overflow-y: auto;">
                            <RadzenDataList Data="@(_isAdmin ? Reports : Reports.Take(15))" TItem="Report">
                                <Template Context="r">
                                    <ReportCard Report="@r" 
                                                IsSelected="@(r.Id == SelectedReportId)"
                                                IsAdmin="@_isAdmin"
                                                CurrentUserIdentifier="@_userIdentifier"
                                                OnEdit="@(() => EditReport(r))"
                                                OnDelete="@(() => DeleteReport(r))" />
                                </Template>
                            </RadzenDataList>
                        </div>

                        @if (!_isAdmin && Reports.Count > 15)
                        {
                            <RadzenText TextStyle="TextStyle.Caption" Class="rz-text-align-center opacity-75">+ @(Reports.Count - 15) more reports</RadzenText>
                        }
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="opacity-75 rz-p-4 text-center">No reports in this area.</RadzenText>
                    }
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Alert Zones" Icon="notifications">
                <RadzenStack Gap="0.5rem">
                    @if (Alerts.Any())
                    {
                        <div style="max-height: 300px; overflow-y: auto;">
                            <RadzenDataList Data="@Alerts" TItem="Alert">
                                <Template Context="a">
                                    <AlertCard Alert="@a" 
                                               IsSelected="@(a.Id == SelectedAlertId)"
                                               IsAdmin="@_isAdmin"
                                               OnEdit="@(() => EditAlert(a))"
                                               OnDeactivate="@(() => DeleteAlert(a))" />
                                </Template>
                            </RadzenDataList>
                        </div>
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="opacity-75 rz-p-4 text-center">No alert zones in this area.</RadzenText>
                    }
                </RadzenStack>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Class="rz-mt-3">
        <RadzenButton Text="CLOSE" Click="@(() => DialogService.Close(_alertDeleted))" ButtonStyle="ButtonStyle.Primary" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public List<Report> Reports { get; set; } = [];
    [Parameter] public List<Alert> Alerts { get; set; } = [];
    [Parameter] public int? SelectedReportId { get; set; }
    [Parameter] public int? SelectedAlertId { get; set; }

    private bool _alertDeleted;
    private bool _isAdmin;
    private string? _userIdentifier;
    private int _selectedTabIndex;

    private int EmergencyCount => Reports.Count(r => r.IsEmergency);
    private DateTime MostRecentCreatedAt => Reports.Any() ? Reports.Max(r => r.CreatedAt) : DateTime.MinValue;

    protected override async Task OnInitializedAsync()
    {
        _isAdmin = await AdminService.IsAdminAsync();
        _userIdentifier = await StorageService.GetUserIdentifierAsync();

        if (SelectedAlertId.HasValue && !SelectedReportId.HasValue)
        {
            _selectedTabIndex = 1;
        }
    }

    private async Task EditReport(IEntity report)
    {
        var result = await DialogService.OpenAsync<AdminEditReportDialog>($"Edit Report {report.Id}", 
            new Dictionary<string, object> { { "Report", report } },
            DialogConfigs.Admin);

        if (result == true)
        {
            _alertDeleted = true; // Trigger refresh on close
            DialogService.Close(true); // Close details and refresh map
        }
    }

    private async Task DeleteReport(Report report)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this report?", 
            "Delete Report", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            var result = await ReportService.DeleteReportAsync(report.Id, MapState.ShowDeleted);
            if (result.IsSuccess)
            {
                Reports.Remove(report);
                _alertDeleted = true;
                NotificationService.Notify(NotificationSeverity.Success, "Report deleted");
                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Failed to delete report", result.Error ?? "Unknown error");
            }
        }
    }

    private async Task DeleteAlert(Alert alert)
    {
        var extra = string.IsNullOrEmpty(alert.Message) ? "" : $" ({alert.Message})";
        var confirmed = await DialogService.Confirm($"Are you sure you want to delete this alert zone?{extra}", 
            "Delete Alert", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            await AlertService.DeleteAlertAsync(alert.Id, MapState.ShowDeleted);
            Alerts.Remove(alert);
            _alertDeleted = true;
            NotificationService.Notify(NotificationSeverity.Success, "Alert deleted");
            StateHasChanged();
        }
    }

    private async Task EditAlert(IEntity alert)
    {
        var result = await DialogService.OpenAsync<AdminEditAlertDialog>($"Edit Alert {alert.Id}", 
            new Dictionary<string, object> { { "Alert", alert } },
            DialogConfigs.Admin);

        if (result == true)
        {
            _alertDeleted = true; // Trigger refresh on close
            DialogService.Close(true); // Close details and refresh map
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Small delay to ensure the DOM is ready and tabs are rendered
            await Task.Delay(100);
            if (SelectedReportId.HasValue)
            {
                await JsRuntime.InvokeVoidAsync("scrollToElement", "selected-report-card");
            }
            else if (SelectedAlertId.HasValue)
            {
                await JsRuntime.InvokeVoidAsync("scrollToElement", "selected-alert-card");
            }
        }
    }
}
