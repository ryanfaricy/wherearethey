@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@using WhereAreThey.Services
@using WhereAreThey.Components.Home
@inject IReportService ReportService
@inject IMapService MapService
@inject ILogger<AdminMapFeed> Logger
@inject UserTimeZoneService TimeZoneService
@inject IEventService EventService
@implements IDisposable

<RadzenRow>
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard Class="rz-p-0" Style="height: 500px; position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.1);">
            <HeatMap @ref="_heatMap"
                     ElementId="admin-map"
                     Reports="@_reports"
                     IsAdmin="true" />
            <div style="position: absolute; top: 10px; right: 10px; z-index: 1000;">
                <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="LIVE MAP" />
            </div>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard Style="height: 500px; display: flex; flex-direction: column;" Class="rz-p-0">
            <div class="rz-p-3 rz-background-color-primary-lighter" style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <RadzenText TextStyle="TextStyle.H6" Class="rz-m-0">Live Report Feed</RadzenText>
            </div>
            <div style="flex: 1; overflow-y: auto;" class="rz-p-3">
                <RadzenStack Gap="1rem">
                    @if (!_reports.Any())
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-text-align-center rz-mt-4">No recent reports.</RadzenText>
                    }
                    @foreach (var report in _reports.Take(20))
                    {
                        <RadzenCard Variant="Variant.Flat" 
                                    Class="@(report.IsEmergency ? "rz-background-color-danger-lighter" : "rz-background-color-base-100")" 
                                    Style="padding: 0.75rem; border: 1px solid rgba(0,0,0,0.05); cursor: pointer;"
                                    @onclick="@(() => FocusReportOnMap(report))">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.Caption">@TimeZoneService.FormatLocal(report.Timestamp)</RadzenText>
                                @if (report.IsEmergency)
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="EMERGENCY" />
                                }
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mt-2" Style="font-weight: 500;">
                                @(report.Message?.Length > 100 ? report.Message.Substring(0, 97) + "..." : report.Message)
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Class="rz-mt-1">
                                <RadzenIcon Icon="location_on" Style="font-size: 0.8rem;" /> @report.Latitude.ToString("F4"), @report.Longitude.ToString("F4")
                            </RadzenText>
                        </RadzenCard>
                    }
                </RadzenStack>
            </div>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private HeatMap? _heatMap;
    private List<LocationReport> _reports = new();
    private bool _mapInitialized;

    protected override async Task OnInitializedAsync()
    {
        _reports = await ReportService.GetAllReportsAsync();
        
        EventService.OnReportAdded += HandleReportAdded;
        EventService.OnReportUpdated += HandleReportUpdated;
        EventService.OnReportDeleted += HandleReportDeleted;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeMap();
        }
    }

    private async Task InitializeMap()
    {
        if (_mapInitialized || _heatMap == null) return;
        
        try 
        {
            double lat = 0;
            double lng = 0;
            if (_reports.Any())
            {
                lat = _reports.Average(r => r.Latitude);
                lng = _reports.Average(r => r.Longitude);
            }

            await _heatMap.InitializeAsync(lat, lng);
            _mapInitialized = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize admin map");
        }
    }

    private async Task FocusReportOnMap(LocationReport report)
    {
        if (_mapInitialized)
        {
            await MapService.FocusReportAsync(report.Id);
        }
    }

    private void HandleReportAdded(LocationReport report)
    {
        InvokeAsync(async () =>
        {
            _reports.Insert(0, report);
            if (_mapInitialized)
            {
                await MapService.AddSingleReportAsync(report);
            }
            StateHasChanged();
        });
    }

    private void HandleReportUpdated(LocationReport report)
    {
        InvokeAsync(async () =>
        {
            var index = _reports.FindIndex(r => r.Id == report.Id);
            if (index != -1)
            {
                _reports[index] = report;
                if (_mapInitialized)
                {
                    // Update by removing and adding back
                    await MapService.RemoveSingleReportAsync(report.Id);
                    await MapService.AddSingleReportAsync(report);
                }
                StateHasChanged();
            }
        });
    }

    private void HandleReportDeleted(int id)
    {
        InvokeAsync(async () =>
        {
            _reports.RemoveAll(r => r.Id == id);
            if (_mapInitialized)
            {
                await MapService.RemoveSingleReportAsync(id);
            }
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        EventService.OnReportAdded -= HandleReportAdded;
        EventService.OnReportUpdated -= HandleReportUpdated;
        EventService.OnReportDeleted -= HandleReportDeleted;
    }
}
