@inject IAlertService AlertService
@inject IReportService ReportService
@inject IMapService MapService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject ILogger<AdminMapFeed> Logger
@inject UserTimeZoneService TimeZoneService
@inject IMapStateService MapState
@inject IMapInteractionService MapInteraction
@using WhereAreThey.Components.Home
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@implements IDisposable

<RadzenRow>
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard Class="rz-p-0" Style="height: 500px; position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.1);">
            <HeatMap @ref="_heatMap"
                     ElementId="admin-map"
                     Reports="@MapState.Reports"
                     Alerts="@(new List<Alert>())"
                     IsAdmin="true"
                     OnMapClick="@OnHeatMapClick"
                     OnMapContextMenu="@OnHeatMapContextMenu"
                     OnAlertDeleteClick="@OnHeatMapAlertDeleteClick" />
            <div style="position: absolute; top: 10px; right: 10px; z-index: 1000;">
                <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="LIVE MAP" />
            </div>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard Style="height: 500px; display: flex; flex-direction: column;" Class="rz-p-0">
            <div class="rz-p-3 rz-background-color-primary-lighter" style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <RadzenText TextStyle="TextStyle.H6" Class="rz-m-0">Live Report Feed</RadzenText>
            </div>
            <div style="flex: 1; overflow-y: auto;" class="rz-p-3">
                <RadzenStack Gap="1rem">
                    @if (!MapState.Reports.Any())
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-text-align-center rz-mt-4">No recent reports.</RadzenText>
                    }
                    @foreach (var report in MapState.Reports.Take(20))
                    {
                        <ReportCard Report="@report" 
                                    MaxMessageLength="100"
                                    IsAdmin="true"
                                    OnClick="@(() => FocusReportOnMap(report))"
                                    OnDelete="@(() => DeleteReport(report))" />
                    }
                </RadzenStack>
            </div>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private HeatMap? _heatMap;

    protected override async Task OnInitializedAsync()
    {
        MapState.OnStateChanged += HandleStateChanged;
        await MapState.InitializeAsync(null, isAdmin: true);
        await MapState.LoadReportsAsync();
    }

    private void HandleStateChanged() => InvokeAsync(StateHasChanged);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeMap();
        }
    }

    private async Task InitializeMap()
    {
        if (MapState.MapInitialized || _heatMap == null)
        {
            return;
        }

        try 
        {
            double lat = 0;
            double lng = 0;
            if (MapState.Reports.Any())
            {
                lat = MapState.Reports.Average(r => r.Latitude);
                lng = MapState.Reports.Average(r => r.Longitude);
            }

            await _heatMap.InitializeAsync(lat, lng);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize admin map");
        }
    }

    private async Task FocusReportOnMap(LocationReport report)
    {
        if (MapState.MapInitialized)
        {
            await MapService.FocusReportAsync(report.Id);
        }
    }

    private async Task OnHeatMapClick(HeatMap.MapClickEventArgs args) => await MapInteraction.HandleMapClickAsync(args.Lat, args.Lng, args.IsMarkerClick, args.ReportId, args.AlertId, alertCreationMode: false);

    private async Task OnHeatMapContextMenu(HeatMap.MapLocationEventArgs args) => await MapInteraction.HandleMapContextMenuAsync(args.Lat, args.Lng, isAdmin: true, alertCreationMode: false);

    private async Task OnHeatMapAlertDeleteClick(int alertId)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this alert zone?", "Delete Alert", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            await AlertService.DeleteAlertAsync(alertId);
            NotificationService.Notify(NotificationSeverity.Success, "Alert deleted");
        }
    }

    private async Task DeleteReport(LocationReport report)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this report?", "Delete Report", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            var result = await ReportService.DeleteReportAsync(report.Id);
            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Report deleted");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", result.Error ?? "Unknown error");
            }
        }
    }

    public void Dispose()
    {
        MapState.OnStateChanged -= HandleStateChanged;
    }
}
