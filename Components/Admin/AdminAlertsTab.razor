@inject IAlertService AlertService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IJSRuntime JsRuntime
@inject ILogger<AdminAlertsTab> Logger
@inject IEventService EventService
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@implements IDisposable

@if (IsMobile)
{
    <RadzenDataList Data="@_alerts" TItem="Alert" AllowPaging="true" PageSize="10">
        <Template Context="alert">
            <RadzenCard Class="rz-mb-4">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">
                            @AlertService.DecryptEmail(alert.EncryptedEmail)
                        </RadzenText>
                        <RadzenBadge BadgeStyle="@(alert.IsVerified ? BadgeStyle.Success : BadgeStyle.Warning)" 
                                     Text="@(alert.IsVerified ? "VERIFIED" : "PENDING")" />
                    </RadzenStack>
                    
                    <RadzenText TextStyle="TextStyle.Body1">@alert.Message</RadzenText>
                    
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption"><b>User ID:</b> @alert.UserIdentifier</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption"><b>Radius:</b> @alert.RadiusKm km</RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                             <RadzenText TextStyle="TextStyle.Caption"><b>Status:</b></RadzenText>
                             <RadzenBadge BadgeStyle="@(alert.DeletedAt == null ? BadgeStyle.Info : BadgeStyle.Secondary)" 
                                          Text="@(alert.DeletedAt == null ? "ACTIVE" : "OFF")" />
                        </RadzenStack>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End" Class="rz-mt-2">
                        <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                      Click="@(() => OpenOnMap(alert))" Text="MAP" />
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                      Click="@(() => EditAlert(alert))" Text="EDIT" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                      Click="@(() => DeleteAlert(alert.Id))" Text="DELETE" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </Template>
    </RadzenDataList>
}
else
{
    <RadzenDataGrid @ref="_alertsGrid" Data="@_alerts" TItem="Alert" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="Alert" Property="Id" Title="ID" />
            <RadzenDataGridColumn TItem="Alert" Title="Email">
                <Template Context="alert">
                    @AlertService.DecryptEmail(alert.EncryptedEmail)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="Message" Title="Message" />
            <RadzenDataGridColumn TItem="Alert" Property="UserIdentifier" Title="User Identifier" />
            <RadzenDataGridColumn TItem="Alert" Property="IsVerified" Title="Verified">
                <Template Context="alert">
                    <RadzenBadge BadgeStyle="@(alert.IsVerified ? BadgeStyle.Success : BadgeStyle.Warning)" 
                                 Text="@(alert.IsVerified ? "YES" : "NO")" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="DeletedAt" Title="Active">
                <Template Context="alert">
                    <RadzenBadge BadgeStyle="@(alert.DeletedAt == null ? BadgeStyle.Info : BadgeStyle.Secondary)" 
                                 Text="@(alert.DeletedAt == null ? "ACTIVE" : "OFF")" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="RadiusKm" Title="Radius (km)" />
            <RadzenDataGridColumn TItem="Alert" Title="Actions" Filterable="false" Sortable="false">
                <Template Context="alert">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                      Click="@(() => OpenOnMap(alert))" ToolTip="Show on Map" />
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                      Click="@(() => EditAlert(alert))" ToolTip="Edit Alert" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                      Click="@(() => DeleteAlert(alert.Id))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    [Parameter] public bool IsMobile { get; set; }
    
    private List<Alert> _alerts = [];
    private RadzenDataGrid<Alert>? _alertsGrid;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        EventService.OnAlertAdded += HandleAlertAdded;
        EventService.OnAlertUpdated += HandleAlertUpdated;
        EventService.OnAlertDeleted += HandleAlertDeleted;
    }

    private async Task LoadData()
    {
        try
        {
            _alerts = await AlertService.GetAllAlertsAdminAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading alerts");
        }
    }

    private void HandleAlertAdded(Alert alert)
    {
        InvokeAsync(async () =>
        {
            _alerts.Insert(0, alert);
            if (_alertsGrid != null)
            {
                await _alertsGrid.Reload();
            }

            StateHasChanged();
        });
    }

    private void HandleAlertUpdated(Alert alert)
    {
        InvokeAsync(async () =>
        {
            var index = _alerts.FindIndex(a => a.Id == alert.Id);
            if (index != -1)
            {
                _alerts[index] = alert;
                if (_alertsGrid != null)
                {
                    await _alertsGrid.Reload();
                }

                StateHasChanged();
            }
        });
    }

    private void HandleAlertDeleted(int id)
    {
        InvokeAsync(async () =>
        {
            _alerts.RemoveAll(a => a.Id == id);
            if (_alertsGrid != null)
            {
                await _alertsGrid.Reload();
            }

            StateHasChanged();
        });
    }

    private async Task DeleteAlert(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this alert? This cannot be undone.", "Delete Alert", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirm == true)
        {
            var result = await AlertService.DeleteAlertAsync(id);
            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Alert deleted");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", result.Error ?? "Unknown error");
            }
        }
    }

    private async Task OpenOnMap(Alert alert)
    {
        var url = $"/?alertId={alert.ExternalId}";
        await JsRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    private async Task EditAlert(Alert alert)
    {
        var result = await DialogService.OpenAsync<AdminEditAlertDialog>($"Edit Alert {alert.Id}", 
            new Dictionary<string, object> { { "Alert", alert } },
            DialogConfigs.Admin);

        if (result == true)
        {
            await LoadData();
        }
    }

    public void Dispose()
    {
        EventService.OnAlertAdded -= HandleAlertAdded;
        EventService.OnAlertUpdated -= HandleAlertUpdated;
        EventService.OnAlertDeleted -= HandleAlertDeleted;
    }
}
