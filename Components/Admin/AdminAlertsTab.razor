@inherits AdminTabBase<Alert>
@inject IAlertService AlertService
@inject DialogService DialogService
@inject IJSRuntime JsRuntime
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces

@if (IsMobile)
{
    @if (Items.Any())
    {
        <RadzenDataList Data="@Items" TItem="Alert" AllowPaging="true" PageSize="10">
            <Template Context="alert">
                <RadzenCard Class="app-card app-card-warning">
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">
                                @AlertService.DecryptEmail(alert.EncryptedEmail)
                            </RadzenText>
                            <RadzenBadge BadgeStyle="@(alert.IsVerified ? BadgeStyle.Success : BadgeStyle.Warning)" 
                                         Text="@(alert.IsVerified ? "VERIFIED" : "PENDING")" />
                        </RadzenStack>
                        
                        <RadzenText TextStyle="TextStyle.Body1">@alert.Message</RadzenText>
                        
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Caption"><b>User ID:</b> @alert.UserIdentifier</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption"><b>Radius:</b> @alert.RadiusKm km</RadzenText>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                                <RadzenText TextStyle="TextStyle.Caption"><b>Notify:</b></RadzenText>
                                @if (alert.UseEmail) { <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="EMAIL" /> }
                                @if (alert.UsePush) { <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="PUSH" /> }
                                <RadzenText TextStyle="TextStyle.Caption" Class="rz-ml-2"><b>Status:</b></RadzenText>
                                <RadzenBadge BadgeStyle="@(alert.DeletedAt == null ? BadgeStyle.Info : BadgeStyle.Secondary)" 
                                             Text="@(alert.DeletedAt == null ? L["ACTIVE"] : L["DELETED"])" />
                            </RadzenStack>
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End" Class="rz-mt-2">
                            <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                          Click="@(() => OpenOnMap(alert))" Text="MAP" />
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                          Click="@(() => EditAlert(alert))" Text="EDIT" />
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                          Click="@(() => DeleteAlert(alert.Id))" Text="DELETE" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </Template>
        </RadzenDataList>
    }
    else
    {
        <RadzenText TextStyle="TextStyle.Body2" Class="rz-p-4 text-center opacity-75">@L["No_alerts_found"]</RadzenText>
    }
}
else
{
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" Class="rz-mb-4">
        <RadzenButton Icon="delete_sweep" ButtonStyle="ButtonStyle.Danger" 
                      Text="@($"Delete Selected ({(SelectedItems?.Count ?? 0)})")" 
                      Disabled="@(SelectedItems == null || !SelectedItems.Any())" 
                      Click="@DeleteSelected" />
    </RadzenStack>

    <RadzenDataGrid @ref="Grid" Data="@Items" TItem="Alert" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true"
                    SelectionMode="DataGridSelectionMode.Multiple" @bind-Value="@SelectedItems">
        <EmptyTemplate>
            <RadzenText TextStyle="TextStyle.Body2" Class="rz-p-4 text-center opacity-75">@L["No_alerts_found"]</RadzenText>
        </EmptyTemplate>
        <Columns>
            <RadzenDataGridColumn TItem="Alert" Width="60px" Sortable="false" Filterable="false">
                <HeaderTemplate>
                    <RadzenCheckBox TabIndex="-1" TriState="false" TValue="bool" 
                                    Value="@(Items.Any() && SelectedItems != null && SelectedItems.Count == Items.Count)"
                                    Change="@(args => SelectedItems = args ? Items.Cast<Alert>().ToList() : new List<Alert>())" />
                </HeaderTemplate>
                <Template Context="alert">
                    <RadzenCheckBox TabIndex="-1" TriState="false" Value="@(SelectedItems != null && SelectedItems.Contains(alert))" 
                                    TValue="bool" Change=@(args => Grid!.SelectRow(alert)) />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="Id" Title="ID" />
            <RadzenDataGridColumn TItem="Alert" Title="Email">
                <Template Context="alert">
                    @AlertService.DecryptEmail(alert.EncryptedEmail)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="Message" Title="Message" />
            <RadzenDataGridColumn TItem="Alert" Property="UserIdentifier" Title="User Identifier" />
            <RadzenDataGridColumn TItem="Alert" Property="IsVerified" Title="Verified">
                <Template Context="alert">
                    <RadzenBadge BadgeStyle="@(alert.IsVerified ? BadgeStyle.Success : BadgeStyle.Warning)" 
                                 Text="@(alert.IsVerified ? "YES" : "NO")" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="UseEmail" Title="Email Notifications">
                <Template Context="alert">
                    <RadzenBadge BadgeStyle="@(alert.UseEmail ? BadgeStyle.Info : BadgeStyle.Secondary)" 
                                 Text="@(alert.UseEmail ? "YES" : "NO")" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="UsePush" Title="Push">
                <Template Context="alert">
                    <RadzenBadge BadgeStyle="@(alert.UsePush ? BadgeStyle.Info : BadgeStyle.Secondary)" 
                                 Text="@(alert.UsePush ? "YES" : "NO")" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="DeletedAt" Title="Status">
                <Template Context="alert">
                    <RadzenBadge BadgeStyle="@(alert.DeletedAt == null ? BadgeStyle.Info : BadgeStyle.Secondary)" 
                                 Text="@(alert.DeletedAt == null ? L["ACTIVE"] : L["DELETED"])" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Alert" Property="RadiusKm" Title="Radius (km)" />
            <RadzenDataGridColumn TItem="Alert" Title="Actions" Filterable="false" Sortable="false">
                <Template Context="alert">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                      Click="@(() => OpenOnMap(alert))" ToolTip="Show on Map" />
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                      Click="@(() => EditAlert(alert))" ToolTip="Edit Alert" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                      Click="@(() => DeleteAlert(alert.Id))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    protected override Task<List<Alert>> GetEntitiesAsync() => AlertService.GetAllAlertsAsync();

    private async Task DeleteAlert(int id)
    {
        var isHardDelete = MapState.ShowDeleted;
        var message = isHardDelete 
            ? "Are you sure you want to PERMANENTLY delete this alert? This cannot be undone." 
            : "Are you sure you want to delete this alert?";
        var title = isHardDelete ? "Hard Delete Alert" : "Delete Alert";

        var confirm = await DialogService.Confirm(message, title, 
            new ConfirmOptions { OkButtonText = isHardDelete ? "PERMANENTLY DELETE" : "Yes", CancelButtonText = "No" });

        if (confirm == true)
        {
            await ValidationService.ExecuteAsync(
                () => AlertService.DeleteAlertAsync(id, MapState.ShowDeleted),
                successMessage: "Alert deleted",
                errorTitle: "Delete failed",
                showHapticFeedback: false,
                logContext: $"AdminAlertsTab.DeleteAlert {id}"
            );
        }
    }

    private async Task DeleteSelected()
    {
        if (SelectedItems == null || !SelectedItems.Any()) return;

        var count = SelectedItems.Count;
        var isHardDelete = MapState.ShowDeleted;
        var message = isHardDelete 
            ? $"Are you sure you want to PERMANENTLY delete {count} selected alerts? This cannot be undone." 
            : $"Are you sure you want to delete {count} selected alerts?";
        var title = isHardDelete ? "Hard Delete Alerts" : "Delete Alerts";

        var confirm = await DialogService.Confirm(message, title, 
            new ConfirmOptions { OkButtonText = isHardDelete ? "PERMANENTLY DELETE ALL" : "Yes", CancelButtonText = "No" });
        
        if (confirm == true)
        {
            var ids = SelectedItems.Select(i => i.Id).ToList();
            await ValidationService.ExecuteAsync(
                async () =>
                {
                    var result = await AlertService.DeleteAlertsAsync(ids, MapState.ShowDeleted);
                    if (result.IsSuccess)
                    {
                        SelectedItems = null;
                    }
                    return result;
                },
                successMessage: $"{count} alerts deleted",
                errorTitle: "Mass delete failed",
                showHapticFeedback: false,
                logContext: $"AdminAlertsTab.DeleteSelected {count} items"
            );
        }
    }

    private async Task OpenOnMap(Alert alert)
    {
        var url = $"/?alertId={alert.ExternalId}";
        await JsRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    private async Task EditAlert(IEntity alert)
    {
        var result = await DialogService.OpenAsync<AdminEditAlertDialog>($"Edit Alert {alert.Id}", 
            new Dictionary<string, object> { { "Alert", alert } },
            DialogConfigs.Admin);

        if (result == true)
        {
            await LoadData();
        }
    }
}
