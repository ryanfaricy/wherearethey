@inject IDonationService DonationService
@inject UserTimeZoneService TimeZoneService
@inject ILogger<AdminDonationsTab> Logger
@inject IEventService EventService
@inject DialogService DialogService
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@implements IDisposable

<RadzenDataGrid @ref="_donationsGrid" Data="@_donations" TItem="Donation" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true" Density="@(IsMobile ? Density.Compact : Density.Default)">
    <Columns>
        <RadzenDataGridColumn TItem="Donation" Property="CreatedAt" Title="Date">
            <Template Context="donation">
                @TimeZoneService.FormatLocal(donation.CreatedAt)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Donation" Property="DonorEmail" Title="Donor" Visible="@(!IsMobile)" />
        <RadzenDataGridColumn TItem="Donation" Property="Amount" Title="Amount">
            <Template Context="donation">
                @donation.Amount @donation.Currency.ToUpper()
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Donation" Property="Status" Title="Status">
            <Template Context="donation">
                <RadzenBadge BadgeStyle="@(donation.IsSuccess() ? BadgeStyle.Success : BadgeStyle.Secondary)" 
                             Text="@donation.Status" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Donation" Context="donation" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Width="60px">
            <Template Context="donation">
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall" 
                              Click="@(() => EditDonation(donation))" @onclick:stopPropagation="true" />
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    [Parameter] public bool IsMobile { get; set; }
    
    private List<Donation> _donations = [];
    private RadzenDataGrid<Donation>? _donationsGrid;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        EventService.OnDonationAdded += HandleDonationAdded;
        EventService.OnDonationUpdated += HandleDonationUpdated;
    }

    private async Task LoadData()
    {
        try
        {
            _donations = await DonationService.GetAllDonationsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading donations");
        }
    }

    private async Task EditDonation(Donation donation)
    {
        var result = await DialogService.OpenAsync<AdminEditDonationDialog>("EDIT DONATION",
            new Dictionary<string, object> { { "Donation", donation } },
            new DialogOptions { Width = "400px" });

        if (result == true)
        {
            // Event listener will update the list automatically, but we can force a reload if needed.
            StateHasChanged();
        }
    }

    private void HandleDonationAdded(Donation donation)
    {
        InvokeAsync(async () =>
        {
            _donations.Insert(0, donation);
            if (_donationsGrid != null)
            {
                await _donationsGrid.Reload();
            }

            StateHasChanged();
        });
    }

    private void HandleDonationUpdated(Donation donation)
    {
        InvokeAsync(async () =>
        {
            var index = _donations.FindIndex(d => d.Id == donation.Id);
            if (index != -1)
            {
                _donations[index] = donation;
                if (_donationsGrid != null)
                {
                    await _donationsGrid.Reload();
                }

                StateHasChanged();
            }
        });
    }

    public void Dispose()
    {
        EventService.OnDonationAdded -= HandleDonationAdded;
        EventService.OnDonationUpdated -= HandleDonationUpdated;
    }
}
