@inherits AdminTabBase<Donation>
@inject IDonationService DonationService
@inject UserTimeZoneService TimeZoneService
@inject NotificationService NotificationService
@inject DialogService DialogService
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces

@if (IsMobile)
{
    <RadzenDataList Data="@Items" TItem="Donation" AllowPaging="true" PageSize="10" WrapItems="true">
        <Template Context="donation">
            <RadzenCard Class="app-card app-card-success">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">
                            @TimeZoneService.FormatLocal(donation.CreatedAt)
                        </RadzenText>
                        <RadzenBadge BadgeStyle="@(donation.IsSuccess() ? BadgeStyle.Success : BadgeStyle.Secondary)" 
                                     Text="@donation.Status" />
                        @if (donation.DeletedAt != null)
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="DELETED" />
                        }
                    </RadzenStack>
                    
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6" Class="rz-m-0">
                            @donation.Amount @donation.Currency.ToUpper()
                        </RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Small" 
                                          Click="@(() => EditDonation(donation))" Text="EDIT" />
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                          Click="@(() => DeleteDonation(donation.Id))" Text="DELETE" />
                        </RadzenStack>
                    </RadzenStack>
                    
                    <RadzenText TextStyle="TextStyle.Caption"><b>Donor:</b> @donation.DonorEmail</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </Template>
    </RadzenDataList>
}
else
{
    <RadzenDataGrid @ref="Grid" Data="@Items" TItem="Donation" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="Donation" Property="CreatedAt" Title="Date">
                <Template Context="donation">
                    @TimeZoneService.FormatLocal(donation.CreatedAt)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Donation" Property="DonorEmail" Title="Donor" />
            <RadzenDataGridColumn TItem="Donation" Property="Amount" Title="Amount">
                <Template Context="donation">
                    @donation.Amount @donation.Currency.ToUpper()
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Donation" Property="Status" Title="Status">
                <Template Context="donation">
                    <RadzenBadge BadgeStyle="@(donation.IsSuccess() ? BadgeStyle.Success : BadgeStyle.Secondary)" 
                                 Text="@donation.Status" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Donation" Property="DeletedAt" Title="Deleted">
                <Template Context="donation">
                    @if (donation.DeletedAt != null)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="YES" />
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Caption">NO</RadzenText>
                    }
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Donation" Context="donation" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Width="100px">
                <Template Context="donation">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall" 
                                      Click="@(() => EditDonation(donation))" @onclick:stopPropagation="true" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.ExtraSmall" 
                                      Click="@(() => DeleteDonation(donation.Id))" @onclick:stopPropagation="true" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    protected override Task<List<Donation>> GetEntitiesAsync() => DonationService.GetAllDonationsAsync();

    private async Task EditDonation(Donation donation)
    {
        var result = await DialogService.OpenAsync<AdminEditDonationDialog>("EDIT DONATION",
            new Dictionary<string, object> { { "Donation", donation } },
            new DialogOptions { Width = "400px" });

        if (result == true)
        {
            // Event listener will update the list automatically, but we can force a reload if needed.
            StateHasChanged();
        }
    }

    private async Task DeleteDonation(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this donation?", "Delete Donation", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
        
        if (confirm == true)
        {
            var result = await DonationService.DeleteDonationAsync(id, MapState.ShowDeleted);
            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Donation deleted");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", result.Error ?? "Unknown error");
            }
        }
    }
}
