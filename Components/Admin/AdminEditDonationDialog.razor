@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IDonationService DonationService
@inject IValidationService ValidationService
@inject DialogService DialogService

<RadzenTemplateForm Data="@_donation" Submit="@((Donation _) => Save())">
    <RadzenStack Gap="1rem" Class="rz-p-4">
        <RadzenFormField Text="Amount" Variant="Variant.Outlined" Style="width: 100%;">
            <RadzenNumeric @bind-Value="@_donation.Amount" TValue="decimal" 
                           ShowUpDown="true" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Currency" Variant="Variant.Outlined" Style="width: 100%;">
            <RadzenTextBox @bind-Value="@_donation.Currency" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Donor Name" Variant="Variant.Outlined" Style="width: 100%;">
            <RadzenTextBox @bind-Value="@_donation.DonorName" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Donor Email" Variant="Variant.Outlined" Style="width: 100%;">
            <RadzenTextBox @bind-Value="@_donation.DonorEmail" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
            <RadzenDropDown @bind-Value="@_donation.Status" Data="@_statuses" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenFormField Text="Created At" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDatePicker @bind-Value="@_donation.CreatedAt" ShowTime="true" ShowSeconds="true" DateFormat="MM/dd/yyyy HH:mm:ss" Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenFormField Text="Deleted At" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDatePicker @bind-Value="@_donation.DeletedAt" ShowTime="true" ShowSeconds="true" DateFormat="MM/dd/yyyy HH:mm:ss" Style="width: 100%;" AllowClear="true" />
                </RadzenFormField>
            </RadzenColumn>
        </RadzenRow>
        
        <RadzenText TextStyle="TextStyle.Caption" Class="rz-mt-2">
            Payment ID: @(_donation.ExternalPaymentId ?? "N/A")
        </RadzenText>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Class="rz-mt-4" JustifyContent="JustifyContent.End">
            <RadzenButton Text="CANCEL" Click="@(() => DialogService.Close(false))" ButtonStyle="ButtonStyle.Light" />
            <RadzenButton ButtonType="ButtonType.Submit" Text="SAVE CHANGES" 
                          Icon="save" ButtonStyle="ButtonStyle.Primary" 
                          IsBusy="@_isSubmitting" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Donation Donation { get; set; } = new();

    private Donation _donation = new();
    private bool _isSubmitting;
    private readonly List<string> _statuses = ["pending", "completed", "failed", "succeeded"];

    protected override void OnInitialized()
    {
        // Create a copy to edit
        _donation = new Donation
        {
            Id = Donation.Id,
            Amount = Donation.Amount,
            Currency = Donation.Currency,
            DonorName = Donation.DonorName,
            DonorEmail = Donation.DonorEmail,
            Status = Donation.Status,
            CreatedAt = Donation.CreatedAt,
            ExternalPaymentId = Donation.ExternalPaymentId,
            DeletedAt = Donation.DeletedAt,
        };
    }

    private async Task Save()
    {
        _isSubmitting = true;

        await ValidationService.ExecuteAsync(
            async () => await DonationService.UpdateAsync(_donation),
            successMessage: "Donation updated successfully",
            errorTitle: "Update failed",
            onSuccess: async () => DialogService.Close(true),
            showHapticFeedback: false,
            logContext: "AdminEditDonationDialog.Save"
        );

        _isSubmitting = false;
    }
}
