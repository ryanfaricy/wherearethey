@using System.Text.Json
@using Fido2NetLib
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject ISettingsService SettingsService
@inject IAdminPasskeyService PasskeyService
@inject IJSRuntime JsRuntime
@inject NotificationService NotificationService
@inject ILogger<AdminSettingsTab> Logger

<RadzenStack Gap="1.5rem">
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-4">Global Anti-Spam Settings</RadzenText>
        <RadzenStack Gap="1.5rem" Style="max-width: 500px;">
            <RadzenFormField Text="Report Expiry (Hours)" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@_systemSettings.ReportExpiryHours" TValue="int" Min="1" Max="168" />
                <RadzenText TextStyle="TextStyle.Caption">Reports disappear from public view after this many hours.</RadzenText>
            </RadzenFormField>

            <RadzenFormField Text="Submission Cooldown (Minutes)" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@_systemSettings.ReportCooldownMinutes" TValue="int" Min="1" Max="60" />
                <RadzenText TextStyle="TextStyle.Caption">Time users must wait between submitting reports or feedback.</RadzenText>
            </RadzenFormField>

            <RadzenFormField Text="Alert Creation Limit" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@_systemSettings.AlertLimitCount" TValue="int" Min="1" Max="100" />
                <RadzenText TextStyle="TextStyle.Caption">Number of alerts a user can create within the cooldown period.</RadzenText>
            </RadzenFormField>

            <RadzenFormField Text="Max Report Distance (Miles)" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@_systemSettings.MaxReportDistanceMiles" TValue="decimal" Min="0.1m" Max="100.0m" />
                <RadzenText TextStyle="TextStyle.Caption">Users must be within this distance of the reported location.</RadzenText>
            </RadzenFormField>

            <RadzenFormField Text="Mapbox Token (Optional)" Variant="Variant.Outlined">
                <RadzenTextBox @bind-Value="@_systemSettings.MapboxToken" />
                <RadzenText TextStyle="TextStyle.Caption">Required for map thumbnails in alert emails. Leave empty to disable thumbnails.</RadzenText>
            </RadzenFormField>

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenSwitch @bind-Value="@_systemSettings.DonationsEnabled" />
                <RadzenLabel Text="Enable Public Donations" />
            </RadzenStack>

            <RadzenButton Text="SAVE SETTINGS" Click="@SaveSettings" ButtonStyle="ButtonStyle.Primary" Icon="save" />
        </RadzenStack>
    </RadzenCard>

    <RadzenCard>
        <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-4">Admin Passkeys</RadzenText>
        <RadzenStack Gap="1rem">
            @if (_passkeys == null)
            {
                <RadzenProgressBar Circular="true" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            }
            else if (_passkeys.Count == 0)
            {
                <RadzenText Text="No passkeys registered." />
            }
            else
            {
                @if (IsMobile)
                {
                    <RadzenDataList Data="@_passkeys" TItem="AdminPasskey">
                        <Template Context="key">
                            <RadzenCard Class="rz-mb-2 rz-p-2">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenStack Gap="0">
                                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">@key.Name</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption">Created: @key.CreatedAt.ToShortDateString()</RadzenText>
                                    </RadzenStack>
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => DeletePasskey(key.Id))" />
                                </RadzenStack>
                            </RadzenCard>
                        </Template>
                    </RadzenDataList>
                }
                else
                {
                    <RadzenDataGrid Data="@_passkeys" TItem="AdminPasskey">
                        <Columns>
                            <RadzenDataGridColumn TItem="AdminPasskey" Property="Name" Title="Name" />
                            <RadzenDataGridColumn TItem="AdminPasskey" Property="CreatedAt" Title="Created" FormatString="{0:d}" />
                            <RadzenDataGridColumn TItem="AdminPasskey" Title="Actions" Width="100px">
                                <Template Context="key">
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => DeletePasskey(key.Id))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                }
            }

            <RadzenStack Orientation="@StackOrientation" 
                         AlignItems="@StackAlign" 
                         Gap="1rem" Class="rz-mt-4">
                @if (IsMobile)
                {
                    <RadzenTextBox @bind-Value="@_newKeyName" Placeholder="Passkey Name (e.g. My Phone)" Class="rz-w-100" />
                }
                else
                {
                    <RadzenTextBox @bind-Value="@_newKeyName" Placeholder="Passkey Name (e.g. My Phone)" Style="width: 250px" />
                }
                <RadzenButton Text="REGISTER NEW PASSKEY" Icon="add" Click="@RegisterPasskey" 
                              ButtonStyle="ButtonStyle.Secondary" Disabled="@(string.IsNullOrEmpty(_newKeyName))" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    [Parameter] public bool IsMobile { get; set; }
    private Orientation StackOrientation => IsMobile ? Orientation.Vertical : Orientation.Horizontal;
    private AlignItems StackAlign => IsMobile ? AlignItems.Stretch : AlignItems.Center;
    
    private SystemSettings _systemSettings = new();
    private List<AdminPasskey>? _passkeys;
    private string _newKeyName = "";
    private IJSObjectReference? _module;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./passkey.js");
        }
    }

    private async Task LoadData()
    {
        try
        {
            _systemSettings = await SettingsService.GetSettingsAsync();
            _passkeys = await PasskeyService.GetPasskeysAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading settings");
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            await SettingsService.UpdateSettingsAsync(_systemSettings);
            NotificationService.Notify(NotificationSeverity.Success, "Settings saved successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save settings");
            NotificationService.Notify(NotificationSeverity.Error, "Save failed", ex.Message);
        }
    }

    private async Task RegisterPasskey()
    {
        if (_module == null)
        {
            return;
        }

        try
        {
            var options = await PasskeyService.GetRegistrationOptionsAsync("admin@aretheyhere.com");
            var jsonOptions = options.ToJson();
            
            var responseJson = await _module.InvokeAsync<string>("registerPasskey", jsonOptions);
            var attestationRawResponse = JsonSerializer.Deserialize<AuthenticatorAttestationRawResponse>(responseJson);

            if (attestationRawResponse == null)
            {
                throw new Exception("Failed to parse authenticator response");
            }

            await PasskeyService.CompleteRegistrationAsync(attestationRawResponse, options, _newKeyName);
            
            _newKeyName = "";
            _passkeys = await PasskeyService.GetPasskeysAsync();
            NotificationService.Notify(NotificationSeverity.Success, "Passkey registered successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to register passkey");
            NotificationService.Notify(NotificationSeverity.Error, "Registration failed", ex.Message);
        }
    }

    private async Task DeletePasskey(int id)
    {
        try
        {
            await PasskeyService.DeletePasskeyAsync(id);
            _passkeys = await PasskeyService.GetPasskeysAsync();
            NotificationService.Notify(NotificationSeverity.Success, "Passkey deleted");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete passkey");
            NotificationService.Notify(NotificationSeverity.Error, "Delete failed", ex.Message);
        }
    }
}
