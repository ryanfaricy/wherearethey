@inherits LayoutComponentBase
@using System.Text.Json
@using Fido2NetLib
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject ISettingsService SettingsService
@inject IAdminPasskeyService PasskeyService
@inject IValidationService ValidationService
@inject NotificationService NotificationService
@inject IJSRuntime JsRuntime
@inject ILogger<AdminSettingsTab> Logger

<RadzenStack Gap="1.5rem">
    <RadzenCard Class="app-card">
        <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-4">Global Anti-Spam Settings</RadzenText>
        <RadzenStack Gap="1.5rem" Style="max-width: 500px;">
            <RadzenFormField Text="Report Expiry (Hours)" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@_systemSettings.ReportExpiryHours" TValue="int" Min="1" Max="168" />
                <RadzenText TextStyle="TextStyle.Caption">Reports disappear from public view after this many hours.</RadzenText>
            </RadzenFormField>

            <RadzenFormField Text="Submission Cooldown (Minutes)" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@_systemSettings.ReportCooldownMinutes" TValue="int" Min="1" Max="60" />
                <RadzenText TextStyle="TextStyle.Caption">Time users must wait between submitting reports or feedback.</RadzenText>
            </RadzenFormField>

            <RadzenFormField Text="Alert Creation Limit" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@_systemSettings.AlertLimitCount" TValue="int" Min="1" Max="100" />
                <RadzenText TextStyle="TextStyle.Caption">Number of alerts a user can create within the cooldown period.</RadzenText>
            </RadzenFormField>

            <RadzenFormField Text="Max Report Distance (Miles)" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@_systemSettings.MaxReportDistanceMiles" TValue="decimal" Min="0.1m" Max="100.0m" />
                <RadzenText TextStyle="TextStyle.Caption">Users must be within this distance of the reported location.</RadzenText>
            </RadzenFormField>

            <RadzenFormField Text="Mapbox Token (Optional)" Variant="Variant.Outlined">
                <RadzenTextBox @bind-Value="@_systemSettings.MapboxToken" />
                <RadzenText TextStyle="TextStyle.Caption">Required for map thumbnails in alert emails. Leave empty to disable thumbnails.</RadzenText>
            </RadzenFormField>

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenSwitch @bind-Value="@_systemSettings.DonationsEnabled" />
                <RadzenLabel Text="Enable Public Donations" />
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenSwitch @bind-Value="@_systemSettings.EmailNotificationsEnabled" />
                <RadzenLabel Text="Enable Global Email Notifications" />
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenSwitch @bind-Value="@_systemSettings.PushNotificationsEnabled" />
                <RadzenLabel Text="Enable Global Web Push Notifications" />
            </RadzenStack>

            <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-mt-4">Web Push Notifications (VAPID)</RadzenText>
            <RadzenFormField Text="VAPID Public Key" Variant="Variant.Outlined">
                <RadzenTextBox @bind-Value="@_systemSettings.VapidPublicKey" ReadOnly="true" />
            </RadzenFormField>
            <RadzenFormField Text="VAPID Private Key" Variant="Variant.Outlined">
                <RadzenTextBox @bind-Value="@_systemSettings.VapidPrivateKey" ReadOnly="true" />
            </RadzenFormField>
            <RadzenButton Text="REGENERATE VAPID KEYS" Click="@RegenerateVapidKeys" 
                          ButtonStyle="ButtonStyle.Warning" Size="ButtonSize.Small" Icon="refresh" 
                          Style="width: fit-content;" />

            <RadzenButton Text="SAVE SETTINGS" Click="@SaveSettings" ButtonStyle="ButtonStyle.Primary" Icon="save" />
        </RadzenStack>
    </RadzenCard>

    <RadzenCard Class="app-card">
        <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-4">Admin Passkeys</RadzenText>
        <RadzenStack Gap="1rem">
            @if (_passkeys == null)
            {
                <RadzenProgressBar Circular="true" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            }
            else if (_passkeys.Count == 0)
            {
                <RadzenText Text="No passkeys registered." />
            }
            else
            {
                @if (IsMobile)
                {
                    <RadzenDataList Data="@_passkeys" TItem="AdminPasskey" AllowPaging="true" PageSize="10">
                        <Template Context="key">
                            <RadzenCard Class="app-card app-card-info">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenStack Gap="0">
                                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">@key.Name</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption">Created: @key.CreatedAt.ToShortDateString()</RadzenText>
                                    </RadzenStack>
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => DeletePasskey(key.Id))" />
                                </RadzenStack>
                            </RadzenCard>
                        </Template>
                    </RadzenDataList>
                }
                else
                {
                    <RadzenDataGrid Data="@_passkeys" TItem="AdminPasskey">
                        <Columns>
                            <RadzenDataGridColumn TItem="AdminPasskey" Property="Name" Title="Name" />
                            <RadzenDataGridColumn TItem="AdminPasskey" Property="CreatedAt" Title="Created" FormatString="{0:d}" />
                            <RadzenDataGridColumn TItem="AdminPasskey" Title="Actions" Width="100px">
                                <Template Context="key">
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => DeletePasskey(key.Id))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                }
            }

            <RadzenStack Orientation="@StackOrientation" 
                         AlignItems="@StackAlign" 
                         Gap="1rem" Class="rz-mt-4">
                @if (IsMobile)
                {
                    <RadzenTextBox @bind-Value="@_newKeyName" Placeholder="Passkey Name (e.g. My Phone)" Class="rz-w-100" />
                }
                else
                {
                    <RadzenTextBox @bind-Value="@_newKeyName" Placeholder="Passkey Name (e.g. My Phone)" Style="width: 250px" />
                }
                <RadzenButton Text="REGISTER NEW PASSKEY" Icon="add" Click="@RegisterPasskey" 
                              ButtonStyle="ButtonStyle.Secondary" Disabled="@(string.IsNullOrEmpty(_newKeyName))" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private SystemSettings _systemSettings = new();
    private List<AdminPasskey>? _passkeys;
    private string _newKeyName = "";
    private IJSObjectReference? _module;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./passkey.js");
        }
    }

    private async Task LoadData()
    {
        try
        {
            _systemSettings = await SettingsService.GetSettingsAsync();
            _passkeys = await PasskeyService.GetPasskeysAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading settings");
        }
    }

    private async Task SaveSettings()
    {
        await ValidationService.ExecuteAsync(
            () => SettingsService.UpdateSettingsAsync(_systemSettings),
            successMessage: "Settings saved successfully",
            errorTitle: "Save failed",
            showHapticFeedback: false,
            logContext: "AdminSettingsTab.SaveSettings"
        );
    }

    private void RegenerateVapidKeys()
    {
        var keys = WebPush.VapidHelper.GenerateVapidKeys();
        _systemSettings.VapidPublicKey = keys.PublicKey;
        _systemSettings.VapidPrivateKey = keys.PrivateKey;
        StateHasChanged();
    }

    private async Task RegisterPasskey()
    {
        if (_module == null) return;

        await ValidationService.ExecuteAsync(
            async () =>
            {
                var options = await PasskeyService.GetRegistrationOptionsAsync("admin@aretheyhere.com");
                var jsonOptions = options.ToJson();

                var responseJson = await _module.InvokeAsync<string>("registerPasskey", jsonOptions);
                var attestationRawResponse = JsonSerializer.Deserialize<AuthenticatorAttestationRawResponse>(responseJson);

                if (attestationRawResponse == null)
                {
                    return Result.Failure("Failed to parse authenticator response");
                }

                return await PasskeyService.CompleteRegistrationAsync(attestationRawResponse, options, _newKeyName);
            },
            successMessage: "Passkey registered successfully",
            errorTitle: "Registration failed",
            onSuccess: async () =>
            {
                _newKeyName = "";
                _passkeys = await PasskeyService.GetPasskeysAsync();
            },
            showHapticFeedback: false,
            logContext: "AdminSettingsTab.RegisterPasskey"
        );
    }

    private async Task DeletePasskey(int id)
    {
        await ValidationService.ExecuteAsync(
            () => PasskeyService.DeletePasskeyAsync(id),
            successMessage: "Passkey deleted",
            errorTitle: "Delete failed",
            onSuccess: async () => _passkeys = await PasskeyService.GetPasskeysAsync(),
            showHapticFeedback: false,
            logContext: $"AdminSettingsTab.DeletePasskey {id}"
        );
    }
}
