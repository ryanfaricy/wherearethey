@inherits AdminTabBase<Feedback>
@inject IFeedbackService FeedbackService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject UserTimeZoneService TimeZoneService
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces

@if (IsMobile)
{
    <RadzenDataList Data="@Items" TItem="Feedback" AllowPaging="true" PageSize="10">
        <Template Context="feedback">
            <RadzenCard Class="rz-mb-4">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">
                            @TimeZoneService.FormatLocal(feedback.Timestamp)
                        </RadzenText>
                        <RadzenBadge BadgeStyle="@(feedback.Type == "Bug" ? BadgeStyle.Danger : BadgeStyle.Info)" Text="@feedback.Type" />
                    </RadzenStack>
                    
                    <RadzenText TextStyle="TextStyle.Body1">@feedback.Message</RadzenText>
                    
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" AlignItems="AlignItems.Center" Gap="0.5rem">
                         <RadzenText TextStyle="TextStyle.Caption" Style="flex: 1;"><b>User:</b> @feedback.UserIdentifier</RadzenText>
                         @if (feedback.DeletedAt != null)
                         {
                             <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="DELETED" />
                         }
                         <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                      Click="@(() => EditFeedback(feedback))" Text="EDIT" />
                         <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                      Click="@(() => DeleteFeedback(feedback.Id))" Text="DELETE" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </Template>
    </RadzenDataList>
}
else
{
    <RadzenDataGrid @ref="Grid" Data="@Items" TItem="Feedback" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="Feedback" Property="Id" Title="ID" />
            <RadzenDataGridColumn TItem="Feedback" Property="Timestamp" Title="Time">
                <Template Context="feedback">
                    @TimeZoneService.FormatLocal(feedback.Timestamp)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Feedback" Property="Type" Title="Type">
                <Template Context="fb">
                    <RadzenBadge BadgeStyle="@(fb.Type == "Bug" ? BadgeStyle.Danger : BadgeStyle.Info)" Text="@fb.Type" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Feedback" Property="Message" Title="Message" />
            <RadzenDataGridColumn TItem="Feedback" Property="UserIdentifier" Title="User Passphrase" />
            <RadzenDataGridColumn TItem="Feedback" Property="DeletedAt" Title="Status">
                <Template Context="fb">
                    @if (fb.DeletedAt != null)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="DELETED" />
                    }
                    else
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="ACTIVE" />
                    }
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Feedback" Title="Actions" Filterable="false" Sortable="false">
                <Template Context="fb">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                      Click="@(() => EditFeedback(fb))" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                      Click="@(() => DeleteFeedback(fb.Id))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    protected override Task<List<Feedback>> GetEntitiesAsync() => FeedbackService.GetAllFeedbackAsync();

    private async Task EditFeedback(Feedback feedback)
    {
        var result = await DialogService.OpenAsync<AdminEditFeedbackDialog>($"Edit Feedback {feedback.Id}", 
            new Dictionary<string, object> { { "Feedback", feedback } },
            DialogConfigs.Admin);

        if (result == true)
        {
            await LoadData();
            StateHasChanged();
        }
    }

    private async Task DeleteFeedback(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this feedback?", "Delete Feedback", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
        
        if (confirm == true)
        {
            try
            {
                await FeedbackService.DeleteFeedbackAsync(id);
                NotificationService.Notify(NotificationSeverity.Success, "Feedback deleted");
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", ex.Message);
            }
        }
    }
}
