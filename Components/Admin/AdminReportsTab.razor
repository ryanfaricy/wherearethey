@inject IReportService ReportService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject UserTimeZoneService TimeZoneService
@inject IJSRuntime JsRuntime
@inject ILogger<AdminReportsTab> Logger
@inject IMapStateService MapState
@using WhereAreThey.Components.Pages
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@implements IDisposable

<RadzenDataGrid @ref="_reportsGrid" Data="@MapState.Reports" TItem="LocationReport" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true" Density="@(IsMobile ? Density.Compact : Density.Default)">
    <Columns>
        <RadzenDataGridColumn TItem="LocationReport" Property="Id" Title="ID" Visible="@(!IsMobile)" />
        <RadzenDataGridColumn TItem="LocationReport" Property="Timestamp" Title="Time">
            <Template Context="report">
                @TimeZoneService.FormatLocal(report.Timestamp)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="LocationReport" Property="Message" Title="Message" />
        <RadzenDataGridColumn TItem="LocationReport" Property="ReporterIdentifier" Title="Reporter Passphrase" Visible="@(!IsMobile)" />
        <RadzenDataGridColumn TItem="LocationReport" Title="Reporter Location" Visible="@(!IsMobile)">
            <Template Context="report">
                @report.ReporterLocationDisplay()
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="LocationReport" Property="IsEmergency" Title="Emergency">
            <Template Context="report">
                <RadzenBadge BadgeStyle="@(report.IsEmergency ? BadgeStyle.Danger : BadgeStyle.Secondary)" 
                             Text="@(report.IsEmergency ? "YES" : "NO")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="LocationReport" Title="Location" Visible="@(!IsMobile)">
            <Template Context="report">
                @report.LocationDisplay()
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="LocationReport" Title="Actions" Filterable="false" Sortable="false">
            <Template Context="report">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                  Click="@(() => OpenOnMap(report))" ToolTip="Show on Map" />
                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                  Click="@(() => EditReport(report))" />
                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                  Click="@(() => DeleteReport(report.Id))" />
                </RadzenStack>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    [Parameter] public bool IsMobile { get; set; }
    
    private RadzenDataGrid<LocationReport>? _reportsGrid;

    protected override async Task OnInitializedAsync()
    {
        MapState.OnStateChanged += HandleStateChanged;
        await MapState.InitializeAsync(null, isAdmin: true);
        await MapState.LoadReportsAsync();
    }

    private void HandleStateChanged() => InvokeAsync(() => {
        _reportsGrid?.Reload();
        StateHasChanged();
    });

    private async Task EditReport(LocationReport report)
    {
        var result = await DialogService.OpenAsync<ReportDialog>($"Edit Report {report.Id}", 
            new Dictionary<string, object> { { "Report", report }, { "IsAdminMode", true } },
            new DialogOptions { Width = "500px", Resizable = true, Draggable = true });

        if (result == true)
        {
            _reportsGrid?.Reload();
            StateHasChanged();
        }
    }

    private async Task DeleteReport(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this report?", "Delete Report", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
        
        if (confirm == true)
        {
            try
            {
                await ReportService.DeleteReportAsync(id);
                NotificationService.Notify(NotificationSeverity.Success, "Report deleted");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete report {ReportId}", id);
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", ex.Message);
            }
        }
    }

    private async Task OpenOnMap(LocationReport report)
    {
        var url = $"/?reportId={report.ExternalId}";
        await JsRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    public void Dispose()
    {
        MapState.OnStateChanged -= HandleStateChanged;
    }
}
