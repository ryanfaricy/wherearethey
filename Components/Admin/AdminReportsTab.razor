@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@using WhereAreThey.Services
@inject IReportService ReportService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject UserTimeZoneService TimeZoneService
@inject IJSRuntime JsRuntime
@inject ILogger<AdminReportsTab> Logger
@inject IEventService EventService
@implements IDisposable

<RadzenDataGrid @ref="_reportsGrid" Data="@_reports" TItem="LocationReport" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true" Density="@(IsMobile ? Density.Compact : Density.Default)">
    <Columns>
        <RadzenDataGridColumn TItem="LocationReport" Property="Id" Title="ID" Visible="@(!IsMobile)" />
        <RadzenDataGridColumn TItem="LocationReport" Property="Timestamp" Title="Time">
            <Template Context="report">
                @TimeZoneService.FormatLocal(report.Timestamp)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="LocationReport" Property="Message" Title="Message" />
        <RadzenDataGridColumn TItem="LocationReport" Property="ReporterIdentifier" Title="Reporter Passphrase" Visible="@(!IsMobile)" />
        <RadzenDataGridColumn TItem="LocationReport" Title="Reporter Location" Visible="@(!IsMobile)">
            <Template Context="report">
                @report.Coordinates()
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="LocationReport" Property="IsEmergency" Title="Emergency">
            <Template Context="report">
                <RadzenBadge BadgeStyle="@(report.IsEmergency ? BadgeStyle.Danger : BadgeStyle.Secondary)" 
                             Text="@(report.IsEmergency ? "YES" : "NO")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="LocationReport" Title="Location" Visible="@(!IsMobile)">
            <Template Context="report">
                @report.Latitude.ToString("F4"), @report.Longitude.ToString("F4")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="LocationReport" Title="Actions" Filterable="false" Sortable="false">
            <Template Context="report">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                  Click="@(() => OpenOnMap(report))" ToolTip="Show on Map" />
                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                  Click="@(() => DeleteReport(report.Id))" />
                </RadzenStack>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    [Parameter] public bool IsMobile { get; set; }
    
    private List<LocationReport> _reports = new();
    private RadzenDataGrid<LocationReport>? _reportsGrid;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        EventService.OnReportAdded += HandleReportAdded;
        EventService.OnReportUpdated += HandleReportUpdated;
        EventService.OnReportDeleted += HandleReportDeleted;
    }

    private async Task LoadData()
    {
        try
        {
            _reports = await ReportService.GetAllReportsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading reports");
        }
    }

    private void HandleReportAdded(LocationReport report)
    {
        InvokeAsync(async () =>
        {
            _reports.Insert(0, report);
            if (_reportsGrid != null) await _reportsGrid.Reload();
            StateHasChanged();
        });
    }

    private void HandleReportUpdated(LocationReport report)
    {
        InvokeAsync(async () =>
        {
            var index = _reports.FindIndex(r => r.Id == report.Id);
            if (index != -1)
            {
                _reports[index] = report;
                if (_reportsGrid != null) await _reportsGrid.Reload();
                StateHasChanged();
            }
        });
    }

    private void HandleReportDeleted(int id)
    {
        InvokeAsync(async () =>
        {
            _reports.RemoveAll(r => r.Id == id);
            if (_reportsGrid != null) await _reportsGrid.Reload();
            StateHasChanged();
        });
    }

    private async Task DeleteReport(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this report?", "Delete Report", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
        
        if (confirm == true)
        {
            try
            {
                await ReportService.DeleteReportAsync(id);
                NotificationService.Notify(NotificationSeverity.Success, "Report deleted");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete report {ReportId}", id);
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", ex.Message);
            }
        }
    }

    private async Task OpenOnMap(LocationReport report)
    {
        var url = $"/?reportId={report.ExternalId}";
        await JsRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    public void Dispose()
    {
        EventService.OnReportAdded -= HandleReportAdded;
        EventService.OnReportUpdated -= HandleReportUpdated;
        EventService.OnReportDeleted -= HandleReportDeleted;
    }
}
