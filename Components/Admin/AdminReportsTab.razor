@inherits AdminTabBase<LocationReport>
@inject IReportService ReportService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject UserTimeZoneService TimeZoneService
@inject IJSRuntime JsRuntime
@inject IMapStateService MapState
@using WhereAreThey.Components.Pages
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces

@if (IsMobile)
{
    <RadzenDataList Data="@Items" TItem="LocationReport" AllowPaging="true" PageSize="10" WrapItems="true">
        <Template Context="report">
            <RadzenCard Class="@(report.IsEmergency ? "rz-mb-4 report-emergency" : "rz-mb-4 report-normal")">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">
                            @TimeZoneService.FormatLocal(report.Timestamp)
                        </RadzenText>
                        <RadzenBadge BadgeStyle="@(report.IsEmergency ? BadgeStyle.Danger : BadgeStyle.Secondary)" 
                                     Text="@(report.IsEmergency ? "EMERGENCY" : "NORMAL")" />
                        @if (report.DeletedAt != null)
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="DELETED" />
                        }
                    </RadzenStack>
                    
                    <RadzenText TextStyle="TextStyle.Body1">@report.Message</RadzenText>
                    
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption"><b>Reporter Location:</b> @report.ReporterLocationDisplay()</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption"><b>Incident Location:</b> @report.LocationDisplay()</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End" Class="rz-mt-2">
                        <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                      Click="@(() => OpenOnMap(report))" Text="MAP" />
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                      Click="@(() => EditReport(report))" Text="EDIT" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                      Click="@(() => DeleteReport(report.Id))" Text="DELETE" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </Template>
    </RadzenDataList>
}
else
{
    <RadzenDataGrid @ref="Grid" Data="@Items" TItem="LocationReport" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="LocationReport" Property="Id" Title="ID" />
            <RadzenDataGridColumn TItem="LocationReport" Property="Timestamp" Title="Time">
                <Template Context="report">
                    @TimeZoneService.FormatLocal(report.Timestamp)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="LocationReport" Property="Message" Title="Message" />
            <RadzenDataGridColumn TItem="LocationReport" Property="ReporterIdentifier" Title="Reporter Passphrase" />
            <RadzenDataGridColumn TItem="LocationReport" Title="Reporter Location">
                <Template Context="report">
                    @report.ReporterLocationDisplay()
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="LocationReport" Property="IsEmergency" Title="Emergency">
                <Template Context="report">
                    <RadzenBadge BadgeStyle="@(report.IsEmergency ? BadgeStyle.Danger : BadgeStyle.Secondary)" 
                                 Text="@(report.IsEmergency ? "YES" : "NO")" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="LocationReport" Property="DeletedAt" Title="Status">
                <Template Context="report">
                    @if (report.DeletedAt != null)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="DELETED" />
                    }
                    else
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="ACTIVE" />
                    }
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="LocationReport" Title="Location">
                <Template Context="report">
                    @report.LocationDisplay()
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="LocationReport" Title="Actions" Filterable="false" Sortable="false">
                <Template Context="report">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" 
                                      Click="@(() => OpenOnMap(report))" ToolTip="Show on Map" />
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                      Click="@(() => EditReport(report))" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" 
                                      Click="@(() => DeleteReport(report.Id))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await MapState.InitializeAsync(null, isAdmin: true);
        await MapState.LoadReportsAsync();
    }

    protected override Task<List<LocationReport>> GetEntitiesAsync() => ReportService.GetAllReportsAsync();

    private async Task EditReport(LocationReport report)
    {
        var result = await DialogService.OpenAsync<AdminEditReportDialog>($"Edit Report {report.Id}", 
            new Dictionary<string, object> { { "Report", report } },
            DialogConfigs.Admin);

        if (result == true)
        {
            Grid?.Reload();
            StateHasChanged();
        }
    }

    private async Task DeleteReport(int id)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this report?", "Delete Report", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
        
        if (confirm == true)
        {
            var result = await ReportService.DeleteReportAsync(id);
            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Report deleted");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed", result.Error ?? "Unknown error");
            }
        }
    }

    private async Task OpenOnMap(LocationReport report)
    {
        var url = $"/?reportId={report.ExternalId}";
        await JsRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }
}
