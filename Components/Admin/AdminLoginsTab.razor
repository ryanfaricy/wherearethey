@inherits LayoutComponentBase
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@inject IAdminService AdminService
@inject UserTimeZoneService TimeZoneService
@inject ILogger<AdminLoginsTab> Logger

@if (IsMobile)
{
    <RadzenDataList Data="@_loginAttempts" TItem="AdminLoginAttempt" AllowPaging="true" PageSize="10">
        <Template Context="attempt">
            <RadzenCard Class="@($"app-card {(attempt.IsSuccessful ? "app-card-success" : "app-card-danger")}")">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">
                            @TimeZoneService.FormatLocal(attempt.CreatedAt)
                        </RadzenText>
                        <RadzenBadge BadgeStyle="@(attempt.IsSuccessful ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                     Text="@(attempt.IsSuccessful ? "SUCCESS" : "FAILED")" />
                    </RadzenStack>
                    <RadzenText TextStyle="TextStyle.Caption"><b>IP Address:</b> @attempt.IpAddress</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </Template>
    </RadzenDataList>
}
else
{
    <RadzenDataGrid @ref="_allLoginAttemptsGrid" Data="@_loginAttempts" TItem="AdminLoginAttempt" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
        <Columns>
            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="CreatedAt" Title="Time">
                <Template Context="attempt">
                    @TimeZoneService.FormatLocal(attempt.CreatedAt)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="IpAddress" Title="IP Address" />
            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="IsSuccessful" Title="Status">
                <Template Context="attempt">
                    <RadzenBadge BadgeStyle="@(attempt.IsSuccessful ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                 Text="@(attempt.IsSuccessful ? "SUCCESS" : "FAILED")" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    private List<AdminLoginAttempt> _loginAttempts = [];
    private RadzenDataGrid<AdminLoginAttempt>? _allLoginAttemptsGrid;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            _loginAttempts = await AdminService.GetRecentLoginAttemptsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading login attempts");
        }
    }
}
