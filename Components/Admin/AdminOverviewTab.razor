@inherits LayoutComponentBase
@inject IReportService ReportService
@inject IAlertService AlertService
@inject IDonationService DonationService
@inject IFeedbackService FeedbackService
@inject IAdminService AdminService
@inject UserTimeZoneService TimeZoneService
@inject UserConnectionService UserConnectionService
@inject IEventService EventService
@inject ILogger<AdminOverviewTab> Logger
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@implements IDisposable

<RadzenRow>
    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard Class="rz-variant-flat rz-background-color-primary-lighter">
            <RadzenText TextStyle="TextStyle.Subtitle2">Connected Users</RadzenText>
            <RadzenText TextStyle="@(IsMobile ? TextStyle.H5 : TextStyle.H3)">@UserConnectionService.ConnectionCount</RadzenText>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard Class="rz-variant-flat rz-background-color-info-lighter">
            <RadzenText TextStyle="TextStyle.Subtitle2">Total Reports</RadzenText>
            <RadzenText TextStyle="@(IsMobile ? TextStyle.H5 : TextStyle.H3)">@_reportCount</RadzenText>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard Class="rz-variant-flat rz-background-color-warning-lighter">
            <RadzenText TextStyle="TextStyle.Subtitle2">Active Alerts</RadzenText>
            <RadzenText TextStyle="@(IsMobile ? TextStyle.H5 : TextStyle.H3)">@_activeAlertCount</RadzenText>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>
<RadzenRow Class="rz-mt-4">
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard Class="rz-variant-flat rz-background-color-success-lighter">
            <RadzenText TextStyle="TextStyle.Subtitle2">Total Donations</RadzenText>
            <RadzenText TextStyle="@(IsMobile ? TextStyle.H5 : TextStyle.H3)">@_donationCount</RadzenText>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard Class="rz-variant-flat rz-background-color-secondary-lighter">
            <RadzenText TextStyle="TextStyle.Subtitle2">Feedback Items</RadzenText>
            <RadzenText TextStyle="@(IsMobile ? TextStyle.H5 : TextStyle.H3)">@_feedbackCount</RadzenText>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenText TextStyle="TextStyle.H6" Class="rz-mt-4 rz-mb-2">Recent Login Attempts</RadzenText>
@if (IsMobile)
{
    <RadzenDataList Data="@_loginAttempts" TItem="AdminLoginAttempt">
        <Template Context="attempt">
            <RadzenCard Class="rz-mb-2">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-m-0">
                            @TimeZoneService.FormatLocal(attempt.Timestamp)
                        </RadzenText>
                        <RadzenBadge BadgeStyle="@(attempt.IsSuccessful ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                     Text="@(attempt.IsSuccessful ? "SUCCESS" : "FAILED")" />
                    </RadzenStack>
                    <RadzenText TextStyle="TextStyle.Caption"><b>IP Address:</b> @attempt.IpAddress</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </Template>
    </RadzenDataList>
}
else
{
    <RadzenDataGrid Data="@_loginAttempts" TItem="AdminLoginAttempt">
        <Columns>
            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="Timestamp" Title="Time">
                <Template Context="attempt">
                    @TimeZoneService.FormatLocal(attempt.Timestamp)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="IpAddress" Title="IP Address" />
            <RadzenDataGridColumn TItem="AdminLoginAttempt" Property="IsSuccessful" Title="Status">
                <Template Context="attempt">
                    <RadzenBadge BadgeStyle="@(attempt.IsSuccessful ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                 Text="@(attempt.IsSuccessful ? "SUCCESS" : "FAILED")" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    private int _reportCount;
    private int _activeAlertCount;
    private int _donationCount;
    private int _feedbackCount;
    private List<AdminLoginAttempt> _loginAttempts = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        EventService.OnConnectionCountChanged += HandleConnectionCountChanged;
        EventService.OnEntityChanged += HandleEntityChanged;
    }

    private void HandleEntityChanged(object entity, EntityChangeType type)
    {
        InvokeAsync(async () =>
        {
            if (type == EntityChangeType.Added)
            {
                if (entity is LocationReport)
                {
                    _reportCount++;
                }
                else if (entity is Alert)
                {
                    _activeAlertCount++;
                }
                else if (entity is Donation donation && donation.IsSuccess())
                {
                    _donationCount++;
                }
                else if (entity is Feedback)
                {
                    _feedbackCount++;
                }
            }
            else if (type == EntityChangeType.Deleted)
            {
                if (entity is LocationReport)
                {
                    _reportCount--;
                }
                else if (entity is Alert)
                {
                    _activeAlertCount--;
                }
                else if (entity is Donation)
                {
                    _donationCount--;
                }
                else if (entity is Feedback)
                {
                    _feedbackCount--;
                }
            }
            else if (type == EntityChangeType.Updated)
            {
                // For updates, it's safer to reload counts to handle status changes (e.g. donation success)
                await LoadData();
            }
            StateHasChanged();
        });
    }

    private async Task LoadData()
    {
        try
        {
            var reports = await ReportService.GetAllReportsAsync();
            _reportCount = reports.Count(r => r.DeletedAt == null);
            
            var alerts = await AlertService.GetAllAlertsAsync();
            _activeAlertCount = alerts.Count(a => a.DeletedAt == null);
            
            var donations = await DonationService.GetAllDonationsAsync();
            _donationCount = donations.Count(d => d.IsSuccess() && d.DeletedAt == null);
            
            var feedbacks = await FeedbackService.GetAllFeedbackAsync();
            _feedbackCount = feedbacks.Count(f => f.DeletedAt == null);
            
            var logins = await AdminService.GetRecentLoginAttemptsAsync();
            _loginAttempts = logins.Take(5).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading overview data");
        }
    }

    private void HandleConnectionCountChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        EventService.OnConnectionCountChanged -= HandleConnectionCountChanged;
        EventService.OnEntityChanged -= HandleEntityChanged;
    }
}
