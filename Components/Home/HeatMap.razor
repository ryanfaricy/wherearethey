@inject IMapService MapService
@inject IMapStateService MapState
@inject IStringLocalizer<App> L
@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@implements IAsyncDisposable

<div id="@ElementId" style="height: 100%; width: 100%;" @attributes="AdditionalAttributes"></div>

@code {
    [Parameter] public string ElementId { get; set; } = "heatmap";
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object>? AdditionalAttributes { get; set; }
    [Parameter] public List<Report> Reports { get; set; } = [];
    [Parameter] public List<Alert>? Alerts { get; set; }
    [Parameter] public double InitialLat { get; set; }
    [Parameter] public double InitialLng { get; set; }
    [Parameter] public bool IsAdmin { get; set; }
    [Parameter] public bool AlertCreationMode { get; set; }

    [Parameter] public EventCallback<MapClickEventArgs> OnMapClick { get; set; }
    [Parameter] public EventCallback<MapLocationEventArgs> OnMapMoveEnd { get; set; }
    [Parameter] public EventCallback OnUserInteractedWithMap { get; set; }
    [Parameter] public EventCallback<GeolocationPosition> OnLocationUpdated { get; set; }
    [Parameter] public EventCallback<MapLocationEventArgs> OnMapContextMenu { get; set; }
    [Parameter] public EventCallback<int> OnAlertDeleteClick { get; set; }
    [Parameter] public EventCallback<AlertAreaEventArgs> OnAlertAreaDefined { get; set; }

    private DotNetObjectReference<HeatMap>? _objRef;
    private bool _initialized;
    private bool _lastAlertCreationMode;

    public async Task InitializeAsync(double lat, double lng)
    {
        if (_initialized)
        {
            return;
        }

        InitialLat = lat;
        InitialLng = lng;
        await InitializeInternal();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_initialized && _lastAlertCreationMode != AlertCreationMode)
        {
            _lastAlertCreationMode = AlertCreationMode;
            await MapService.SetAlertCreationModeAsync(AlertCreationMode);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && InitialLat != 0 && InitialLng != 0 && !_initialized)
        {
            await InitializeInternal();
        }
    }

    private async Task InitializeInternal()
    {
        if (_initialized)
        {
            return;
        }

        _objRef = DotNetObjectReference.Create(this);
        
        var jsTranslations = new
        {
            Items_at_location = L["Items_at_location"].Value,
            EMERGENCY_REPORT = L["EMERGENCY_REPORT"].Value,
            Report = L["Report"].Value,
            Alert_Zone = L["Alert_Zone"].Value,
            Radius = L["Radius"].Value,
            DELETE = L["DELETE"].Value,
        };

        // Ensure we use the latest reports and alerts from state, as the Parameters might be stale
        // during the first render after LoadReportsAsync/LoadAlertsAsync.
        var initialReports = (Reports == null || Reports.Count == 0) ? MapState.Reports : Reports;
        var initialAlerts = (Alerts == null || Alerts.Count == 0) ? MapState.Alerts : Alerts;

        await MapService.InitMapAsync(ElementId, InitialLat, InitialLng, initialReports, _objRef, initialAlerts, jsTranslations, IsAdmin);
        _initialized = true;
        MapState.MapInitialized = true;
    }

    [JSInvokable("OnMapClick")]
    public async Task OnMapClickInternal(double lat, double lng, bool isMarkerClick, int? reportId = null, int? alertId = null)
    {
        if (OnMapClick.HasDelegate)
        {
            await OnMapClick.InvokeAsync(new MapClickEventArgs 
            { 
                Lat = lat, 
                Lng = lng, 
                IsMarkerClick = isMarkerClick,
                ReportId = reportId,
                AlertId = alertId,
            });
        }
    }

    [JSInvokable("OnMapMoveEnd")]
    public async Task OnMapMoveEndInternal(double lat, double lng)
    {
        if (OnMapMoveEnd.HasDelegate)
        {
            await OnMapMoveEnd.InvokeAsync(new MapLocationEventArgs { Lat = lat, Lng = lng });
        }
    }

    [JSInvokable("OnUserInteractedWithMap")]
    public async Task OnUserInteractedWithMapInternal()
    {
        if (OnUserInteractedWithMap.HasDelegate)
        {
            await OnUserInteractedWithMap.InvokeAsync();
        }
    }

    [JSInvokable("OnLocationUpdated")]
    public async Task OnLocationUpdatedInternal(GeolocationPosition position)
    {
        if (OnLocationUpdated.HasDelegate)
        {
            await OnLocationUpdated.InvokeAsync(position);
        }
    }

    [JSInvokable("OnMapContextMenu")]
    public async Task OnMapContextMenuInternal(double lat, double lng)
    {
        if (OnMapContextMenu.HasDelegate)
        {
            await OnMapContextMenu.InvokeAsync(new MapLocationEventArgs { Lat = lat, Lng = lng });
        }
    }

    [JSInvokable("OnAlertDeleteClick")]
    public async Task OnAlertDeleteClickInternal(int alertId)
    {
        if (OnAlertDeleteClick.HasDelegate)
        {
            await OnAlertDeleteClick.InvokeAsync(alertId);
        }
    }

    [JSInvokable("OnAlertAreaDefined")]
    public async Task OnAlertAreaDefinedInternal(double lat, double lng, double radiusKm)
    {
        if (OnAlertAreaDefined.HasDelegate)
        {
            await OnAlertAreaDefined.InvokeAsync(new AlertAreaEventArgs { Lat = lat, Lng = lng, RadiusKm = radiusKm });
        }
    }

    public DotNetObjectReference<HeatMap>? GetDotNetObjectReference() => _objRef;

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_initialized)
            {
                await MapService.DestroyMapAsync();
            }
        }
        catch (Exception ex)
        {
            // Best effort cleanup - avoid logging if it's just a JS interop failure during disposal
            if (ex is not InvalidOperationException && ex is not JSDisconnectedException)
            {
                Console.WriteLine($"[DEBUG_LOG] Error in HeatMap.DisposeAsync: {ex.Message}");
            }
        }
        finally
        {
            _objRef?.Dispose();
            MapState.MapInitialized = false;
        }
    }

    public class MapClickEventArgs
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
        public bool IsMarkerClick { get; set; }
        public int? ReportId { get; set; }
        public int? AlertId { get; set; }
    }

    public class MapLocationEventArgs
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
    }

    public class AlertAreaEventArgs
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
        public double RadiusKm { get; set; }
    }
}
