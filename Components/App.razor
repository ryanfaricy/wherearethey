@using System.Globalization
@using Microsoft.Extensions.Options
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IOptions<AppOptions> AppOptions
@inject IOptions<SquareOptions> SquareOptions
@inject IBaseUrlProvider BaseUrlProvider
<!DOCTYPE html>
<html lang="@CultureInfo.CurrentCulture.TwoLetterISOLanguageName">

<head>
    <title>AreTheyHere</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="description" content="Live anonymous incident reporting and heat map."/>
    <base href="/"/>
    <ResourcePreloader/>
    <script>
        // Pre-render theme detection to prevent flicker
        (function() {
            const stored = localStorage.getItem('app-theme');
            let actualTheme = 'light';
            if (!stored || stored === 'System' || stored === '2') {
                actualTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            } else if (stored === 'Dark' || stored === '1') {
                actualTheme = 'dark';
            }
            document.documentElement.setAttribute('data-theme', actualTheme);
            
            // Apply immediate background color to avoid white flash
            const style = document.createElement('style');
            style.id = 'theme-immediate-style';
            style.textContent = actualTheme === 'dark' 
                ? 'html, body { background-color: #121212 !important; color: white !important; }' 
                : 'html, body { background-color: #ffffff !important; color: black !important; }';
            document.head.appendChild(style);
        })();
    </script>
    <style>
        /* Critical styles for the loading spinner to prevent black/white flash on slow connections */
        .app-loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #fff;
            z-index: 9999;
            transition: opacity 0.3s ease-out, visibility 0.3s;
        }

        [data-theme="dark"] .app-loading-container {
            background-color: #121212;
            color: white;
        }

        .app-loading-container.loaded {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #f44336;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .loading-text {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-weight: bold;
            color: #f44336;
            font-size: 1.2rem;
        }

        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="stylesheet" href="@Assets["lib/bootstrap/dist/css/bootstrap.min.css"]" media="print" onload="this.media='all'"/>
    <link rel="stylesheet" href="@Assets["app.css"]" media="print" onload="this.media='all'"/>
    <link rel="stylesheet" href="@Assets["WhereAreThey.styles.css"]" media="print" onload="this.media='all'"/>
    @* ReSharper disable Html.PathError *@
    <link id="radzen-base-theme" rel="stylesheet" href="_content/Radzen.Blazor/css/material-base.css" media="print" onload="this.media='all'">
    <link id="radzen-theme" rel="stylesheet" href="_content/Radzen.Blazor/css/material.css" media="print" onload="this.media='all'">
    @* ReSharper disable once Html.AttributeValueNotResolved *@
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" media="print" onload="this.media='all'"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" media="print" onload="this.media='all'"/>
    @* ReSharper restore Html.PathError *@
    <script src="theme.js"></script>
    <script src="time-utils.js"></script>
    <script>
        // Secondary theme application for Radzen links
        (function() {
            const theme = document.documentElement.getAttribute('data-theme');
            if (theme === 'dark') {
                const baseTheme = document.getElementById('radzen-base-theme');
                const themeLink = document.getElementById('radzen-theme');
                if (baseTheme) baseTheme.href = '_content/Radzen.Blazor/css/material-dark-base.css';
                if (themeLink) themeLink.href = '_content/Radzen.Blazor/css/material-dark.css';
            }
        })();
    </script>
    <ImportMap/>
    <link rel="icon" type="image/png" href="favicon.png"/>
    <link rel="manifest" href="manifest.json"/>
    <meta name="theme-color" content="#f44336"/>
    <link rel="apple-touch-icon" href="favicon.png"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AreTheyHere">

    <!-- Social Media Meta Tags -->
    <meta property="og:title" content="AreTheyHere - Live Heat Map"/>
    <meta property="og:description" content="Live anonymous incident reporting and heat map."/>
    <meta property="og:image" content="@($"{BaseUrlProvider.GetBaseUrl()}/favicon.png")"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="@BaseUrlProvider.GetBaseUrl()"/>

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="AreTheyHere - Live Heat Map"/>
    <meta name="twitter:description" content="Live anonymous incident reporting and heat map."/>
    <meta name="twitter:image" content="@($"{BaseUrlProvider.GetBaseUrl()}/favicon.png")"/>

    <HeadOutlet @rendermode="InteractiveServer"/>
</head>

<body>
    <div id="app-loader" class="app-loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">AreTheyHere</div>
    </div>
    <Routes @rendermode="InteractiveServer" />
    <ReconnectModal />
    <script src="@Assets["_framework/blazor.web.js"]"></script>
    @* ReSharper disable Html.PathError *@
    <script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>
    @* ReSharper disable once Html.AttributeValueNotResolved *@
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    @* ReSharper restore Html.PathError *@
    <script src="utils.js"></script>
    <script src="geolocation.js"></script>
    <script src="heatmap.js"></script>
    <script src="pwa-utils.js"></script>
    <script src="haptics.js"></script>
    <script src="square-payments.js"></script>
    <script src="@(SquareOptions.Value.Environment == "Production" ? "https://web.squarecdn.com/v1/square.js" : "https://sandbox.web.squarecdn.com/v1/square.js")"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }

        window.hideAppLoader = function() {
            var loader = document.getElementById('app-loader');
            if (loader) {
                loader.classList.add('loaded');
                setTimeout(function() {
                    loader.style.display = 'none';
                }, 300);
            }
        };
    </script>
</body>

</html>
