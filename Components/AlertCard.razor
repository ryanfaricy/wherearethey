@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IAlertService AlertService
@inject IStringLocalizer<App> L

<RadzenCard @attributes="CardAttributes">
    <RadzenStack Orientation="@(IsMobile ? Orientation.Vertical : Orientation.Horizontal)" 
                 JustifyContent="JustifyContent.SpaceBetween" 
                 AlignItems="@(IsMobile ? AlignItems.Start : AlignItems.Center)" 
                 Gap="@(IsMobile ? "1rem" : "0.5rem")">
        <RadzenStack Gap="0" Style="flex: 1;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin-bottom: 0;">@(string.IsNullOrEmpty(Alert.Message) ? L["Unnamed_Alert_Zone"] : Alert.Message)</RadzenText>
                @if (!Alert.IsVerified)
                {
                    <RadzenBadge Text="@L["Pending_Verification"]" BadgeStyle="BadgeStyle.Warning" IsPill="true" />
                }
                @if (IsAdmin && Alert.DeletedAt != null)
                {
                    <RadzenBadge Text="DELETED" BadgeStyle="BadgeStyle.Secondary" IsPill="true" />
                }
                @if (Alert.UseEmail)
                {
                    <RadzenBadge Text="EMAIL" BadgeStyle="BadgeStyle.Info" IsPill="true" />
                }
                @if (Alert.UsePush)
                {
                    <RadzenBadge Text="PUSH" BadgeStyle="BadgeStyle.Info" IsPill="true" />
                }
            </RadzenStack>
            <RadzenText TextStyle="TextStyle.Caption">@Alert.RadiusKm km around @Alert.LocationDisplay()</RadzenText>
            @if (IsAdmin)
            {
                <RadzenText TextStyle="TextStyle.Caption" Style="font-family: monospace; font-weight: bold;">ID: @Alert.UserIdentifier</RadzenText>
            }
            else
            {
                <RadzenText TextStyle="TextStyle.Caption">@MaskEmail(AlertService.DecryptEmail(Alert.EncryptedEmail))</RadzenText>
            }
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" 
                     JustifyContent="@(IsMobile ? JustifyContent.End : JustifyContent.Start)" 
                     Class="@(IsMobile ? "rz-w-100" : "")">
            @if (OnEdit.HasDelegate)
            {
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Variant="Variant.Flat"
                              Click="@OnEdit" ToolTip="@L["EDIT"]" />
            }
            @if (OnShowOnMap.HasDelegate)
            {
                <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Variant="Variant.Flat"
                              Click="@OnShowOnMap" ToolTip="@L["Show_on_Map"]" />
            }
            @if (OnDeactivate.HasDelegate)
            {
                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Variant="Variant.Flat"
                              Click="@OnDeactivate" ToolTip="@(IsAdmin ? L["DELETE"] : L["Deactivate"])" />
            }
        </RadzenStack>
    </RadzenStack>
</RadzenCard>

@code {
    /// <summary>
    /// The alert configuration to display.
    /// </summary>
    [Parameter] public Alert Alert { get; set; } = null!;

    /// <summary>
    /// Gets or sets whether this card is currently selected.
    /// </summary>
    [Parameter] public bool IsSelected { get; set; }

    /// <summary>
    /// Gets or sets whether the component is being rendered for a mobile device.
    /// </summary>
    [Parameter] public bool IsMobile { get; set; }

    /// <summary>
    /// Gets or sets whether the current user has administrative privileges.
    /// </summary>
    [Parameter] public bool IsAdmin { get; set; }

    /// <summary>
    /// Whether to show an orange border on the left side of the card.
    /// </summary>
    [Parameter] public bool ShowOrangeBorder { get; set; } = true;

    /// <summary>
    /// Event raised when the "Show on Map" button is clicked.
    /// </summary>
    [Parameter] public EventCallback OnShowOnMap { get; set; }

    /// <summary>
    /// Event raised when the deactivate button is clicked.
    /// </summary>
    [Parameter] public EventCallback OnDeactivate { get; set; }

    /// <summary>
    /// Event raised when the edit button is clicked.
    /// </summary>
    [Parameter] public EventCallback OnEdit { get; set; }

    private Dictionary<string, object> CardAttributes
    {
        get
        {
            var attrs = new Dictionary<string, object>();
            var classes = new List<string> { "app-card" };
            
            if (ShowOrangeBorder)
            {
                classes.Add("app-card-warning");
            }

            if (IsSelected)
            {
                attrs["id"] = "selected-alert-card";
                classes.Add("app-card-selected");
            }

            if (classes.Any())
            {
                attrs["class"] = string.Join(" ", classes);
            }

            return attrs;
        }
    }

    private static string MaskEmail(string? email)
    {
        if (string.IsNullOrEmpty(email))
        {
            return "****";
        }

        var parts = email.Split('@');
        if (parts.Length != 2)
        {
            return "****";
        }

        var name = parts[0];
        var domain = parts[1];
        if (name.Length <= 2)
        {
            return $"**@{domain}";
        }

        return $"{name[0]}***{name[^1]}@{domain}";
    }
}
