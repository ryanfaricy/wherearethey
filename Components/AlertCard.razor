@using Microsoft.Extensions.Localization
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@inject IAlertService AlertService
@inject IStringLocalizer<App> L

<RadzenCard @attributes="CardAttributes">
    <RadzenStack Orientation="@(IsMobile ? Orientation.Vertical : Orientation.Horizontal)" 
                 JustifyContent="JustifyContent.SpaceBetween" 
                 AlignItems="@(IsMobile ? AlignItems.Start : AlignItems.Center)" 
                 Gap="@(IsMobile ? "1rem" : "0.5rem")">
        <RadzenStack Gap="0" Style="flex: 1;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin-bottom: 0;">@(string.IsNullOrEmpty(Alert.Message) ? L["Unnamed_Alert_Zone"] : Alert.Message)</RadzenText>
                @if (!Alert.IsVerified)
                {
                    <RadzenBadge Text="@L["Pending_Verification"]" BadgeStyle="BadgeStyle.Warning" IsPill="true" />
                }
                @if (IsAdmin && Alert.DeletedAt != null)
                {
                    <RadzenBadge Text="DELETED" BadgeStyle="BadgeStyle.Secondary" IsPill="true" />
                }
            </RadzenStack>
            <RadzenText TextStyle="TextStyle.Caption">@Alert.RadiusKm km around @Alert.LocationDisplay()</RadzenText>
            @if (IsAdmin)
            {
                <RadzenText TextStyle="TextStyle.Caption" Style="font-family: monospace; font-weight: bold;">ID: @Alert.UserIdentifier</RadzenText>
            }
            else
            {
                <RadzenText TextStyle="TextStyle.Caption">@MaskEmail(AlertService.DecryptEmail(Alert.EncryptedEmail))</RadzenText>
            }
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" 
                     JustifyContent="@(IsMobile ? JustifyContent.End : JustifyContent.Start)" 
                     Class="@(IsMobile ? "rz-w-100" : "")">
            @if (IsAdmin && OnEdit.HasDelegate)
            {
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Variant="Variant.Flat"
                              Click="@OnEdit" ToolTip="@L["EDIT"]" />
            }
            @if (OnShowOnMap.HasDelegate)
            {
                <RadzenButton Icon="travel_explore" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Variant="Variant.Flat"
                              Click="@OnShowOnMap" ToolTip="@L["Show_on_Map"]" />
            }
            @if (OnDeactivate.HasDelegate)
            {
                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Variant="Variant.Flat"
                              Click="@OnDeactivate" ToolTip="@(IsAdmin ? L["DELETE"] : L["Deactivate"])" />
            }
        </RadzenStack>
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter] public Alert Alert { get; set; } = null!;
    [Parameter] public bool IsSelected { get; set; }
    [Parameter] public bool IsMobile { get; set; }
    [Parameter] public bool IsAdmin { get; set; }
    [Parameter] public bool ShowOrangeBorder { get; set; } = true;
    [Parameter] public EventCallback OnShowOnMap { get; set; }
    [Parameter] public EventCallback OnDeactivate { get; set; }
    [Parameter] public EventCallback OnEdit { get; set; }

    private Dictionary<string, object> CardAttributes
    {
        get
        {
            var attrs = new Dictionary<string, object>();
            var classes = new List<string> { "rz-p-2", "rz-mb-1" };
            var styles = new List<string>();

            if (ShowOrangeBorder)
            {
                styles.Add("border-left: 4px solid #ff9800;");
            }

            if (IsSelected)
            {
                attrs["id"] = "selected-alert-card";
                classes.Add("rz-border-primary rz-shadow-5");
                styles.Add("border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px;");
            }

            if (classes.Any())
            {
                attrs["class"] = string.Join(" ", classes);
            }

            if (styles.Any())
            {
                attrs["style"] = string.Join(" ", styles);
            }

            return attrs;
        }
    }

    private static string MaskEmail(string? email)
    {
        if (string.IsNullOrEmpty(email))
        {
            return "****";
        }

        var parts = email.Split('@');
        if (parts.Length != 2)
        {
            return "****";
        }

        var name = parts[0];
        var domain = parts[1];
        if (name.Length <= 2)
        {
            return $"**@{domain}";
        }

        return $"{name[0]}***{name[^1]}@{domain}";
    }
}
