@using System.Globalization
@using WhereAreThey.Components.Pages
@using WhereAreThey.Models
@using WhereAreThey.Services
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject IJSRuntime JSRuntime
@inject LocationService LocationService

<RadzenPanelMenu Style="height: 100%">
    <RadzenPanelMenuItem Text="ARE THEY HERE?" Icon="visibility" Path="/" />
    <RadzenPanelMenuItem Text="THEY ARE HERE!" Icon="report_problem" Click="@OnReportClick" />
    <RadzenPanelMenuItem Text="Alerts" Icon="notifications" Click="@OnAlertsClick" />
    <RadzenPanelMenuItem Text="Donate" Icon="volunteer_activism" Click="@OnDonateClick" />
</RadzenPanelMenu>

@code {
    private async Task OnReportClick()
    {
        try
        {
            var position = await JSRuntime.InvokeAsync<GeolocationPosition>("getLocation");
            var report = new LocationReport
            {
                Latitude = position.Coords.Latitude,
                Longitude = position.Coords.Longitude
            };
            
            await DialogService.OpenAsync<ReportDialog>("REPORT LOCATION",
                new Dictionary<string, object> { { "report", report } },
                new DialogOptions { Width = "350px" });
        }
        catch (Exception)
        {
            // If location fails, still open dialog but with empty coordinates
            await DialogService.OpenAsync<ReportDialog>("REPORT LOCATION",
                new Dictionary<string, object> { { "report", new LocationReport() } },
                new DialogOptions { Width = "350px" });
        }
    }

    private async Task OnAlertsClick()
    {
        var parameters = new Dictionary<string, object>();
        try
        {
            var mapState = await JSRuntime.InvokeAsync<MapState>("getMapState");
            if (mapState != null)
            {
                parameters.Add("InitialLat", mapState.Lat);
                parameters.Add("InitialLng", mapState.Lng);
                parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
            }
        }
        catch (Exception)
        {
            // Ignore if map state cannot be retrieved
        }

        var result = await DialogService.OpenAsync<AlertsDialog>("ALERTS", parameters, new DialogOptions { Width = "350px" });

        if (result is Alert alert)
        {
            NavigationManager.NavigateTo($"/?lat={alert.Latitude.ToString(CultureInfo.InvariantCulture)}&lng={alert.Longitude.ToString(CultureInfo.InvariantCulture)}&radius={alert.RadiusKm.ToString(CultureInfo.InvariantCulture)}", forceLoad: true);
        }
    }

    private async Task OnDonateClick()
    {
        await DialogService.OpenAsync<DonateDialog>("DONATE", null, new DialogOptions { Width = "350px" });
    }

    public class GeolocationPosition
    {
        public GeolocationCoordinates Coords { get; set; } = new();
    }

    public class GeolocationCoordinates
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }
}
