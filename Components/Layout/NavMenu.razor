@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject IMapService MapService
@inject IClientStorageService StorageService
@inject ISettingsService SettingsService
@inject IAdminService AdminService
@inject IReportService ReportService
@inject IClientLocationService ClientLocation
@inject IEventService EventService
@inject ProtectedLocalStorage LocalStorage
@inject IStringLocalizer<App> L
@inject IMapStateService MapState
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.Extensions.Localization
@using WhereAreThey.Components.Pages
@using WhereAreThey.Models
@using WhereAreThey.Services
@using WhereAreThey.Services.Interfaces
@using System.Linq
@implements IDisposable

<RadzenStack Orientation="Orientation.Vertical" Gap="0" Style="height: 100%">
    <RadzenPanelMenu Style="flex: 0 0 auto;">
        <RadzenPanelMenuItem Text="@L["ARE THEY HERE?"]" Icon="visibility" Path="/" Click="@OnMenuItemClicked" />
        <RadzenPanelMenuItem Text="@L["THEY ARE HERE!"]" Icon="report_problem" Click="@OnReportClick" />
        <RadzenPanelMenuItem Text="@L["Alerts"]" Icon="notifications" Click="@OnAlertsClick" />
        @if (_systemSettings.DonationsEnabled)
        {
            <RadzenPanelMenuItem Text="@L["Donate"]" Icon="volunteer_activism" Click="@OnDonateClick" />
        }
        @if (_showAdminShortcut)
        {
            <RadzenPanelMenuItem Text="@L["CONTROL_PANEL"]" Icon="admin_panel_settings" Path="/cp" Click="@OnMenuItemClicked" />
        }
    </RadzenPanelMenu>

    <RadzenStack Gap="0.5rem" Class="rz-p-4" Style="flex: 1 1 auto; overflow-y: auto;">
        <RadzenText TextStyle="TextStyle.Subtitle2" Text="@L["RECENT_REPORTS"]" Style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;" />
        @if (_recentReports.Any())
        {
            @foreach (var report in _recentReports)
            {
                <ReportCard Report="@report" OnClick="@(() => OnReportCardClick(report))" MaxMessageLength="100" />
            }
        }
        else
        {
            <RadzenText TextStyle="TextStyle.Body2" Class="opacity-75 rz-p-2">@L["No_recent_reports"]</RadzenText>
        }
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public EventCallback OnMenuItemClick { get; set; }
    private string? _userIdentifier;
    private SystemSettings _systemSettings = new();
    private bool _showAdminShortcut;
    private bool _isAdmin;
    private List<Report> _recentReports = [];

    protected override async Task OnInitializedAsync()
    {
        _systemSettings = await SettingsService.GetSettingsAsync();
        AdminService.OnAdminLogin += HandleAdminLogin;
        AdminService.OnAdminLogout += HandleAdminLogout;
        MapState.OnStateChanged += HandleMapStateChanged;
        ClientLocation.OnStateChanged += HandleLocationChanged;
    }

    private void HandleAdminLogin()
    {
        _showAdminShortcut = true;
        InvokeAsync(async () =>
        {
            _isAdmin = await AdminService.IsAdminAsync();
            await MapState.InitializeAsync(_userIdentifier, _isAdmin);
            await MapState.LoadReportsAsync();
            StateHasChanged();
        });
    }

    private void HandleAdminLogout()
    {
        _showAdminShortcut = false;
        InvokeAsync(async () =>
        {
            _isAdmin = await AdminService.IsAdminAsync();
            await MapState.InitializeAsync(_userIdentifier, _isAdmin);
            await MapState.LoadReportsAsync();
            StateHasChanged();
        });
    }

    private void HandleMapStateChanged()
    {
        InvokeAsync(() =>
        {
            UpdateRecentReports();
        });
    }

    private void HandleLocationChanged()
    {
        InvokeAsync(() =>
        {
            SortReports();
            StateHasChanged();
        });
    }

    private void UpdateRecentReports()
    {
        _recentReports = MapState.Reports.Take(20).ToList();
        SortReports();
        StateHasChanged();
    }

    private void SortReports()
    {
        var location = ClientLocation.LastKnownPosition;
        if (location != null)
        {
            _recentReports = _recentReports
                .OrderBy(r => GeoUtils.CalculateDistance(location.Coords.Latitude, location.Coords.Longitude, r.Latitude, r.Longitude))
                .ToList();
        }
    }

    private async Task OnReportCardClick(Report report)
    {
        await OnMenuItemClicked();
        NavigationManager.NavigateTo($"/?reportId={report.ExternalId}");
    }

    public void Dispose()
    {
        AdminService.OnAdminLogin -= HandleAdminLogin;
        AdminService.OnAdminLogout -= HandleAdminLogout;
        MapState.OnStateChanged -= HandleMapStateChanged;
        ClientLocation.OnStateChanged -= HandleLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _userIdentifier = await StorageService.GetUserIdentifierAsync();

            _isAdmin = await AdminService.IsAdminAsync();
            await MapState.InitializeAsync(_userIdentifier, _isAdmin);
            await MapState.LoadReportsAsync();
            UpdateRecentReports();

            try
            {
                var result = await LocalStorage.GetAsync<DateTime>("lastAdminLogin");
                var isValidLogin = result is { Success: true } && (DateTime.UtcNow - result.Value).TotalDays <= 7;
                
                if (isValidLogin)
                {
                    _showAdminShortcut = true;
                    StateHasChanged();
                }
            }
            catch (Exception)
            {
                // Storage may not be available or entry may be invalid
            }
        }
    }

    private async Task OnMenuItemClicked()
    {
        await OnMenuItemClick.InvokeAsync();
    }

    private async Task OnReportClick()
    {
        await OnMenuItemClicked();
        // Start location acquisition in background
        var locationTask = StorageService.GetLocationAsync();

        // Initial placeholder from map if possible
        double initialLat = 0, initialLng = 0;
        try
        {
            var mapState = await MapService.GetMapStateAsync();
            if (mapState != null)
            {
                initialLat = mapState.Lat;
                initialLng = mapState.Lng;
            }
        }
        catch { /* Map might not be available yet */ }

        var report = new Report
        {
            Latitude = initialLat,
            Longitude = initialLng,
            ReporterIdentifier = _userIdentifier,
            ReporterLatitude = initialLat,
            ReporterLongitude = initialLng,
        };

        await DialogService.OpenAsync<ReportDialog>(L["REPORT_LOCATION"],
            new Dictionary<string, object> 
            { 
                { "Report", report },
                { "LocationTask", locationTask },
            },
            DialogConfigs.Default);
    }

    private async Task OnAlertsClick()
    {
        await OnMenuItemClicked();
        var parameters = new Dictionary<string, object>();
        try
        {
            var mapState = await MapService.GetMapStateAsync();
            if (mapState != null)
            {
                parameters.Add("InitialLat", mapState.Lat);
                parameters.Add("InitialLng", mapState.Lng);
                parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
            }
        }
        catch (Exception)
        {
            // Ignore if map state cannot be retrieved
        }

        var result = await DialogService.OpenAsync<AlertsDialog>(L["ALERTS"], parameters, 
            DialogConfigs.Default);

        if (result is Alert alert)
        {
            NavigationManager.NavigateTo($"/?alertId={alert.ExternalId}", forceLoad: true);
        }
    }

    private async Task OnDonateClick()
    {
        await OnMenuItemClicked();
        await DialogService.OpenAsync<DonateDialog>(L["DONATE"], null, 
            DialogConfigs.Default);
    }
}
