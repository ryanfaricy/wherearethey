@using Microsoft.Extensions.Localization
@using WhereAreThey.Components.Pages
@using WhereAreThey.Models
@using WhereAreThey.Services.Interfaces
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject IJSRuntime JsRuntime
@inject ISettingsService SettingsService
@inject IAdminService AdminService
@inject ProtectedLocalStorage LocalStorage
@inject IStringLocalizer<App> L
@implements IDisposable

<RadzenPanelMenu Style="height: 100%">
    <RadzenPanelMenuItem Text="@L["ARE THEY HERE?"]" Icon="visibility" Path="/" />
    <RadzenPanelMenuItem Text="@L["THEY ARE HERE!"]" Icon="report_problem" Click="@OnReportClick" />
    <RadzenPanelMenuItem Text="@L["Alerts"]" Icon="notifications" Click="@OnAlertsClick" />
    @if (_systemSettings.DonationsEnabled)
    {
        <RadzenPanelMenuItem Text="@L["Donate"]" Icon="volunteer_activism" Click="@OnDonateClick" />
    }
    @if (_showAdminShortcut)
    {
        <RadzenPanelMenuItem Text="@L["CONTROL_PANEL"]" Icon="admin_panel_settings" Path="/cp" />
    }
</RadzenPanelMenu>

@code {
    private string? _userIdentifier;
    private SystemSettings _systemSettings = new();
    private bool _showAdminShortcut;

    protected override async Task OnInitializedAsync()
    {
        _systemSettings = await SettingsService.GetSettingsAsync();
        AdminService.OnAdminLogin += HandleAdminLogin;
    }

    private void HandleAdminLogin()
    {
        _showAdminShortcut = true;
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _userIdentifier = await JsRuntime.InvokeAsync<string>("getUserIdentifier");

            try
            {
                var result = await LocalStorage.GetAsync<DateTime>("lastAdminLogin");
                if (result.Success)
                {
                    if ((DateTime.UtcNow - result.Value).TotalDays <= 7)
                    {
                        _showAdminShortcut = true;
                        StateHasChanged();
                    }
                }
            }
            catch (Exception)
            {
                // Storage may not be available or entry may be invalid
            }
        }
    }

    private async Task OnReportClick()
    {
        // Start location acquisition in background
        var locationTask = JsRuntime.InvokeAsync<GeolocationPosition>("getLocation").AsTask();

        // Initial placeholder from map if possible
        double initialLat = 0, initialLng = 0;
        try
        {
            var mapState = await JsRuntime.InvokeAsync<MapState?>("getMapState");
            if (mapState != null)
            {
                initialLat = mapState.Lat;
                initialLng = mapState.Lng;
            }
        }
        catch { /* Map might not be available yet */ }

        var report = new LocationReport
        {
            Latitude = initialLat,
            Longitude = initialLng,
            ReporterIdentifier = _userIdentifier,
            ReporterLatitude = initialLat,
            ReporterLongitude = initialLng
        };

        async Task<Home.GeolocationPosition?> GetTransformedLocation()
        {
            try
            {
                var p = await locationTask;
                return new Home.GeolocationPosition
                {
                    Coords = new Home.GeolocationCoordinates
                    {
                        Latitude = p.Coords.Latitude,
                        Longitude = p.Coords.Longitude,
                        Accuracy = p.Coords.Accuracy
                    }
                };
            }
            catch { return null; }
        }

        await DialogService.OpenAsync<ReportDialog>(L["REPORT_LOCATION"],
            new Dictionary<string, object> 
            { 
                { "Report", report },
                { "LocationTask", GetTransformedLocation() }
            },
            DialogConfigs.Default);
    }

    private async Task OnAlertsClick()
    {
        var parameters = new Dictionary<string, object>();
        try
        {
            var mapState = await JsRuntime.InvokeAsync<MapState?>("getMapState");
            if (mapState != null)
            {
                parameters.Add("InitialLat", mapState.Lat);
                parameters.Add("InitialLng", mapState.Lng);
                parameters.Add("InitialRadius", Math.Round(mapState.RadiusKm, 1));
            }
        }
        catch (Exception)
        {
            // Ignore if map state cannot be retrieved
        }

        var result = await DialogService.OpenAsync<AlertsDialog>(L["ALERTS"], parameters, 
            DialogConfigs.Default);

        if (result is Alert alert)
        {
            NavigationManager.NavigateTo($"/?alertId={alert.ExternalId}", forceLoad: true);
        }
    }

    private async Task OnDonateClick()
    {
        await DialogService.OpenAsync<DonateDialog>(L["DONATE"], null, 
            DialogConfigs.Default);
    }

    public void Dispose()
    {
        AdminService.OnAdminLogin -= HandleAdminLogin;
    }

    public class GeolocationPosition
    {
        public GeolocationCoordinates Coords { get; set; } = new();
    }

    public class GeolocationCoordinates
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public double Accuracy { get; set; }
    }
}
